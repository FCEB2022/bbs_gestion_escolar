{% extends "base.html" %}
{% block title %}Detalle de Pago — {{ pago.id }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Pago #{{ pago.id }}</h5>
      <small class="text-muted">{{ pago.estado or '' }}</small>
    </div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Matrícula</dt>
        <dd class="col-sm-9">
          {% if pago.matricula %}
            <a href="{{ url_for('matriculas.detalle', matricula_id=pago.matricula.id) }}">Matrícula #{{ pago.matricula.id }} — {{ pago.matricula.estudiante_nombre }}</a>
          {% else %}
            —
          {% endif %}
        </dd>

        <dt class="col-sm-3">Tipo</dt>
        <dd class="col-sm-9">
          {% if pago.numero_cuota is defined and pago.numero_cuota == 0 %}
            Pago inicial (matrícula)
          {% elif pago.es_pago_inicial is defined and pago.es_pago_inicial %}
            Pago inicial (matrícula)
          {% else %}
            Pago de cuota
          {% endif %}
        </dd>

        <dt class="col-sm-3">Monto</dt>
        <dd class="col-sm-9">{{ "%.2f"|format(pago.monto or 0) }}</dd>

        <dt class="col-sm-3">Fecha</dt>
        <dd class="col-sm-9">{{ pago.fecha_pago.strftime('%d/%m/%Y') if pago.fecha_pago else (pago.fecha_vencimiento.strftime('%d/%m/%Y') if pago.fecha_vencimiento else '—') }}</dd>
      </dl>

      <hr/>

      <h6>Comprobante</h6>
      {# Intentamos mostrar comprobante asociado directamente al Pago #}
      {% set comprobante = None %}
      {% if pago is defined %}
        {# comprobante directo en pago (varios nombres posibles) #}
        {% if pago.documento_path is defined and pago.documento_path %}
          {% set comprobante = {'path': pago.documento_path, 'filename': pago.filename if pago.filename is defined else None} %}
        {% elif pago.documento_id is defined and pago.documento_id %}
          {% set comprobante = {'id': pago.documento_id} %}
        {% elif pago.comprobante_id is defined and pago.comprobante_id %}
          {% set comprobante = {'id': pago.comprobante_id} %}
        {% endif %}

        {# Si no hay comprobante directo, buscar en la matrícula del pago: tipo 'factura_primer_pago' primero #}
        {% if not comprobante and pago.matricula is defined %}
          {% set docs = (pago.matricula.documentos|list) if pago.matricula.documentos is defined else [] %}
          {% set factura_docs = docs | selectattr('tipo','equalto','factura_primer_pago') | list %}
          {% if factura_docs and factura_docs|length > 0 %}
            {% set doc = factura_docs[-1] %}
            {% set comprobante = {'id': doc.id, 'path': doc.path, 'filename': doc.filename} %}
          {% elif docs and docs|length > 0 %}
            {% set doc = docs[-1] %}
            {% set comprobante = {'id': doc.id, 'path': doc.path, 'filename': doc.filename} %}
          {% endif %}
        {% endif %}
      {% endif %}

      {% if comprobante %}
        <p class="mb-2">Se encontró un comprobante asociado:</p>
        <div>
          {% if comprobante.path %}
            <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=pago.matricula.id, documento_id=comprobante.id) if comprobante.id else '#' }}" class="btn btn-outline-primary" target="_blank">
              <i class="fas fa-download me-1"></i> Descargar comprobante
            </a>
            {% if comprobante.filename %}
              <span class="ms-2 small text-muted">{{ comprobante.filename }}</span>
            {% endif %}
          {% elif comprobante.id %}
            <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=pago.matricula.id, documento_id=comprobante.id) }}" class="btn btn-outline-primary" target="_blank">
              <i class="fas fa-download me-1"></i> Descargar comprobante
            </a>
          {% else %}
            <div class="alert alert-info mb-0">Comprobante registrado pero no accesible.</div>
          {% endif %}
        </div>
      {% else %}
        <div class="alert alert-warning">No hay comprobante adjunto - Este pago no tiene documento de comprobante registrado.</div>
      {% endif %}

      <hr/>
      <a href="{{ url_for('validaciones.index') }}" class="btn btn-light">Volver a Validaciones</a>
    </div>
  </div>
</div>
{% endblock %}