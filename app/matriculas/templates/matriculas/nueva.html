{% extends "base.html" %}
{% block title %}Nueva Matrícula — BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-user-plus me-2"></i>{{ 'Editar' if edit_mode else 'Nueva' }} Matrícula</h4>
      <a href="{{ url_for('matriculas.index') }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <form method="POST" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="card-body">
        <h5 class="fw-bold text-success mb-3">{{ curso.nombre }}</h5>

        {% if curso.tipo == 'FP' %}
          <div class="mb-3">
            {{ form.tipo_fp_anho.label(class="form-label fw-semibold") }}
            <div>
              {% for sub in form.tipo_fp_anho %}
                <div class="form-check form-check-inline">
                  {{ sub(class="form-check-input") }}
                  <label class="form-check-label" for="{{ sub.id }}">{{ sub.label.text }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- DATOS GENERALES -->
        <div class="row g-3">
          <div class="col-md-6">
            {{ form.estudiante_nombre.label(class="form-label") }}
            {{ form.estudiante_nombre(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.doc_identidad.label(class="form-label") }}
            {{ form.doc_identidad(class="form-control") }}
          </div>
          <div class="col-md-4">
            {{ form.telefono.label(class="form-label") }}
            {{ form.telefono(class="form-control") }}
          </div>
          <div class="col-md-4">
            {{ form.email.label(class="form-label") }}
            {{ form.email(class="form-control") }}
          </div>
          <div class="col-md-4">
            {{ form.campus.label(class="form-label") }}
            {{ form.campus(class="form-select") }}
          </div>
          <div class="col-md-12">
            {{ form.direccion.label(class="form-label") }}
            {{ form.direccion(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.coste_total.label(class="form-label") }}
            {{ form.coste_total(class="form-control", placeholder="Ej: 150000") }}
          </div>
          <div class="col-md-6">
        {{ form.numero_plazos.label(class="form-label") }}
        {{ form.numero_plazos(class="form-control", placeholder="Ej: 6") }}
    </div>

    <div class="col-md-6">
    {{ form.monto_inicial.label(class="form-label") }}
    {{ form.monto_inicial(class="form-control", placeholder="Ej: 50000") }}
    <small class="text-muted">Monto del primer pago que se adjunta con la matrícula</small>
</div>
        </div>

        <hr class="my-4">

        <!-- DOCUMENTOS REQUERIDOS -->
        <h6 class="fw-bold text-success mb-3">
          <i class="fas fa-file-upload me-2"></i>Documentos Requeridos
        </h6>
        <div class="row g-3">
          <div class="col-md-6">
            {{ form.expediente_academico.label(class="form-label") }}
            {{ form.expediente_academico(class="form-control", accept=".pdf") }}
            <small class="text-muted">Sube el expediente académico en formato PDF.</small>
          </div>
          <div class="col-md-6">
            {{ form.factura_primer_pago.label(class="form-label") }}
            {{ form.factura_primer_pago(class="form-control", accept=".pdf") }}
            <small class="text-muted">Sube la factura del primer pago en formato PDF.</small>
          </div>
        </div>

        {% if curso.tipo == 'FP' %}
          <hr class="my-4">

          <!-- BLOQUE SELECCIÓN MÓDULOS -->
          <div id="bloque-segundo-ano" style="display:none;">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
              <div>
                <i class="fas fa-info-circle me-2"></i>
                Si el alumno tiene pendientes del 1º año, márquelas a continuación.
                Para poder elegir asignaturas del 2º año debe seleccionar todas las pendientes del 1º.
              </div>
              <div class="form-check">
                {{ form.no_esta_en_lista(id="noLista", value="0") }}
                <input type="checkbox" id="no-lista-chk" class="form-check-input">
                <label class="form-check-label" for="no-lista-chk">
                  El alumno no está en la lista (asignar todo 2º año)
                </label>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-2">
                  <i class="fas fa-list-check me-2"></i>Pendientes de 1º año
                </h6>
                {% for mo in mod_anio1 %}
                  <div class="form-check">
                    <input class="form-check-input ck-ano1"
                           type="checkbox"
                           name="mod_ano1[]" id="mo1-{{ mo.id }}"
                           value="{{ mo.id }}"
                           {% if sel_ano1 and (mo.id in sel_ano1) %}checked{% endif %}>
                    <label class="form-check-label" for="mo1-{{ mo.id }}">{{ mo.nombre }}</label>
                  </div>
                {% else %}
                  <div class="text-muted fst-italic">Sin módulos definidos para 1º año.</div>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <h6 class="text-success mb-2">
                  <i class="fas fa-list-ul me-2"></i>Asignaturas de 2º año
                </h6>
                {% for mo in mod_anio2 %}
                  <div class="form-check">
                    <input class="form-check-input ck-ano2"
                           type="checkbox"
                           name="mod_ano2[]" id="mo2-{{ mo.id }}"
                           value="{{ mo.id }}"
                           {% if sel_ano2 and (mo.id in sel_ano2) %}checked{% endif %}>
                    <label class="form-check-label" for="mo2-{{ mo.id }}">{{ mo.nombre }}</label>
                  </div>
                {% else %}
                  <div class="text-muted fst-italic">Sin módulos definidos para 2º año.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}

        <!-- BOTÓN GUARDAR -->
        <div class="text-end mt-4">
          {{ form.enviar(class="btn btn-success px-4") }}
        </div>
      </div>
    </form>
  </div>
</div>

{% if curso.tipo == 'FP' %}
<script>
(function(){
  const radios = document.querySelectorAll('input[name="{{ form.tipo_fp_anho.name }}"]');
  const block2 = document.getElementById('bloque-segundo-ano');
  const noListaChk = document.getElementById('no-lista-chk');
  const hiddenNoLista = document.getElementById('noLista');
  const ano1 = document.querySelectorAll('.ck-ano1');
  const ano2 = document.querySelectorAll('.ck-ano2');

  function refresh(){
    const v = document.querySelector('input[name="{{ form.tipo_fp_anho.name }}"]:checked')?.value;
    block2.style.display = (v === 'SEGUNDO_ANO') ? '' : 'none';
    const noLista = noListaChk.checked;
    hiddenNoLista.value = noLista ? '1' : '0';
    [...ano1, ...ano2].forEach(el => el.disabled = noLista);
  }

  function enforce(){
    if (!noListaChk.checked){
      const total1 = Array.from(ano1).length;
      const sel1 = Array.from(ano1).filter(el => el.checked).length;
      const allow2 = (total1 === 0) || (sel1 === total1);
      ano2.forEach(el => {
        el.disabled = !allow2;
        if (!allow2) el.checked = false;
      });
    }
  }

  radios.forEach(r => r.addEventListener('change', ()=>{ refresh(); enforce(); }));
  noListaChk?.addEventListener('change', ()=>{ refresh(); enforce(); });
  ano1.forEach(c => c.addEventListener('change', enforce));
  refresh(); enforce();
})();
</script>
{% endif %}
{% endblock %}
