=== EXPORTACI√ìN COMPLETA DEL C√ìDIGO DEL SISTEMA ===


================================================================================
üìÅ Archivo: .\auto_migrate.py
================================================================================

import os
from datetime import datetime

print("üß± Iniciando migraci√≥n autom√°tica...")

os.system("flask db migrate -m 'auto update'")
os.system("flask db upgrade")

print("‚úÖ Migraci√≥n completada exitosamente.")



================================================================================
üìÅ Archivo: .\check_schema_sync.py
================================================================================

# check_schema_sync.py
"""
Verificador de sincronizaci√≥n entre los modelos SQLAlchemy y la base de datos SQLite.
Detecta columnas faltantes o sobrantes entre los modelos y la base de datos.
Compatible con Flask (usa contexto de aplicaci√≥n autom√°ticamente).
"""

import os
from app import create_app, db
from sqlalchemy import inspect

DB_PATH = os.path.join("instance", "app.db")

def check_schema():
    print("üîç Comprobando sincronizaci√≥n entre modelos y base de datos...")
    inspector = inspect(db.engine)
    inconsistencias = False

    for model_class in db.Model.__subclasses__():
        if not hasattr(model_class, "__tablename__"):
            continue

        table_name = model_class.__tablename__
        print(f"\nüß± Tabla: {table_name}")

        try:
            db_columns = {col["name"] for col in inspector.get_columns(table_name)}
        except Exception:
            print("  ‚ö†Ô∏è La tabla no existe en la base de datos.")
            inconsistencias = True
            continue

        model_columns = {col.name for col in model_class.__table__.columns}
        faltantes = model_columns - db_columns
        sobrantes = db_columns - model_columns

        if faltantes:
            inconsistencias = True
            print(f"  ‚ö†Ô∏è Faltan en la base de datos: {', '.join(sorted(faltantes))}")
        if sobrantes:
            inconsistencias = True
            print(f"  ‚ö†Ô∏è Sobran en la base de datos: {', '.join(sorted(sobrantes))}")
        if not faltantes and not sobrantes:
            print("  ‚úÖ Sincronizada correctamente.")

    if inconsistencias:
        print("\n‚ùå Se detectaron diferencias. Ejecuta una migraci√≥n con:")
        print("   flask db migrate -m 'sync schema' && flask db upgrade")
    else:
        print("\n‚úÖ Todos los modelos coinciden con la base de datos.")


if __name__ == "__main__":
    if not os.path.exists(DB_PATH):
        print(f"‚ùå No se encontr√≥ la base de datos en: {DB_PATH}")
    else:
        app = create_app()  # Inicializa la app Flask
        with app.app_context():  # Usa el contexto de aplicaci√≥n
            check_schema()



================================================================================
üìÅ Archivo: .\constantes.py
================================================================================

# app/constantes.py

# Estados de matr√≠cula
ESTADO_MAT_PENDIENTE = "PENDIENTE_VALIDACION"
ESTADO_MAT_VALIDADA = "VALIDADA"
ESTADO_MAT_RECHAZADA = "RECHAZADA"


================================================================================
üìÅ Archivo: .\exportar_codigo.py
================================================================================

import os

EXCLUDE_EXT = {'.png', '.jpg', '.jpeg', '.gif', '.bmp', '.txt', '.sql', '.pyc'}
EXCLUDE_DIRS = {'.venv', 'venv', 'env', '__pycache__', '.git', 'instance'}
INCLUDE_EXT = {'.py', '.html', '.css', '.js'}

OUTPUT_FILE = "export_codigo_sistema.txt"

def debe_incluir(ruta):
    base = os.path.basename(ruta)
    if base.startswith('.') or base == '.env':
        return False
    ext = os.path.splitext(ruta)[1].lower()
    if ext in EXCLUDE_EXT:
        return False
    return ext in INCLUDE_EXT

def exportar_codigo():
    with open(OUTPUT_FILE, "w", encoding="utf-8") as salida:
        salida.write("=== EXPORTACI√ìN COMPLETA DEL C√ìDIGO DEL SISTEMA ===\n\n")
        for carpeta, subdirs, archivos in os.walk('.'):
            subdirs[:] = [d for d in subdirs if d not in EXCLUDE_DIRS]
            for archivo in archivos:
                ruta = os.path.join(carpeta, archivo)
                if debe_incluir(ruta):
                    try:
                        with open(ruta, "r", encoding="utf-8") as f:
                            contenido = f.read()
                        salida.write(f"\n{'='*80}\n")
                        salida.write(f"üìÅ Archivo: {ruta}\n")
                        salida.write(f"{'='*80}\n\n")
                        salida.write(contenido)
                        salida.write("\n\n")
                    except Exception as e:
                        salida.write(f"\n[ERROR al leer {ruta}: {e}]\n")
        salida.write("\n=== FIN DE EXPORTACI√ìN ===\n")

    print(f"‚úÖ Exportaci√≥n completada: {OUTPUT_FILE}")

if __name__ == "__main__":
    exportar_codigo()



================================================================================
üìÅ Archivo: .\fix_dates.py
================================================================================

"""
Script para corregir los formatos de fecha en la base de datos
"""
import os
import sqlite3
from datetime import datetime
from app import create_app

def fix_date_formats():
    """Convierte todos los formatos de fecha incorrectos en la base de datos"""
    app = create_app()
    
    with app.app_context():
        DB_PATH = os.path.join(app.instance_path, "app.db")
        
        if not os.path.exists(DB_PATH):
            print("‚ùå No se encontr√≥ la base de datos")
            return False
        
        try:
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            
            print("üîç Verificando y corrigiendo formatos de fecha...")
            
            # Verificar la estructura actual de las tablas
            cursor.execute("PRAGMA table_info(pagos)")
            pagos_columns = [col[1] for col in cursor.fetchall()]
            print(f"üìã Columnas en 'pagos': {pagos_columns}")
            
            # Corregir fechas en la tabla pagos
            if 'fecha_vencimiento' in pagos_columns:
                print("üîÑ Corrigiendo formato de fecha_vencimiento...")
                
                # Obtener todos los registros con fecha_vencimiento
                cursor.execute("SELECT id, fecha_vencimiento FROM pagos WHERE fecha_vencimiento IS NOT NULL")
                rows = cursor.fetchall()
                
                updated_count = 0
                for row_id, fecha_str in rows:
                    if fecha_str and ' ' in fecha_str:  # Si contiene espacio (formato datetime)
                        try:
                            # Convertir de datetime a date
                            fecha_dt = datetime.strptime(fecha_str, '%Y-%m-%d %H:%M:%S.%f')
                            fecha_date = fecha_dt.strftime('%Y-%m-%d')
                            
                            # Actualizar el registro
                            cursor.execute(
                                "UPDATE pagos SET fecha_vencimiento = ? WHERE id = ?",
                                (fecha_date, row_id)
                            )
                            updated_count += 1
                        except ValueError as e:
                            print(f"‚ö†Ô∏è Error procesando fecha {fecha_str}: {e}")
                
                print(f"‚úÖ Corregidas {updated_count} fechas en fecha_vencimiento")
            
            if 'fecha_pago' in pagos_columns:
                print("üîÑ Corrigiendo formato de fecha_pago...")
                
                # Obtener todos los registros con fecha_pago
                cursor.execute("SELECT id, fecha_pago FROM pagos WHERE fecha_pago IS NOT NULL")
                rows = cursor.fetchall()
                
                updated_count = 0
                for row_id, fecha_str in rows:
                    if fecha_str and ' ' in fecha_str:  # Si contiene espacio (formato datetime)
                        try:
                            # Convertir de datetime a date
                            fecha_dt = datetime.strptime(fecha_str, '%Y-%m-%d %H:%M:%S.%f')
                            fecha_date = fecha_dt.strftime('%Y-%m-%d')
                            
                            # Actualizar el registro
                            cursor.execute(
                                "UPDATE pagos SET fecha_pago = ? WHERE id = ?",
                                (fecha_date, row_id)
                            )
                            updated_count += 1
                        except ValueError as e:
                            print(f"‚ö†Ô∏è Error procesando fecha {fecha_str}: {e}")
                
                print(f"‚úÖ Corregidas {updated_count} fechas en fecha_pago")
            
            # Verificar tambi√©n la tabla matriculas si tiene campos de fecha
            cursor.execute("PRAGMA table_info(matriculas)")
            matriculas_columns = [col[1] for col in cursor.fetchall()]
            
            if 'created_at' in matriculas_columns:
                print("üîÑ Verificando formato de created_at en matriculas...")
                cursor.execute("SELECT id, created_at FROM matriculas WHERE created_at IS NOT NULL LIMIT 5")
                sample_rows = cursor.fetchall()
                for row_id, fecha_str in sample_rows:
                    print(f"   Muestra created_at: {fecha_str}")
            
            conn.commit()
            conn.close()
            
            print("‚úÖ Correcci√≥n de formatos de fecha completada")
            return True
            
        except Exception as e:
            print(f"‚ùå Error corrigiendo formatos de fecha: {e}")
            return False

def verify_date_fix():
    """Verifica que las fechas se hayan corregido correctamente"""
    app = create_app()
    
    with app.app_context():
        DB_PATH = os.path.join(app.instance_path, "app.db")
        
        try:
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            
            print("\nüîç Verificando correcci√≥n de fechas...")
            
            # Verificar fechas en pagos
            cursor.execute("""
                SELECT id, fecha_vencimiento, fecha_pago 
                FROM pagos 
                WHERE fecha_vencimiento IS NOT NULL OR fecha_pago IS NOT NULL
                LIMIT 5
            """)
            rows = cursor.fetchall()
            
            print("üìã Muestra de fechas corregidas:")
            for row in rows:
                print(f"   ID: {row[0]}, Vencimiento: {row[1]}, Pago: {row[2]}")
            
            # Contar fechas con formato incorrecto
            cursor.execute("SELECT COUNT(*) FROM pagos WHERE fecha_vencimiento LIKE '% %'")
            bad_format_count = cursor.fetchone()[0]
            
            if bad_format_count == 0:
                print("‚úÖ Todas las fechas tienen el formato correcto")
            else:
                print(f"‚ö†Ô∏è A√∫n hay {bad_format_count} fechas con formato incorrecto")
            
            conn.close()
            return bad_format_count == 0
            
        except Exception as e:
            print(f"‚ùå Error verificando correcci√≥n: {e}")
            return False

if __name__ == "__main__":
    print("üîÑ INICIANDO CORRECCI√ìN DE FORMATOS DE FECHA...")
    
    if fix_date_formats():
        print("\n‚úÖ Correcci√≥n completada")
        
        if verify_date_fix():
            print("\nüéâ ¬°Todas las fechas han sido corregidas correctamente!")
            print("üöÄ La aplicaci√≥n deber√≠a funcionar sin errores ahora.")
        else:
            print("\n‚ö†Ô∏è  La correcci√≥n se complet√≥ pero hay advertencias")
            print("üí° Es posible que necesites ejecutar el script nuevamente")
    else:
        print("\n‚ùå Error en la correcci√≥n de fechas")


================================================================================
üìÅ Archivo: .\reset_db.py
================================================================================

"""
RESET_DB.PY ‚Äî Reinicia la base de datos del Sistema BBS (versi√≥n mejorada)
------------------------------------------------------------------------------
1Ô∏è‚É£ Verifica y aplica migraciones pendientes
2Ô∏è‚É£ Si hay problemas, crea una copia de seguridad y reinicia completamente
3Ô∏è‚É£ Crea todas las tablas seg√∫n los modelos activos
4Ô∏è‚É£ Inserta datos de prueba para todos los m√≥dulos
"""

import os
import shutil
import subprocess
from datetime import datetime, timedelta
from app import create_app, db
from app.usuarios.models import Usuario, Role
from app.cursos.models import Curso, Modulo, CURSO_TIPO_FP, ESTADO_VALIDADO
from app.matriculas.models import Matricula, MatriculaDocumento, MatriculaAsignatura
from app.pagos.models import Pago, ESTADO_PAGO_PENDIENTE

app = create_app()
DB_PATH = os.path.join(app.instance_path, "app.db")
MIGRATIONS_DIR = "migrations"


def backup_database():
    """Crea una copia de seguridad de la base de datos actual"""
    if os.path.exists(DB_PATH):
        backup_dir = os.path.join(app.instance_path, "backups")
        os.makedirs(backup_dir, exist_ok=True)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_path = os.path.join(backup_dir, f"app_backup_{timestamp}.db")
        
        shutil.copy2(DB_PATH, backup_path)
        print(f"üì¶ Copia de seguridad creada: {backup_path}")
        return backup_path
    return None


def try_migrations():
    """Intenta aplicar migraciones existentes"""
    if not os.path.exists(MIGRATIONS_DIR):
        print("‚ùå No existe la carpeta de migraciones")
        return False

    print("üîÑ Intentando aplicar migraciones existentes...")
    try:
        # Usar subprocess para ejecutar comandos Flask
        result = subprocess.run(['flask', 'db', 'upgrade'], 
                              capture_output=True, text=True, shell=True)
        if result.returncode == 0:
            print("‚úÖ Migraciones aplicadas correctamente")
            return True
        else:
            print(f"‚ùå Error aplicando migraciones: {result.stderr}")
            return False
    except Exception as e:
        print(f"‚ùå Error ejecutando migraciones: {e}")
        return False


def init_migrations():
    """Inicializa el sistema de migraciones si no existe"""
    print("üîÑ Inicializando sistema de migraciones...")
    
    try:
        # Ejecutar flask db init
        result = subprocess.run(['flask', 'db', 'init'], 
                              capture_output=True, text=True, shell=True)
        if result.returncode != 0:
            print(f"‚ùå Error inicializando migraciones: {result.stderr}")
            return False
        
        # Ejecutar flask db migrate
        result = subprocess.run(['flask', 'db', 'migrate', '-m', 'Initial migration'], 
                              capture_output=True, text=True, shell=True)
        if result.returncode != 0:
            print(f"‚ùå Error creando migraci√≥n inicial: {result.stderr}")
            return False
        
        # Ejecutar flask db upgrade
        result = subprocess.run(['flask', 'db', 'upgrade'], 
                              capture_output=True, text=True, shell=True)
        if result.returncode != 0:
            print(f"‚ùå Error aplicando migraci√≥n: {result.stderr}")
            return False
        
        print("‚úÖ Sistema de migraciones inicializado correctamente")
        return True
    except Exception as e:
        print(f"‚ùå Error inicializando migraciones: {e}")
        return False


def force_create_tables():
    """Fuerza la creaci√≥n de todas las tablas directamente"""
    print("üî® Forzando creaci√≥n de tablas...")
    try:
        with app.app_context():
            # Crear todas las tablas
            db.create_all()
            
            # Verificar que las tablas cr√≠ticas existen
            inspector = db.inspect(db.engine)
            tables = inspector.get_table_names()
            
            required_tables = ['usuarios', 'roles', 'cursos', 'matriculas', 'pagos']
            missing_tables = [table for table in required_tables if table not in tables]
            
            if missing_tables:
                print(f"‚ùå Tablas faltantes: {missing_tables}")
                return False
            else:
                print("‚úÖ Todas las tablas creadas correctamente")
                return True
    except Exception as e:
        print(f"‚ùå Error creando tablas: {e}")
        return False


def reset_database(force_reset=False):
    """Reinicia la base de datos de manera inteligente"""
    print("‚öôÔ∏è Iniciando proceso de reinicio de base de datos...")
    
    # Crear copia de seguridad
    backup_path = backup_database()
    
    if not force_reset:
        # Si no hay migraciones, inicializarlas primero
        if not os.path.exists(MIGRATIONS_DIR):
            print("üìù No hay migraciones existentes, inicializando...")
            if init_migrations():
                print("‚úÖ Base de datos configurada con migraciones")
                return True
            else:
                print("‚ùå Fall√≥ la inicializaci√≥n de migraciones, continuando con reset completo")
        else:
            # Intentar migraciones existentes
            if try_migrations():
                print("‚úÖ Base de datos actualizada con migraciones")
                return True
    
    # Si las migraciones fallan o se fuerza el reset
    print("üîÑ Iniciando reset completo...")
    
    # 1Ô∏è‚É£ Eliminar archivo existente
    if os.path.exists(DB_PATH):
        os.remove(DB_PATH)
        print(f"üóëÔ∏è Base de datos eliminada: {DB_PATH}")
    
    # 2Ô∏è‚É£ Crear estructura nueva
    success = force_create_tables()
    
    if success:
        seed_data()
        print("‚úÖ Reinicio de base de datos completado.")
        
        # Inicializar migraciones para el futuro
        if not os.path.exists(MIGRATIONS_DIR):
            init_migrations()
        else:
            # Si ya existen migraciones, crear una nueva migraci√≥n que refleje el estado actual
            try:
                subprocess.run(['flask', 'db', 'migrate', '-m', 'Current state after reset'], 
                             capture_output=True, text=True, shell=True)
                subprocess.run(['flask', 'db', 'upgrade'], 
                             capture_output=True, text=True, shell=True)
                print("‚úÖ Migraciones actualizadas")
            except Exception as e:
                print(f"‚ö†Ô∏è No se pudieron actualizar las migraciones: {e}")
    else:
        print("‚ùå Error en el reinicio de la base de datos")
        if backup_path:
            print(f"üíæ Puedes restaurar la copia de seguridad desde: {backup_path}")
    
    return success


def seed_data():
    """Inserta roles, usuario admin, cursos, matr√≠culas y pagos de prueba"""
    print("üß© Insertando datos iniciales...")

    # ==== ROLES ====
    roles_base = ["Administrador", "Administrativo", "Supervisor", "Profesor"]
    for nombre in roles_base:
        if not Role.query.filter_by(nombre=nombre).first():
            db.session.add(Role(nombre=nombre, descripcion=f"Rol del sistema: {nombre}"))
    db.session.commit()
    print("‚úÖ Roles creados.")

    # ==== USUARIO ADMIN ====
    admin = Usuario(
        username="admin",
        full_name="Administrador del Sistema",
        email="admin@bbs.edu",
        activo=True,
        ultimo_login=datetime.now(),
        sesion_activa=False
    )
    
    if hasattr(admin, "set_password"):
        admin.set_password("admin123")
    else:
        admin.password_hash = "admin123"

    rol_admin = Role.query.filter_by(nombre="Administrador").first()
    if rol_admin and hasattr(admin, "roles"):
        admin.roles.append(rol_admin)

    db.session.add(admin)
    db.session.commit()
    print("‚úÖ Usuario administrador creado: admin / admin123")

    # ==== CURSOS DE PRUEBA ====
    cursos = [
        Curso(
            nombre="T√©cnico Superior en Banca y Finanzas",
            tipo=CURSO_TIPO_FP,
            horas_totales=1800,
            horas_semanales=20,
            estado=ESTADO_VALIDADO,
            es_plantilla=True,
            created_by=admin if hasattr(Curso, "created_by") else None,
        ),
        Curso(
            nombre="T√©cnico Superior en Contabilidad y Auditor√≠a",
            tipo=CURSO_TIPO_FP,
            horas_totales=1800,
            horas_semanales=20,
            estado=ESTADO_VALIDADO,
            es_plantilla=True,
            created_by=admin if hasattr(Curso, "created_by") else None,
        ),
        Curso(
            nombre="T√©cnico Superior en Gesti√≥n de Recursos Humanos",
            tipo=CURSO_TIPO_FP,
            horas_totales=1800,
            horas_semanales=20,
            estado=ESTADO_VALIDADO,
            es_plantilla=True,
            created_by=admin if hasattr(Curso, "created_by") else None,
        ),
    ]
    db.session.add_all(cursos)
    db.session.commit()
    print("üìò Cursos base creados.")

    # ==== M√ìDULOS ASOCIADOS ====
    modulos = [
        # Banca y Finanzas
        Modulo(curso_id=cursos[0].id, nombre="Matem√°tica Financiera", horas_modulo=90, anio_fp=1, semestre_fp=1),
        Modulo(curso_id=cursos[0].id, nombre="Productos y Servicios Bancarios", horas_modulo=100, anio_fp=1, semestre_fp=2),
        Modulo(curso_id=cursos[0].id, nombre="Gesti√≥n de Cr√©ditos y Riesgos", horas_modulo=100, anio_fp=2, semestre_fp=1),

        # Contabilidad
        Modulo(curso_id=cursos[1].id, nombre="Contabilidad General", horas_modulo=90, anio_fp=1, semestre_fp=1),
        Modulo(curso_id=cursos[1].id, nombre="Fiscalidad Nacional", horas_modulo=100, anio_fp=2, semestre_fp=1),
        Modulo(curso_id=cursos[1].id, nombre="Auditor√≠a Financiera", horas_modulo=100, anio_fp=2, semestre_fp=2),

        # RRHH
        Modulo(curso_id=cursos[2].id, nombre="Psicolog√≠a Laboral", horas_modulo=80, anio_fp=1, semestre_fp=1),
        Modulo(curso_id=cursos[2].id, nombre="Legislaci√≥n Laboral de Guinea Ecuatorial", horas_modulo=90, anio_fp=1, semestre_fp=2),
        Modulo(curso_id=cursos[2].id, nombre="Gesti√≥n del Talento Humano", horas_modulo=100, anio_fp=2, semestre_fp=1),
    ]
    db.session.add_all(modulos)
    db.session.commit()
    print("‚úÖ M√≥dulos agregados correctamente.")

    # ==== MATR√çCULAS DE EJEMPLO ====
    matriculas = [
        Matricula(
            curso_id=cursos[0].id,
            estudiante_nombre="Juan Esono Mba",
            doc_identidad="GE123456",
            telefono="222-111-222",
            email="juan.esono@estudiantes.bbs.edu",
            direccion="Barrio Sampaka, Malabo",
            campus="MALABO",
            tipo_fp_anho="PRIMER_ANO",
            coste_total=75000,
            numero_plazos=6,  # ‚úÖ NUEVO CAMPO
            created_by_id=admin.id,
        ),
        Matricula(
            curso_id=cursos[1].id,
            estudiante_nombre="Rosa Obiang Ndong",
            doc_identidad="GE789012",
            telefono="222-333-444",
            email="rosa.obiang@estudiantes.bbs.edu",
            direccion="Calle Bata Centro",
            campus="BATA",
            tipo_fp_anho="SEGUNDO_ANO",
            coste_total=70000,
            numero_plazos=4,  # ‚úÖ NUEVO CAMPO
            created_by_id=admin.id,
        ),
    ]
    db.session.add_all(matriculas)
    db.session.commit()
    print("üéì Matr√≠culas de prueba registradas correctamente.")

    # ==== PAGOS DE EJEMPLO ====
    print("üí∞ Creando calendarios de pagos...")
    for matricula in matriculas:
        cuota = round(matricula.coste_total / matricula.numero_plazos, 2)
        for i in range(1, matricula.numero_plazos + 1):
            pago = Pago(
                matricula_id=matricula.id,
                numero_cuota=i,
                monto=cuota,
                estado=ESTADO_PAGO_PENDIENTE,
                fecha_vencimiento=datetime.now() + timedelta(days=30 * i)
            )
            db.session.add(pago)
    
    db.session.commit()
    print("‚úÖ Calendarios de pagos creados correctamente.")
    print("üå± Todos los datos de prueba insertados correctamente.")


if __name__ == "__main__":
    import sys
    
    # Verificar argumentos
    force_reset = "--force" in sys.argv
    
    if force_reset:
        print("üö® MODO FUERZA ACTIVADO - Se reiniciar√° completamente la base de datos")
        user_input = input("¬øEst√°s seguro? (s/N): ")
        if user_input.lower() != 's':
            print("‚ùå Operaci√≥n cancelada")
            sys.exit(0)
    
    with app.app_context():
        success = reset_database(force_reset=force_reset)
        
        if success:
            print("\nüéâ ¬°Base de datos lista!")
            print("üìä Puedes acceder al sistema con:")
            print("   Usuario: admin")
            print("   Contrase√±a: admin123")
            
            # Verificaci√≥n final
            try:
                from app.matriculas.models import Matricula
                from app.pagos.models import Pago
                
                total_matriculas = Matricula.query.count()
                total_pagos = Pago.query.count()
                
                print(f"üìà Verificaci√≥n: {total_matriculas} matr√≠culas, {total_pagos} pagos creados")
            except Exception as e:
                print(f"‚ö†Ô∏è Verificaci√≥n: {e}")
        else:
            print("\nüí• Hubo problemas con la base de datos")
            sys.exit(1)


================================================================================
üìÅ Archivo: .\reset_migrations.py
================================================================================

import os
import shutil
import sqlite3
from datetime import datetime
import subprocess
import sys

BASE_DIR = os.path.abspath(os.path.dirname(__file__))
DB_PATH = os.path.join(BASE_DIR, "instance", "app.db")
BACKUP_DIR = os.path.join(BASE_DIR, "instance", "backups")
MIGRATIONS_DIR = os.path.join(BASE_DIR, "migrations")

def run_command(command, description):
    """Ejecuta un comando y muestra el resultado"""
    print(f"üîÑ {description}...")
    try:
        result = subprocess.run(command, shell=True, capture_output=True, text=True, cwd=BASE_DIR)
        if result.returncode == 0:
            print(f"‚úÖ {description} completado")
            if result.stdout.strip():
                print(f"   Salida: {result.stdout.strip()}")
            return True
        else:
            print(f"‚ùå Error en {description}: {result.stderr}")
            if result.stdout.strip():
                print(f"   Salida: {result.stdout.strip()}")
            return False
    except Exception as e:
        print(f"‚ùå Error ejecutando {description}: {e}")
        return False

def backup_database():
    """Crea una copia de seguridad de la base de datos"""
    if not os.path.exists(DB_PATH):
        print("‚ÑπÔ∏è No hay base de datos existente para respaldar")
        return True
        
    os.makedirs(BACKUP_DIR, exist_ok=True)
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_path = os.path.join(BACKUP_DIR, f"app_backup_{timestamp}.db")
    
    try:
        shutil.copy2(DB_PATH, backup_path)
        print(f"‚úÖ Copia de seguridad creada: {backup_path}")
        return True
    except Exception as e:
        print(f"‚ùå Error creando copia de seguridad: {e}")
        return False

def check_current_db_structure():
    """Verifica la estructura actual de la base de datos"""
    print("\nüîç Verificando estructura actual de la base de datos...")
    if not os.path.exists(DB_PATH):
        print("‚ÑπÔ∏è No existe la base de datos")
        return False
    
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Verificar si existe la tabla matriculas
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='matriculas'")
        if not cursor.fetchone():
            print("‚ùå No existe la tabla 'matriculas'")
            conn.close()
            return False
        
        # Verificar columnas de la tabla matriculas
        cursor.execute("PRAGMA table_info(matriculas)")
        columns = [column[1] for column in cursor.fetchall()]
        print(f"üìã Columnas actuales en 'matriculas': {', '.join(columns)}")
        
        # Verificar si falta monto_inicial
        if 'monto_inicial' not in columns:
            print("‚ùå Falta la columna 'monto_inicial' en la tabla 'matriculas'")
            conn.close()
            return False
            
        conn.close()
        print("‚úÖ Estructura de la base de datos es correcta")
        return True
        
    except Exception as e:
        print(f"‚ùå Error verificando estructura: {e}")
        return False

def force_migration():
    """Fuerza la aplicaci√≥n de migraciones de manera directa"""
    print("\nüöÄ Aplicando migraciones de manera forzada...")
    
    # Paso 1: Eliminar migraciones existentes si existen
    if os.path.exists(MIGRATIONS_DIR):
        try:
            shutil.rmtree(MIGRATIONS_DIR)
            print("üóëÔ∏è Migraciones existentes eliminadas")
        except Exception as e:
            print(f"‚ùå Error eliminando migraciones: {e}")
            return False
    
    # Paso 2: Inicializar migraciones
    commands = [
        ("flask db init", "Inicializando sistema de migraciones"),
        ("flask db migrate -m \"Estructura inicial con campos nuevos\"", "Generando migraci√≥n inicial"),
        ("flask db upgrade", "Aplicando migraci√≥n a la base de datos")
    ]
    
    for command, description in commands:
        if not run_command(command, description):
            print(f"‚ùå Fall√≥ en: {description}")
            return False
    
    return True

def manual_schema_update():
    """Actualizaci√≥n manual del esquema si las migraciones fallan"""
    print("\nüîß Intentando actualizaci√≥n manual del esquema...")
    
    if not os.path.exists(DB_PATH):
        print("‚ÑπÔ∏è No existe la base de datos para actualizar")
        return False
    
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # Verificar y a√±adir monto_inicial a matriculas
        cursor.execute("PRAGMA table_info(matriculas)")
        columns = [column[1] for column in cursor.fetchall()]
        
        if 'monto_inicial' not in columns:
            print("‚ûï A√±adiendo columna 'monto_inicial' a tabla 'matriculas'...")
            cursor.execute("ALTER TABLE matriculas ADD COLUMN monto_inicial FLOAT DEFAULT 0.0")
            print("‚úÖ Columna 'monto_inicial' a√±adida")
        
        # Verificar y a√±adir campos nuevos a pagos
        cursor.execute("PRAGMA table_info(pagos)")
        columns = [column[1] for column in cursor.fetchall()]
        
        if 'es_pago_inicial' not in columns:
            print("‚ûï A√±adiendo columna 'es_pago_inicial' a tabla 'pagos'...")
            cursor.execute("ALTER TABLE pagos ADD COLUMN es_pago_inicial BOOLEAN DEFAULT 0")
            print("‚úÖ Columna 'es_pago_inicial' a√±adida")
        
        if 'monto_inicial' not in columns:
            print("‚ûï A√±adiendo columna 'monto_inicial' a tabla 'pagos'...")
            cursor.execute("ALTER TABLE pagos ADD COLUMN monto_inicial FLOAT")
            print("‚úÖ Columna 'monto_inicial' a√±adida")
        
        conn.commit()
        conn.close()
        print("‚úÖ Actualizaci√≥n manual completada")
        return True
        
    except Exception as e:
        print(f"‚ùå Error en actualizaci√≥n manual: {e}")
        return False

def verify_final_state():
    """Verifica el estado final despu√©s de la migraci√≥n"""
    print("\nüîç Verificando estado final...")
    
    # Verificar estructura de la base de datos
    if not check_current_db_structure():
        print("‚ùå La estructura de la base de datos no es correcta")
        return False
    
    # Verificar que la aplicaci√≥n funciona
    try:
        from app import create_app, db
        from app.matriculas.models import Matricula
        
        app = create_app()
        with app.app_context():
            # Intentar contar matr√≠culas (esto fallaba antes)
            count = Matricula.query.count()
            print(f"‚úÖ Consulta de matr√≠culas exitosa: {count} registros")
            
            # Verificar que se puede acceder a los nuevos campos
            if count > 0:
                matricula = Matricula.query.first()
                # Esto deber√≠a funcionar sin error ahora
                monto_inicial = getattr(matricula, 'monto_inicial', 'No disponible')
                print(f"‚úÖ Acceso a campo 'monto_inicial': {monto_inicial}")
            
            return True
            
    except Exception as e:
        print(f"‚ùå Error en verificaci√≥n final: {e}")
        return False

def main():
    print("üß± INICIANDO REPARACI√ìN DE BASE DE DATOS...\n")
    print("‚ö†Ô∏è  Este proceso solucionar√° los problemas de migraci√≥n")
    print("    y a√±adir√° los campos faltantes a la base de datos.\n")
    
    # Verificar que estamos en el entorno correcto
    if not os.environ.get('FLASK_APP'):
        os.environ['FLASK_APP'] = 'run.py'
        print("üîß FLASK_APP establecido como 'run.py'")
    
    # Confirmaci√≥n de seguridad
    if "--force" not in sys.argv:
        confirm = input("¬øEst√°s seguro de continuar? (s/N): ")
        if confirm.lower() != 's':
            print("‚ùå Operaci√≥n cancelada")
            return
    
    # Paso 1: Copia de seguridad obligatoria
    print("\n" + "="*50)
    print("CREANDO COPIA DE SEGURIDAD")
    print("="*50)
    
    if not backup_database():
        print("‚ùå Fall√≥ la copia de seguridad. Abortando...")
        return
    
    # Paso 2: Verificar estado actual
    print("\n" + "="*50)
    print("DIAGN√ìSTICO INICIAL")
    print("="*50)
    
    current_state_ok = check_current_db_structure()
    
    if current_state_ok:
        print("‚úÖ La base de datos ya tiene la estructura correcta")
        print("üéâ No se necesitan cambios adicionales")
        return
    
    # Paso 3: Intentar migraci√≥n autom√°tica
    print("\n" + "="*50)
    print("MIGRACI√ìN AUTOM√ÅTICA")
    print("="*50)
    
    migration_success = force_migration()
    
    if not migration_success:
        print("‚ö†Ô∏è  La migraci√≥n autom√°tica fall√≥, intentando enfoque manual...")
        
        # Paso 4: Actualizaci√≥n manual como respaldo
        print("\n" + "="*50)
        print("ACTUALIZACI√ìN MANUAL")
        print("="*50)
        
        if not manual_schema_update():
            print("‚ùå Fall√≥ la actualizaci√≥n manual")
            print("üí° Intenta restaurar desde la copia de seguridad manualmente")
            return
    
    # Paso 5: Verificaci√≥n final
    print("\n" + "="*50)
    print("VERIFICACI√ìN FINAL")
    print("="*50)
    
    if verify_final_state():
        print("\nüéâ ¬°REPARACI√ìN COMPLETADA EXITOSAMENTE!")
        print("\nüìã RESUMEN:")
        print("   ‚úÖ Copia de seguridad creada")
        print("   ‚úÖ Estructura de base de datos actualizada")
        print("   ‚úÖ Campos nuevos a√±adidos")
        print("   ‚úÖ Datos existentes preservados")
        print("\nüöÄ La aplicaci√≥n est√° lista para usar.")
    else:
        print("\n‚ö†Ô∏è  La reparaci√≥n se complet√≥ pero hay advertencias")
        print("üí° La aplicaci√≥n podr√≠a funcionar, pero verifica manualmente")

if __name__ == "__main__":
    main()


================================================================================
üìÅ Archivo: .\run.py
================================================================================

from app import create_app
app = create_app()

if __name__ == "__main__":
    app.run(debug=True)



================================================================================
üìÅ Archivo: .\update_database.py
================================================================================

"""
Script seguro para resetear la base de datos MANTENIENDO los datos existentes
"""
import os
import sqlite3
import shutil
from datetime import datetime
from app import create_app, db
from app.usuarios.models import Usuario, Role
from app.cursos.models import Curso, Modulo
from app.matriculas.models import Matricula, MatriculaDocumento
from app.pagos.models import Pago

def export_data():
    """Exporta todos los datos existentes de la base de datos"""
    app = create_app()
    
    with app.app_context():
        DB_PATH = os.path.join(app.instance_path, "app.db")
        
        if not os.path.exists(DB_PATH):
            print("‚ùå No se encontr√≥ la base de datos para exportar")
            return None
        
        try:
            # Conectar a la base de datos existente
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # Obtener todas las tablas
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
            tables = [row[0] for row in cursor.fetchall()]
            
            data_export = {}
            
            for table in tables:
                if table == 'sqlite_sequence':
                    continue
                    
                print(f"üìä Exportando datos de: {table}")
                cursor.execute(f"SELECT * FROM {table}")
                rows = cursor.fetchall()
                
                # Convertir a lista de diccionarios
                table_data = []
                for row in rows:
                    table_data.append(dict(row))
                
                data_export[table] = table_data
            
            conn.close()
            print("‚úÖ Datos exportados correctamente")
            return data_export
            
        except Exception as e:
            print(f"‚ùå Error exportando datos: {e}")
            return None

def import_data(data_export):
    """Importa los datos exportados a la nueva base de datos"""
    app = create_app()
    
    with app.app_context():
        try:
            # Conectar a la nueva base de datos
            conn = sqlite3.connect(os.path.join(app.instance_path, "app.db"))
            cursor = conn.cursor()
            
            for table, rows in data_export.items():
                if not rows:
                    continue
                
                print(f"üì• Importando datos a: {table}")
                
                # Obtener columnas de la tabla
                cursor.execute(f"PRAGMA table_info({table})")
                columns_info = cursor.fetchall()
                columns = [col[1] for col in columns_info]
                
                # Insertar datos
                for row in rows:
                    # Filtrar solo las columnas que existen en la nueva estructura
                    filtered_row = {k: v for k, v in row.items() if k in columns}
                    
                    if filtered_row:
                        placeholders = ', '.join(['?' for _ in filtered_row])
                        columns_str = ', '.join(filtered_row.keys())
                        values = list(filtered_row.values())
                        
                        cursor.execute(
                            f"INSERT INTO {table} ({columns_str}) VALUES ({placeholders})",
                            values
                        )
            
            conn.commit()
            conn.close()
            print("‚úÖ Datos importados correctamente")
            return True
            
        except Exception as e:
            print(f"‚ùå Error importando datos: {e}")
            return False

def reset_database_safe():
    """Resetea la base de datos manteniendo los datos existentes"""
    app = create_app()
    
    with app.app_context():
        DB_PATH = os.path.join(app.instance_path, "app.db")
        
        if not os.path.exists(DB_PATH):
            print("‚ÑπÔ∏è No hay base de datos existente, creando una nueva...")
            db.create_all()
            return True
        
        # Paso 1: Crear copia de seguridad
        print("üì¶ Creando copia de seguridad...")
        backup_dir = os.path.join(app.instance_path, "backups")
        os.makedirs(backup_dir, exist_ok=True)
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_path = os.path.join(backup_dir, f"app_backup_{timestamp}.db")
        shutil.copy2(DB_PATH, backup_path)
        print(f"‚úÖ Copia de seguridad creada: {backup_path}")
        
        # Paso 2: Exportar datos existentes
        print("üîÑ Exportando datos existentes...")
        data_export = export_data()
        
        if not data_export:
            print("‚ùå No se pudieron exportar los datos existentes")
            return False
        
        # Paso 3: Eliminar base de datos antigua
        print("üóëÔ∏è Eliminando base de datos antigua...")
        db.session.close()
        os.remove(DB_PATH)
        
        # Paso 4: Crear nueva estructura
        print("üîÑ Creando nueva estructura de base de datos...")
        db.create_all()
        
        # Paso 5: Importar datos
        print("üîÑ Importando datos a la nueva estructura...")
        success = import_data(data_export)
        
        if success:
            print("‚úÖ Base de datos actualizada correctamente manteniendo los datos")
            return True
        else:
            # Restaurar desde backup si falla la importaci√≥n
            print("‚ö†Ô∏è Error importando datos, restaurando desde copia de seguridad...")
            shutil.copy2(backup_path, DB_PATH)
            print("‚úÖ Base de datos restaurada desde copia de seguridad")
            return False

def verify_database_integrity():
    """Verifica la integridad de la base de datos despu√©s del reset"""
    app = create_app()
    
    with app.app_context():
        try:
            # Verificar que las tablas cr√≠ticas existen y tienen datos
            tables_to_check = ['usuarios', 'roles', 'cursos', 'matriculas', 'pagos']
            
            for table in tables_to_check:
                count = db.session.execute(f"SELECT COUNT(*) FROM {table}").scalar()
                print(f"üìä {table}: {count} registros")
            
            # Verificar estructura de pagos
            print("\nüîç Verificando estructura de pagos...")
            pago_columns = db.session.execute("PRAGMA table_info(pagos)").fetchall()
            pago_column_names = [col[1] for col in pago_columns]
            print(f"üìã Columnas en 'pagos': {pago_column_names}")
            
            required_columns = ['fecha_pago', 'comprobante_path', 'motivo_rechazo']
            missing_columns = [col for col in required_columns if col not in pago_column_names]
            
            if missing_columns:
                print(f"‚ùå Faltan columnas: {missing_columns}")
                return False
            else:
                print("‚úÖ Todas las columnas necesarias est√°n presentes")
                return True
                
        except Exception as e:
            print(f"‚ùå Error verificando integridad: {e}")
            return False

if __name__ == "__main__":
    print("üöÄ INICIANDO ACTUALIZACI√ìN SEGURA DE LA BASE DE DATOS...")
    print("‚ö†Ô∏è  Este proceso mantendr√° todos los datos existentes")
    print("    y actualizar√° la estructura de la base de datos.\n")
    
    # Confirmaci√≥n de seguridad
    confirm = input("¬øEst√°s seguro de continuar? (s/N): ")
    
    if confirm.lower() == 's':
        print("\n" + "="*50)
        print("PROCESO INICIADO")
        print("="*50)
        
        if reset_database_safe():
            print("\n" + "="*50)
            print("VERIFICACI√ìN DE INTEGRIDAD")
            print("="*50)
            
            if verify_database_integrity():
                print("\nüéâ ¬°ACTUALIZACI√ìN COMPLETADA EXITOSAMENTE!")
                print("\nüìã RESUMEN:")
                print("   ‚úÖ Copia de seguridad creada")
                print("   ‚úÖ Datos existentes preservados")
                print("   ‚úÖ Nueva estructura aplicada")
                print("   ‚úÖ Integridad verificada")
                print("\nüöÄ La aplicaci√≥n est√° lista para usar con la nueva estructura.")
            else:
                print("\n‚ö†Ô∏è  La actualizaci√≥n se complet√≥ pero hay advertencias en la verificaci√≥n")
                print("üí° Verifica manualmente la base de datos")
        else:
            print("\n‚ùå Error en la actualizaci√≥n de la base de datos")
            print("üí° Se restaur√≥ la copia de seguridad autom√°ticamente")
    else:
        print("‚ùå Operaci√≥n cancelada")


================================================================================
üìÅ Archivo: .\wsgi.py
================================================================================

from app import create_app
app = create_app()



================================================================================
üìÅ Archivo: .\app\config.py
================================================================================

import os
from pathlib import Path

class Config:
    SECRET_KEY = os.getenv("SECRET_KEY", "dev-secret-key")
    # SQLite en carpeta instance
    BASE_DIR = Path(__file__).resolve().parent.parent
    SQLALCHEMY_DATABASE_URI = f"sqlite:///{(BASE_DIR / 'instance' / 'app.db').as_posix()}"
    SQLALCHEMY_TRACK_MODIFICATIONS = False



================================================================================
üìÅ Archivo: .\app\extensions.py
================================================================================

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate
from flask_login import LoginManager
from flask_wtf.csrf import CSRFProtect

db = SQLAlchemy()
migrate = Migrate()
login_manager = LoginManager()
csrf = CSRFProtect()


================================================================================
üìÅ Archivo: .\app\models.py
================================================================================

from datetime import datetime
from werkzeug.security import generate_password_hash, check_password_hash
from flask_login import UserMixin
from .extensions import db

user_roles = db.Table(
    "user_roles",
    db.Column("user_id", db.Integer, db.ForeignKey("users.id"), primary_key=True),
    db.Column("role_id", db.Integer, db.ForeignKey("roles.id"), primary_key=True),
)

class Role(db.Model):
    __tablename__ = "roles"
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True, nullable=False)

    def __repr__(self):
        return f"<Role {self.name}>"

class User(UserMixin, db.Model):
    __tablename__ = "users"
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    full_name = db.Column(db.String(120), nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    roles = db.relationship("Role", secondary=user_roles, backref="users", lazy="joined")

    def set_password(self, raw_password):
        self.password_hash = generate_password_hash(raw_password)

    def check_password(self, raw_password):
        return check_password_hash(self.password_hash, raw_password)

    def has_role(self, name: str) -> bool:
        return any(r.name == name for r in self.roles)

    def __repr__(self):
        return f"<User {self.username}>"

# ---- Modelos vac√≠os m√≠nimos (se ampliar√°n por m√≥dulos) ----
class Documento(db.Model):
    __tablename__ = "documentos"
    id = db.Column(db.Integer, primary_key=True)
    titulo = db.Column(db.String(200), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)


class Acta(db.Model):
    __tablename__ = "actas"
    id = db.Column(db.Integer, primary_key=True)
    referencia = db.Column(db.String(100), nullable=False)

class Expediente(db.Model):
    __tablename__ = "expedientes"
    id = db.Column(db.Integer, primary_key=True)
    codigo = db.Column(db.String(100), nullable=False)

class Validacion(db.Model):
    __tablename__ = "validaciones"
    id = db.Column(db.Integer, primary_key=True)
    estado = db.Column(db.String(50), nullable=False, default="pendiente")

class Proyecto(db.Model):
    __tablename__ = "proyectos"
    id = db.Column(db.Integer, primary_key=True)
    nombre = db.Column(db.String(150), nullable=False)



================================================================================
üìÅ Archivo: .\app\models_shared.py
================================================================================

"""
models_shared.py
Centraliza tablas compartidas y auditor√≠a.
"""

from datetime import datetime
from .extensions import db



# Tabla intermedia Usuario <-> Role (una sola definici√≥n global)
user_roles = db.Table(
    "user_roles",
    db.Column("user_id", db.Integer, db.ForeignKey("usuarios.id"), primary_key=True),
    db.Column("role_id", db.Integer, db.ForeignKey("roles.id"), primary_key=True),
    extend_existing=True
)

class ActividadUsuario(db.Model):
    __tablename__ = "actividades_usuario"
    __table_args__ = {"extend_existing": True}

    id = db.Column(db.Integer, primary_key=True)
    usuario_id = db.Column(db.Integer, db.ForeignKey("usuarios.id"), nullable=False)
    accion = db.Column(db.String(100), nullable=False)
    ip = db.Column(db.String(100))
    agente = db.Column(db.String(255))
    fecha_hora = db.Column(db.DateTime, default=datetime.utcnow)
    detalles = db.Column(db.Text)

    # Relaci√≥n bidireccional limpia con Usuario
    usuario = db.relationship("Usuario", back_populates="actividades")

    def __repr__(self):
        return f"<ActividadUsuario {self.accion} - {self.usuario_id}>"

def registrar_actividad(usuario, accion, ip=None, navegador=None, detalles=None):
    if not usuario:
        return
    act = ActividadUsuario(
        usuario_id=usuario.id,
        accion=accion,
        ip=ip,
        navegador=navegador,
        detalles=detalles
    )
    db.session.add(act)
    db.session.commit()



================================================================================
üìÅ Archivo: .\app\seed.py
================================================================================

from datetime import datetime
import click
from flask.cli import with_appcontext
from app import db
from app.usuarios.models import Usuario, Role

@click.command("seed-datos-iniciales")
@with_appcontext
def seed_datos_iniciales():
    """Crea roles base y un usuario administrador inicial"""
    click.echo("‚è≥ Creando roles base...")

    roles = ["Administrador", "Administrativo", "Supervisor"]
    for nombre in roles:
        if not Role.query.filter_by(nombre=nombre).first():
            db.session.add(Role(nombre=nombre))
    db.session.commit()

    click.echo("‚úÖ Roles: Administrador, Administrativo, Supervisor")

    # Crear usuario administrador
    if not Usuario.query.filter_by(username="admin").first():
        admin = Usuario(
            username="admin",
            full_name="Administrador del Sistema",
            email="admin@bbs.edu",
            activo=True,
            sesion_activa=False,
            ultimo_login=datetime.utcnow(),
        )
        admin.set_password("admin123")

        rol_admin = Role.query.filter_by(nombre="Administrador").first()
        if rol_admin:
            admin.roles.append(rol_admin)

        db.session.add(admin)
        db.session.commit()
        click.echo("‚úÖ Usuario administrador creado: admin / admin123")
    else:
        click.echo("‚ÑπÔ∏è  El usuario administrador ya existe.")



================================================================================
üìÅ Archivo: .\app\__init__.py
================================================================================

from flask import Flask
from .config import Config
from .extensions import db, migrate, login_manager,csrf
from .usuarios.models import Usuario, Role  # modelos del m√≥dulo usuarios
from .models_shared import ActividadUsuario  # modelo compartido de actividad


def create_app():
    app = Flask(__name__, instance_relative_config=True)
    app.config.from_object(Config)

    # Extensiones
    db.init_app(app)
    migrate.init_app(app, db)
    login_manager.init_app(app)
    csrf.init_app(app)

    # üîπ login_manager debe apuntar al login del blueprint 'usuarios'
    login_manager.login_view = "usuarios.login"  # ‚úÖ Debe ser "usuarios.login"
    login_manager.login_message_category = "info"

    @login_manager.user_loader
    def load_user(user_id):
        # SQLAlchemy 2.x style
        return db.session.get(Usuario, int(user_id))

    # Blueprints
    from .core import bp as core_bp
    from .usuarios import bp as usuarios_bp
    from .documentos import bp as documentos_bp
    from .cursos import bp as cursos_bp
    from .matriculas import bp as matriculas_bp
    from .pagos import bp as pagos_bp
    from .actas_expedientes import bp as actas_bp
    from .validaciones import bp as validaciones_bp
    from .proyectos import bp as proyectos_bp
    from .estadisticas import bp as estadisticas_bp
    from .perfil import bp as perfil_bp
    from .pagos.models import Pago
    from app.estadisticas import bp as estadisticas_bp



    app.register_blueprint(core_bp)  # dashboard
    app.register_blueprint(usuarios_bp, url_prefix="/usuarios")
    app.register_blueprint(documentos_bp, url_prefix="/documentos")
    app.register_blueprint(cursos_bp, url_prefix="/cursos")
    
    app.register_blueprint(pagos_bp, url_prefix="/pagos")
    app.register_blueprint(actas_bp, url_prefix="/actas-expedientes")
    app.register_blueprint(validaciones_bp, url_prefix="/validaciones")
    app.register_blueprint(proyectos_bp, url_prefix="/proyectos")
    app.register_blueprint(estadisticas_bp, url_prefix='/estadisticas')
    app.register_blueprint(perfil_bp, url_prefix="/perfil")
    app.register_blueprint(matriculas_bp, url_prefix="/admin/matriculas")

  

    # CLI seeds
    from .seed import seed_datos_iniciales
    app.cli.add_command(seed_datos_iniciales)


    # ===== Manejo personalizado de errores =====
    # En caso de 403 (Forbidden) mostramos un mensaje amigable y redirigimos al dashboard
    @app.errorhandler(403)
    def forbidden_error(error):
        from flask import flash, redirect, url_for
        flash("No tienes permisos para acceder a este m√≥dulo.", "danger")
        return redirect(url_for("core.dashboard"))

    return app


================================================================================
üìÅ Archivo: .\app\actas_expedientes\routes.py
================================================================================

from flask import render_template
from flask_login import login_required
from . import bp

@bp.route("/")
@login_required
def index():
    return render_template("placeholder.html", title="Actas y Expedientes", message="Generacion y archivo de actas/expedientes.")



================================================================================
üìÅ Archivo: .\app\actas_expedientes\__init__.py
================================================================================

from flask import Blueprint
bp = Blueprint("actas_expedientes", __name__, template_folder="templates")
from . import routes  # noqa



================================================================================
üìÅ Archivo: .\app\core\routes.py
================================================================================

from flask import render_template, redirect, url_for
from flask_login import login_required

from . import bp

@bp.route('/')
@login_required
def index():
    """P√°gina principal del sistema - Dashboard"""
    return render_template('core/dashboard.html')

@bp.route('/dashboard')
@login_required
def dashboard():
    """
    Endpoint de compatibilidad para el dashboard.
    Redirige al endpoint principal index.
    """
    return redirect(url_for('core.index'))


================================================================================
üìÅ Archivo: .\app\core\__init__.py
================================================================================

from flask import Blueprint
bp = Blueprint("core", __name__, template_folder="templates")
from . import routes  # noqa



================================================================================
üìÅ Archivo: .\app\core\templates\core\dashboard.html
================================================================================

{% extends "base.html" %}
{% block title %}Panel Principal ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="container-fluid text-center">

    <!-- Encabezado centrado -->
    <div class="text-center my-4">
      
      <h1 class="fw-bold" style="font-family: 'Poppins', sans-serif; font-size: 2.2rem; color:#2A7B3F;">
        SISTEMA DE GESTI√ìN ESCOLAR
      </h1>
      <p class="lead mb-0" style="font-family: 'Roboto Slab', serif; color:#555;">PANEL PRINCIPAL</p>
    </div>

    <hr class="my-4">


    <!-- Grid de m√≥dulos -->
    <div class="modules-grid text-start">
      <h2 class="section-title mb-4 text-center"><i class="fas fa-th-large me-2"></i>M√≥dulos del Sistema</h2>

      <div class="row">
        {% set modulos = [
          ("Gesti√≥n de Usuarios","fa-users-cog","Administraci√≥n de usuarios y roles","usuarios.index","ACTIVO"),
          ("Documentos","fa-file-import","Gesti√≥n documental","documentos.index","ACTIVO"),
          ("Cursos","fa-book-open","Administraci√≥n acad√©mica","cursos.index","ACTIVO"),
          ("Matr√≠culas","fa-user-graduate","Inscripci√≥n de estudiantes","matriculas.index","ACTIVO"),
          ("Pagos","fa-credit-card","Control de cuotas y cobros","pagos.index","ACTIVO"),
          ("Actas y Expedientes","fa-file-contract","Gesti√≥n de actas y expedientes","actas_expedientes.index","EN DESARROLLO"),
          ("Validaciones","fa-check-double","Revisi√≥n y aprobaci√≥n","validaciones.index","ACTIVO"),
          ("Proyectos","fa-project-diagram","Gesti√≥n de proyectos acad√©micos","proyectos.index","EN DESARROLLO"),
          ("Estad√≠sticas","fa-chart-line","Indicadores y reportes","estadisticas.index","ACTIVO")
        ] %}

        {% for titulo, icono, desc, endpoint, estado in modulos %}
          <div class="col-md-4 mb-4">
            <div class="module-card shadow-sm border-0" onclick="location.href='{{ url_for(endpoint) }}'">
              <div class="d-flex align-items-center">
                <div class="module-icon me-3"><i class="fas {{ icono }}"></i></div>
                <div class="flex-grow-1">
                  <h5 class="fw-bold mb-1">{{ titulo }}</h5>
                  <p class="small text-muted mb-0">{{ desc }}</p>
                </div>
                <div>
                  <span class="badge {{ 'bg-success' if estado=='ACTIVO' else 'bg-secondary' }}">{{ estado }}</span>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\forms.py
================================================================================

from flask_wtf import FlaskForm
from wtforms import (
    StringField, TextAreaField, IntegerField, SelectField,
    FieldList, FormField, HiddenField, SubmitField, DateField
)
from wtforms.validators import DataRequired, NumberRange, Optional, Length

from .models import CURSO_TIPO_FP, CURSO_TIPO_INTENSIVO


# ---------------- SUBFORMULARIO DE M√ìDULO ----------------
class ModuloForm(FlaskForm):
    """Subformulario para agregar m√≥dulos a un curso."""
    class Meta:
        csrf = False  # üîπ Desactiva CSRF en los subformularios internos

    _row_id = HiddenField()
    nombre = StringField("Nombre del m√≥dulo", validators=[DataRequired(), Length(max=200)])
    horas_modulo = IntegerField("Horas del m√≥dulo", validators=[DataRequired(), NumberRange(min=1)])
    docente_nombre = StringField("Docente", validators=[Optional(), Length(max=200)])
    temario = TextAreaField("Temario", validators=[Optional(), Length(max=10000)])

    anio_fp = SelectField(
        "A√±o (FP)",
        choices=[("", "‚Äî"), ("1", "1¬∫"), ("2", "2¬∫")],
        validators=[Optional()]
    )
    semestre_fp = SelectField(
        "Semestre (FP)",
        choices=[("", "‚Äî"), ("1", "1¬∫"), ("2", "2¬∫")],
        validators=[Optional()]
    )

# ---------------- CREACI√ìN DE CURSO DESDE CERO ----------------
class CursoNuevoForm(FlaskForm):
    """Formulario principal para crear un curso desde cero."""
    nombre = StringField("Nombre del curso", validators=[DataRequired(), Length(max=200)])
    tipo = SelectField(
        "Tipo de curso",
        choices=[
            (CURSO_TIPO_FP, "Formaci√≥n Profesional (FP)"),
            (CURSO_TIPO_INTENSIVO, "Curso Intensivo")
        ],
        validators=[DataRequired()],
    )
    horas_totales = IntegerField("Horas totales", validators=[DataRequired(), NumberRange(min=1)])
    horas_semanales = IntegerField("Horas semanales", validators=[DataRequired(), NumberRange(min=1)])

    # Lista de m√≥dulos (al menos uno)
    modulos = FieldList(FormField(ModuloForm), min_entries=1)

    submit = SubmitField("Guardar")


# ---------------- CREACI√ìN DE CURSO DESDE PLANTILLA ----------------
class CursoDesdePlantillaForm(FlaskForm):
    """Formulario para crear un curso usando otra plantilla existente."""
    nombre = StringField("Nombre del nuevo curso", validators=[DataRequired(), Length(max=200)])
    plantilla_id = SelectField("Plantilla", coerce=int, validators=[DataRequired()])
    submit = SubmitField("Crear desde plantilla")


# ---------------- PROGRAMAR CURSO FP ----------------
class ProgramarFPForm(FlaskForm):
    anio_escolar_inicio = StringField(
        "A√±o escolar inicial (formato YYYY-YYYY)",
        validators=[DataRequired(), Length(min=9, max=9, message="Usa formato YYYY-YYYY")]
    )
    fecha_inicio_anio1 = DateField("Fecha de inicio del primer a√±o", validators=[DataRequired()])
    fecha_inicio_anio2 = DateField("Fecha de inicio del segundo a√±o", validators=[DataRequired()])
    
    guardar = SubmitField("Guardar programaci√≥n")

class CancelarCursoForm(FlaskForm):
    motivo = TextAreaField("Motivo de cancelaci√≥n", validators=[DataRequired()])
    confirmar = SubmitField("Confirmar cancelaci√≥n")

class CerrarCursoForm(FlaskForm):
    confirmar = SubmitField("Confirmar cierre")


# ---------------- PROGRAMAR CURSO INTENSIVO ----------------
class ProgramarIntensivoForm(FlaskForm):
    """Formulario para programar cursos intensivos."""
    fecha_inicio = DateField("Fecha de inicio", validators=[DataRequired()])
    submit = SubmitField("Programar curso intensivo")



================================================================================
üìÅ Archivo: .\app\cursos\models.py
================================================================================

from datetime import datetime, date, timedelta
import math
from dataclasses import dataclass
from app.extensions import db
from app.usuarios.models import Usuario

CURSO_TIPO_FP = "FP"
CURSO_TIPO_INTENSIVO = "INTENSIVO"

ESTADO_BORRADOR = "BORRADOR"
ESTADO_VALIDADO = "VALIDADO"
ESTADO_PROGRAMADO = "PROGRAMADO"

PROG_PENDIENTE = "PENDIENTE"
PROG_VALIDADA = "VALIDADA"


ESTADO_PENDIENTE_VALIDACION = "PENDIENTE_VALIDACION"  # ‚Üê Agregar si no existe
ESTADO_RECHAZADO = "RECHAZADO"  # ‚Üê Agregar si no existe

class Curso(db.Model):
    __tablename__ = "cursos"
    __table_args__ = {'extend_existing': True}  # ‚úÖ AGREGAR ESTA L√çNEA

    id = db.Column(db.Integer, primary_key=True)
    # üî¥ Antes: unique=True, index=True
    # nombre = db.Column(db.String(200), nullable=False, unique=True, index=True)

    # ‚úÖ Ahora: sin UNIQUE; mantenemos index para b√∫squedas
    nombre = db.Column(db.String(200), nullable=False, index=True)

    tipo = db.Column(db.String(20), nullable=False)  # FP | INTENSIVO
    horas_totales = db.Column(db.Integer, nullable=False)
    horas_semanales = db.Column(db.Integer, nullable=False)
    estado = db.Column(db.String(20), nullable=False, default=ESTADO_BORRADOR)
    es_plantilla = db.Column(db.Boolean, nullable=False, default=False)

    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)
    created_by_id = db.Column(db.Integer, db.ForeignKey("usuarios.id"), nullable=False)
    created_by = db.relationship(Usuario, backref="cursos_creados")

    modulos = db.relationship("Modulo", backref="curso", cascade="all, delete-orphan")
    programacion = db.relationship("Programacion", backref="curso", uselist=False, cascade="all, delete-orphan")
    def puede_editar(self) -> bool:
        return self.estado in (ESTADO_BORRADOR, ESTADO_VALIDADO)

    def puede_validar(self) -> bool:
        return self.estado == ESTADO_BORRADOR

    def puede_programar(self) -> bool:
        return self.estado == ESTADO_VALIDADO


class Modulo(db.Model):
    __tablename__ = "cursos_modulos"
    __table_args__ = {'extend_existing': True}  # ‚úÖ AGREGAR ESTA L√çNEA

    id = db.Column(db.Integer, primary_key=True)
    curso_id = db.Column(db.Integer, db.ForeignKey("cursos.id"), nullable=False)

    nombre = db.Column(db.String(200), nullable=False)
    horas_modulo = db.Column(db.Integer, nullable=False)
    docente_nombre = db.Column(db.String(200), nullable=True)
    temario = db.Column(db.Text, nullable=True)

    # Solo FP:
    anio_fp = db.Column(db.Integer, nullable=True)      # 1 | 2
    semestre_fp = db.Column(db.Integer, nullable=True)  # 1 | 2

    def es_fp(self) -> bool:
        return self.curso and self.curso.tipo == CURSO_TIPO_FP


class Programacion(db.Model):
    __tablename__ = "cursos_programaciones"
    __table_args__ = {'extend_existing': True}  # ‚úÖ AGREGAR ESTA L√çNEA

    id = db.Column(db.Integer, primary_key=True)
    curso_id = db.Column(db.Integer, db.ForeignKey("cursos.id"), nullable=False)
    tipo = db.Column(db.String(20), nullable=False)  # cache del tipo del curso

    # FP
    anio_escolar_inicio = db.Column(db.String(9), nullable=True)  # "YYYY-YYYY"
    anio_escolar_fin = db.Column(db.String(9), nullable=True)

    # Intensivo
    fecha_inicio = db.Column(db.Date, nullable=True)
    fecha_fin = db.Column(db.Date, nullable=True)

    estado_programacion = db.Column(db.String(20), nullable=False, default=PROG_PENDIENTE)
    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)

    @staticmethod
    def calcular_fin_intensivo(fecha_inicio: date, horas_totales: int, horas_semanales: int) -> date:
        # semanas = ceil(horas_totales / horas_semanales)
        semanas = max(1, math.ceil(horas_totales / max(1, horas_semanales)))
        return fecha_inicio + timedelta(weeks=semanas)



================================================================================
üìÅ Archivo: .\app\cursos\routes.py
================================================================================

from datetime import date, timedelta
from flask import render_template, request, redirect, url_for, flash, abort
from flask_login import login_required, current_user
from sqlalchemy import func
from app.extensions import db
from app.usuarios.models import Usuario
from . import bp
from .models import (
    Curso, Modulo, Programacion,
    CURSO_TIPO_FP, CURSO_TIPO_INTENSIVO,
    ESTADO_BORRADOR, ESTADO_VALIDADO, ESTADO_PROGRAMADO,
    PROG_PENDIENTE, PROG_VALIDADA,
)
from .forms import (
    CursoNuevoForm, CursoDesdePlantillaForm,
    ProgramarFPForm, ProgramarIntensivoForm, CancelarCursoForm, CerrarCursoForm
)
from flask_wtf import FlaskForm

# IMPORT ADICIONAL: modelo para borrar asignaturas ligadas a m√≥dulos
from app.matriculas.models import MatriculaAsignatura

# IMPORT PARA REGISTRO DE ACTIVIDAD
from app.models_shared import registrar_actividad

# ‚úÖ formulario vac√≠o para poder usar csrf_token() en templates
class DummyForm(FlaskForm):
    """Formulario vac√≠o solo para incluir token CSRF en vistas informativas."""
    pass
# ----------------- helpers permisos -----------------
def es_admin() -> bool:
    return any(r.nombre == "Administrador" for r in current_user.roles)

def es_administrativo() -> bool:
    return any(r.nombre == "Administrativo" for r in current_user.roles)

def puede_crear_o_editar() -> bool:
    return es_admin() or es_administrativo()


def _flash_form_errors(form):
    """Muestra mensajes de error de validaci√≥n."""
    for field, errors in form.errors.items():
        for err in errors:
            flash(f"{getattr(form, field).label.text}: {err}", "danger")


# ----------------- INDEX -----------------
@bp.route("/")
@login_required
def index():
    # ‚úÖ Traer todos los cursos, sin importar estado
    cursos_fp = (Curso.query
                 .filter(Curso.tipo == CURSO_TIPO_FP)
                 .order_by(Curso.created_at.desc())
                 .all())

    cursos_int = (Curso.query
                  .filter(Curso.tipo == CURSO_TIPO_INTENSIVO)
                  .order_by(Curso.created_at.desc())
                  .all())

    # Filtro de b√∫squeda opcional
    filtro = request.args.get("q", "").strip()
    if filtro:
        like = f"%{filtro}%"
        cursos_fp = [c for c in cursos_fp if filtro.lower() in c.nombre.lower()]
        cursos_int = [c for c in cursos_int if filtro.lower() in c.nombre.lower()]

    # ‚úÖ M√©tricas globales (no cambian)
    total_validados = Curso.query.filter(Curso.estado == ESTADO_VALIDADO).count()
    total_borrador = Curso.query.filter(Curso.estado == ESTADO_BORRADOR).count()
    total_programados = Curso.query.filter(Curso.estado == ESTADO_PROGRAMADO).count()
    total_cancelados = Curso.query.filter(Curso.estado == "CANCELADO").count()
    total_cerrados = Curso.query.filter(Curso.estado == "CERRADO").count()

    return render_template(
        "cursos/index.html",
        cursos_fp=cursos_fp,
        cursos_int=cursos_int,
        total_validados=total_validados,
        total_borrador=total_borrador,
        total_programados=total_programados,
        total_cancelados=total_cancelados,
        total_cerrados=total_cerrados
    )

# ----------------- CREAR -----------------
@bp.route("/nuevo", methods=["GET", "POST"])
@login_required
def nuevo():
    if not puede_crear_o_editar():
        abort(403)

    modo = request.args.get("modo", "vacio")  # "vacio" o "plantilla"

    # ----- desde plantilla -----
    if modo == "plantilla":
        form = CursoDesdePlantillaForm()
        plantillas = (Curso.query
                      .filter(Curso.estado == ESTADO_VALIDADO, Curso.es_plantilla.is_(True))
                      .order_by(Curso.nombre.asc())
                      .all())
        form.plantilla_id.choices = [(c.id, c.nombre) for c in plantillas]

        if request.method == "POST":
            if form.validate_on_submit():
                plantilla = db.session.get(Curso, form.plantilla_id.data)
                if not plantilla or plantilla.estado != ESTADO_VALIDADO or not plantilla.es_plantilla:
                    flash("Plantilla no v√°lida.", "danger")
                    return render_template("cursos/nuevo.html", modo=modo, form=form)

                nuevo = Curso(
                    nombre=form.nombre.data.strip(),
                    tipo=plantilla.tipo,
                    horas_totales=plantilla.horas_totales,
                    horas_semanales=plantilla.horas_semanales,
                    estado=ESTADO_BORRADOR,
                    es_plantilla=False,
                    created_by=current_user,
                )
                db.session.add(nuevo)
                db.session.flush()

                for m in plantilla.modulos:
                    db.session.add(Modulo(
                        curso_id=nuevo.id,
                        nombre=m.nombre,
                        horas_modulo=m.horas_modulo,
                        docente_nombre=m.docente_nombre,
                        temario=m.temario,
                        anio_fp=m.anio_fp,
                        semestre_fp=m.semestre_fp,
                    ))

                db.session.commit()
                # Registrar actividad de creaci√≥n de curso (opcional, seguro)
                try:
                    registrar_actividad(current_user, f"Cre√≥ curso {nuevo.nombre}")
                except Exception:
                    pass

                flash("Curso creado desde plantilla. Ahora puedes ajustarlo.", "success")
                return redirect(url_for("cursos.detalle", curso_id=nuevo.id))
            else:
                _flash_form_errors(form)

        return render_template("cursos/nuevo.html", modo=modo, form=form)

    # ----- curso en blanco -----
    form = CursoNuevoForm()

    # asegurar al menos un m√≥dulo visible al cargar el formulario
    if request.method == "GET" and not form.modulos.entries:
        form.modulos.append_entry()

    if request.method == "POST":
        if form.validate_on_submit():
            # ‚úÖ Ya NO comprobamos duplicado de nombre
            curso = Curso(
                nombre=form.nombre.data.strip(),
                tipo=form.tipo.data,
                horas_totales=form.horas_totales.data,
                horas_semanales=form.horas_semanales.data,
                estado=ESTADO_BORRADOR,
                es_plantilla=False,
                created_by=current_user,
            )
            db.session.add(curso)
            db.session.flush()

            # m√≥dulos
            for f in form.modulos.entries:
                anio_fp = int(f.anio_fp.data) if f.anio_fp.data else None
                semestre_fp = int(f.semestre_fp.data) if f.semestre_fp.data else None
                if form.tipo.data == CURSO_TIPO_INTENSIVO:
                    anio_fp = None
                    semestre_fp = None

                db.session.add(Modulo(
                    curso_id=curso.id,
                    nombre=f.nombre.data.strip(),
                    horas_modulo=f.horas_modulo.data,
                    docente_nombre=(f.docente_nombre.data or "").strip(),
                    temario=(f.temario.data or "").strip(),
                    anio_fp=anio_fp,
                    semestre_fp=semestre_fp,
                ))

            db.session.commit()
            # Registrar actividad de creaci√≥n de curso (opcional, seguro)
            try:
                registrar_actividad(current_user, f"Cre√≥ curso {curso.nombre}")
            except Exception:
                pass

            flash("Curso creado correctamente (borrador).", "success")
            return redirect(url_for("cursos.detalle", curso_id=curso.id))
        else:
            _flash_form_errors(form)

    return render_template("cursos/nuevo.html", modo="vacio", form=form)


# ----------------- DETALLE -----------------
from flask_wtf import FlaskForm

class DummyForm(FlaskForm):
    """Formulario vac√≠o solo para CSRF en acciones POST."""
    pass


@bp.route("/<int:curso_id>")
@login_required
def detalle(curso_id):
    curso = db.session.get(Curso, curso_id) or abort(404)

    # Inicializamos grupos de forma segura
    grupos = {}

    if curso.tipo == CURSO_TIPO_FP:
        grupos = {1: {1: [], 2: []}, 2: {1: [], 2: []}}
        for m in curso.modulos:
            if m.anio_fp in (1, 2) and m.semestre_fp in (1, 2):
                grupos[m.anio_fp][m.semestre_fp].append(m)

    # Para intensivos o cursos sin m√≥dulos FP, grupos se queda vac√≠o
    form = DummyForm()
    return render_template("cursos/detalle.html", curso=curso, grupos=grupos, form=form)
# ----------------- EDITAR -----------------
@bp.route("/<int:curso_id>/editar", methods=["GET", "POST"])
@login_required
def editar(curso_id):
    curso = db.session.get(Curso, curso_id) or abort(404)

    # Modificaci√≥n: permitir que tanto Administrador como Administrativo editen cursos
    if curso.estado in (ESTADO_VALIDADO, ESTADO_PROGRAMADO) and not (es_admin() or es_administrativo()):
        abort(403)

    form = CursoNuevoForm()

    if request.method == "GET":
        form.nombre.data = curso.nombre
        form.tipo.data = curso.tipo
        form.horas_totales.data = curso.horas_totales
        form.horas_semanales.data = curso.horas_semanales

        form.modulos.entries = []
        for m in curso.modulos:
            f = form.modulos.append_entry()
            f.nombre.data = m.nombre
            f.horas_modulo.data = m.horas_modulo
            f.docente_nombre.data = m.docente_nombre
            f.temario.data = m.temario
            f.anio_fp.data = m.anio_fp
            f.semestre_fp.data = m.semestre_fp

        return render_template("cursos/editar.html", form=form, curso=curso)

    if form.validate_on_submit():
        curso.nombre = form.nombre.data.strip()
        curso.tipo = form.tipo.data
        curso.horas_totales = form.horas_totales.data
        curso.horas_semanales = form.horas_semanales.data

        # ===== CAMBIO CR√çTICO (previene IntegrityError) =====
        # Borrar todas las MatriculaAsignatura que referencian a los m√≥dulos actuales
        # del curso antes de eliminar los m√≥dulos en s√≠. Esto evita que SQLAlchemy intente
        # hacer un UPDATE poniendo modulo_id = NULL y con ello romper la restricci√≥n NOT NULL.
        try:
            module_ids = [m.id for m in curso.modulos if getattr(m, "id", None) is not None]
            if module_ids:
                MatriculaAsignatura.query.filter(MatriculaAsignatura.modulo_id.in_(module_ids)).delete(synchronize_session=False)
        except Exception as e:
            # No hacemos rollback aqu√≠; registramos mensaje y seguimos ‚Äî la excepci√≥n se lanzar√° en flush si algo va mal.
            flash("Advertencia al limpiar asignaciones anteriores: " + str(e), "warning")

        # Ahora s√≠ limpiamos los m√≥dulos y a√±adimos los nuevos
        curso.modulos.clear()
        db.session.flush()

        for f in form.modulos.entries:
            anio_fp = int(f.anio_fp.data) if f.anio_fp.data else None
            semestre_fp = int(f.semestre_fp.data) if f.semestre_fp.data else None
            if curso.tipo == CURSO_TIPO_INTENSIVO:
                anio_fp = None
                semestre_fp = None

            db.session.add(Modulo(
                curso_id=curso.id,
                nombre=f.nombre.data.strip(),
                horas_modulo=f.horas_modulo.data,
                docente_nombre=(f.docente_nombre.data or "").strip(),
                temario=(f.temario.data or "").strip(),
                anio_fp=anio_fp,
                semestre_fp=semestre_fp,
            ))

        if curso.estado in (ESTADO_VALIDADO, ESTADO_PROGRAMADO):
            curso.estado = ESTADO_BORRADOR
            if curso.programacion:
                curso.programacion.estado_programacion = PROG_PENDIENTE

        db.session.commit()

        # Registrar actividad de edici√≥n del curso (audit trail)
        try:
            registrar_actividad(current_user, f"Edit√≥ curso {curso.nombre}")
        except Exception:
            # No fallamos si el logger de actividad da error
            pass

        flash("Curso actualizado correctamente.", "success")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    _flash_form_errors(form)
    return render_template("cursos/editar.html", form=form, curso=curso)


# ----------------- VALIDAR (solo admin) -----------------
@bp.route("/<int:curso_id>/validar", methods=["POST"])
@login_required
def validar(curso_id):
    if not es_admin():
        abort(403)
    curso = db.session.get(Curso, curso_id) or abort(404)
    if curso.estado != ESTADO_BORRADOR:
        flash("El curso no est√° en estado BORRADOR.", "warning")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    total_mod = sum(m.horas_modulo for m in curso.modulos)
    if total_mod != curso.horas_totales:
        flash("Atenci√≥n: la suma de horas de m√≥dulos no coincide con las horas del curso.", "warning")

    curso.estado = ESTADO_VALIDADO
    db.session.commit()
    flash("Curso validado correctamente.", "success")
    return redirect(url_for("cursos.detalle", curso_id=curso.id))


# ----------------- TOGGLE PLANTILLA -----------------
@bp.route("/<int:curso_id>/toggle-plantilla", methods=["POST"])
@login_required
def toggle_plantilla(curso_id):
    if not es_admin():
        abort(403)
    curso = db.session.get(Curso, curso_id) or abort(404)
    if curso.estado != ESTADO_VALIDADO:
        flash("Solo cursos validados pueden ser marcados como plantilla.", "warning")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))
    curso.es_plantilla = not curso.es_plantilla
    db.session.commit()
    flash(("Marcado" if curso.es_plantilla else "Desmarcado") + " como plantilla.", "success")
    return redirect(url_for("cursos.detalle", curso_id=curso.id))


# ----------------- PROGRAMAR -----------------
@bp.route("/<int:curso_id>/programar", methods=["GET", "POST"])
@login_required
def programar(curso_id):
    curso = db.session.get(Curso, curso_id) or abort(404)
    if not es_admin():
        abort(403)
    if curso.estado != ESTADO_VALIDADO:
        flash("Solo cursos validados pueden programarse.", "warning")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    if curso.tipo == CURSO_TIPO_FP:
        form = ProgramarFPForm()
        if form.validate_on_submit():
            ini = (form.anio_escolar_inicio.data or "").strip()
            # Validamos formato simple YYYY-YYYY
            try:
                y1, y2 = ini.split("-")
                y1i, y2i = int(y1), int(y2)
                if y2i != y1i + 1:  # p.ej. 2025-2026
                    raise ValueError
            except Exception:
                flash("Formato de a√±o escolar inv√°lido. Usa 'YYYY-YYYY' (ej. 2025-2026).", "danger")
                return render_template("cursos/programar.html", curso=curso, form=form)

            anio_fin = f"{y2i}-{y2i + 1}"

            prog = Programacion(
                curso=curso,
                tipo=curso.tipo,
                anio_escolar_inicio=ini,
                anio_escolar_fin=anio_fin,
                estado_programacion=PROG_PENDIENTE,  # siempre inicia pendiente
            )

            # ‚úÖ Si tu modelo ya tiene fecha_inicio_anio1/fecha_inicio_anio2, las guardamos.
            #    Si a√∫n no existen en tu tabla, esto no rompe (se ignora en flush).
            setattr(prog, "fecha_inicio_anio1", form.fecha_inicio_anio1.data)
            setattr(prog, "fecha_inicio_anio2", form.fecha_inicio_anio2.data)

            db.session.add(prog)
            db.session.commit()
            return redirect(url_for("cursos.programacion_revision", curso_id=curso.id))

        return render_template("cursos/programar.html", curso=curso, form=form)

    # Intensivo
    form = ProgramarIntensivoForm()
    if form.validate_on_submit():
        fi = form.fecha_inicio.data
        ff = Programacion.calcular_fin_intensivo(fi, curso.horas_totales, curso.horas_semanales)
        prog = Programacion(
            curso=curso,
            tipo=curso.tipo,
            fecha_inicio=fi,
            fecha_fin=ff,
            estado_programacion=PROG_PENDIENTE,
        )
        db.session.add(prog)
        db.session.commit()
        return redirect(url_for("cursos.programacion_revision", curso_id=curso.id))
    return render_template("cursos/programar.html", curso=curso, form=form)


# -------- revisi√≥n de programaci√≥n (rejilla por meses) --------
@bp.route("/<int:curso_id>/programacion/revision")
@login_required
def programacion_revision(curso_id):
    curso = db.session.get(Curso, curso_id) or abort(404)
    prog = curso.programacion or abort(404)

    semanas_por_mes = None
    if curso.tipo == CURSO_TIPO_INTENSIVO and prog.fecha_inicio and prog.fecha_fin:
        cur = prog.fecha_inicio
        semanas = []
        while cur <= prog.fecha_fin:
            inicio_sem = cur - timedelta(days=cur.weekday())
            fin_sem = inicio_sem + timedelta(days=6)
            semanas.append((inicio_sem, fin_sem))
            cur = fin_sem + timedelta(days=1)

        semanas_por_mes = {}
        for ini, fin in semanas:
            mkey = ini.strftime("%Y-%m")
            semanas_por_mes.setdefault(mkey, []).append((ini, fin))

    return render_template("cursos/programacion_revision.html",
                           curso=curso, prog=prog, semanas_por_mes=semanas_por_mes)


# -------- validar programaci√≥n --------
@bp.route("/<int:curso_id>/programacion/validar", methods=["POST"])
@login_required
def programacion_validar(curso_id):
    if not es_admin():
        abort(403)
    curso = db.session.get(Curso, curso_id) or abort(404)
    prog = curso.programacion or abort(404)

    prog.estado_programacion = PROG_VALIDADA
    curso.estado = ESTADO_PROGRAMADO
    db.session.commit()
    flash("Programaci√≥n validada correctamente.", "success")
    return redirect(url_for("cursos.detalle", curso_id=curso.id))

# --- DESPROGRAMAR ---
@bp.route("/<int:curso_id>/desprogramar", methods=["POST"])
@login_required
def desprogramar(curso_id):
    curso = Curso.query.get_or_404(curso_id)

    # ‚úÖ Comprobamos permisos usando las funciones helper definidas arriba
    if not (es_admin() or es_administrativo()):
        flash("No tienes permisos para desprogramar cursos.", "danger")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    # ‚úÖ Desprogramaci√≥n limpia y segura
    if curso.programacion:
        db.session.delete(curso.programacion)
        curso.programacion = None

    curso.estado = ESTADO_VALIDADO  # vuelve al estado anterior para permitir reprogramar
    db.session.commit()

    flash("Curso desprogramado correctamente. Puedes reprogramarlo con nuevas fechas.", "success")
    return redirect(url_for("cursos.detalle", curso_id=curso.id))

# --- CANCELAR ---
@bp.route("/<int:curso_id>/cancelar", methods=["GET", "POST"])
@login_required
def cancelar(curso_id):
    curso = Curso.query.get_or_404(curso_id)
    form = CancelarCursoForm()

    # ‚úÖ Control de permisos
    if not (es_admin() or es_administrativo()):
        flash("No tienes permisos para cancelar cursos.", "danger")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    # ‚úÖ Si el formulario se env√≠a correctamente
    if form.validate_on_submit():
        curso.estado = "CANCELADO"
        curso.motivo_cancelacion = form.motivo.data.strip()
        db.session.commit()
        flash("Curso cancelado correctamente. En espera de validaci√≥n.", "warning")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    return render_template("cursos/cancelar.html", curso=curso, form=form)


# --- CERRAR ---
@bp.route("/<int:curso_id>/cerrar", methods=["GET", "POST"])
@login_required
def cerrar(curso_id):
    curso = Curso.query.get_or_404(curso_id)
    form = CerrarCursoForm()

    # ‚úÖ Control de permisos
    if not (es_admin() or es_administrativo()):
        flash("No tienes permisos para cerrar cursos.", "danger")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    if form.validate_on_submit():
        curso.estado = "CERRADO"
        db.session.commit()
        flash("Curso cerrado exitosamente.", "success")
        return redirect(url_for("cursos.detalle", curso_id=curso.id))

    return render_template("cursos/cerrar.html", curso=curso, form=form)


@bp.route("/desde_plantilla")
@login_required
def desde_plantilla():
    """Crear un nuevo curso basado en una plantilla existente"""
    # Recuperamos las plantillas disponibles
    plantillas = Curso.query.filter_by(es_plantilla=True).all()
    return render_template("cursos/desde_plantilla.html", plantillas=plantillas)


================================================================================
üìÅ Archivo: .\app\cursos\__init__.py
================================================================================

from flask import Blueprint

bp = Blueprint("cursos", __name__, template_folder="templates")

from . import routes  # noqa: E402,F401


================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\cancelar.html
================================================================================

{% extends "base.html" %}
{% block title %}Cancelar Curso ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

  <div class="card shadow-lg border-0">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#dc3545; color:white;">
      <h4 class="mb-0"><i class="fas fa-times-circle me-2"></i>Cancelar Curso</h4>
      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <form method="POST">
      {{ form.hidden_tag() }}
      <div class="card-body">
        <h5 class="text-danger fw-bold mb-3">{{ curso.nombre }}</h5>
        <p class="text-muted">Por favor, describe brevemente el motivo de la cancelaci√≥n.</p>

        <div class="mb-3">
          {{ form.motivo.label(class="form-label fw-semibold") }}
          {{ form.motivo(class="form-control", rows="4", placeholder="Explica por qu√© el curso no podr√° realizarse...") }}
        </div>

        <div class="text-end">
          {{ form.confirmar(class="btn btn-danger px-4") }}
        </div>
      </div>
    </form>
  </div>

</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\cerrar.html
================================================================================

{% extends "base.html" %}
{% block title %}Cerrar Curso ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

  <!-- Card principal -->
  <div class="card shadow-lg border-0">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#6c757d; color:white;">
      <h4 class="mb-0"><i class="fas fa-lock me-2"></i>Cerrar Curso</h4>
      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <form method="POST">
      {{ form.hidden_tag() }}
      <div class="card-body text-center">
        <h5 class="text-secondary fw-bold mb-4">{{ curso.nombre }}</h5>

        <p class="text-muted mb-4">
          Est√°s a punto de marcar este curso como <strong>cerrado</strong>.
          <br>
          Esta acci√≥n indica que el curso ha finalizado y no podr√° ser editado ni reprogramado.
        </p>

        <div class="alert alert-warning text-start" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Importante:</strong> Esta acci√≥n debe realizarse solo una vez que el curso haya concluido por completo.
          El cierre ser√° revisado y validado por el equipo directivo.
        </div>

        <div class="d-flex justify-content-center gap-3 mt-4">
          <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-secondary px-4">
            <i class="fas fa-times me-1"></i> Cancelar
          </a>
          {{ form.confirmar(class="btn btn-dark px-4") }}
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  .card {
    border-radius: 12px;
  }
  .alert {
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
</style>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\desde_plantilla.html
================================================================================

{% extends "base.html" %}
{% block title %}Crear desde plantilla{% endblock %}

{% block content %}
<div class="container py-4">
  <h4 class="text-success"><i class="fas fa-copy me-2"></i>Crear Curso desde Plantilla</h4>
  {% if plantillas %}
    <ul class="list-group mt-3">
      {% for plantilla in plantillas %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ plantilla.nombre }}</span>
          <a href="{{ url_for('cursos.copiar_desde_plantilla', plantilla_id=plantilla.id) }}"
             class="btn btn-sm btn-outline-primary">
            <i class="fas fa-plus"></i> Crear a partir de esta
          </a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted fst-italic mt-3">No hay plantillas disponibles.</p>
  {% endif %}
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\detalle.html
================================================================================

{% extends "base.html" %}
{% block title %}Detalle del curso ‚Äî {{ curso.nombre }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm border-0">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, rgba(42,123,63,0.12), rgba(255,255,255,0));">
      <div>
        <h4 class="mb-0 fw-bold text-dark"><i class="fas fa-graduation-cap me-2 text-success"></i>{{ curso.nombre }}</h4>
        <small class="text-muted">ID: {{ curso.id }}</small>
      </div>
      <div class="text-end">
        <span class="badge bg-{{ 'warning' if curso.estado in ['BORRADOR','PENDIENTE_VALIDACION'] else ('secondary' if curso.estado=='VALIDADO' else 'dark') }} text-dark">
          {{ curso.estado }}
        </span>
        <div class="small text-muted mt-1">
          {% if curso.created_at %}Creado: {{ curso.created_at.strftime('%d/%m/%Y') }}{% endif %}
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Info general -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <dl class="row mb-0">
            <dt class="col-sm-4 text-muted">Tipo</dt>
            <dd class="col-sm-8">{{ curso.tipo }}</dd>

            <dt class="col-sm-4 text-muted">Horas totales</dt>
            <dd class="col-sm-8">{{ curso.horas_totales or curso.duracion_horas or '‚Äî' }}</dd>

            <dt class="col-sm-4 text-muted">Horas semanales</dt>
            <dd class="col-sm-8">{{ curso.horas_semanales or '‚Äî' }}</dd>

            <dt class="col-sm-4 text-muted">Plantilla</dt>
            <dd class="col-sm-8">{{ 'S√≠' if curso.es_plantilla else 'No' }}</dd>
          </dl>
        </div>

        <div class="col-lg-4">
          <div class="bg-white p-3 rounded shadow-sm h-100">
            <p class="mb-2"><strong class="text-muted">Creado por</strong></p>
            <p class="mb-1">
              {% if curso.created_by %}
                <i class="fas fa-user-circle text-secondary me-1"></i>
                {{ curso.created_by.full_name or curso.created_by.username }}
              {% else %}
                ‚Äî
              {% endif %}
            </p>
            <p class="mb-0 small text-muted">
              {% if curso.updated_at %}√öltima modificaci√≥n: {{ curso.updated_at.strftime('%d/%m/%Y %H:%M') }}{% endif %}
            </p>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <!-- M√ìDULOS -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-th-large me-2 text-success"></i>M√≥dulos</h5>
        <small class="text-muted">{{ curso.modulos|length }} m√≥dulo{{ 's' if curso.modulos|length != 1 else '' }}</small>
      </div>

      {% if grupos %}
        <!-- Vista agrupada por a√±o y semestre (FP) -->
        <div class="row g-3">
          {% for anio in [1,2] %}
            <div class="col-12">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <h6 class="mb-3 fw-semibold">A√±o {{ anio }}</h6>
                  <div class="row">
                    {% for semestre in [1,2] %}
                      <div class="col-md-6 mb-3">
                        <div class="card h-100 border-success-subtle">
                          <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                              <h6 class="card-title mb-0">Semestre {{ semestre }}</h6>
                              {% set modulos_sem = grupos.get(anio, {}).get(semestre, []) %}
                              {% if modulos_sem %}
                                <span class="badge bg-success">{{ modulos_sem|length }}</span>
                              {% endif %}
                            </div>

                            {% if modulos_sem %}
                              <ul class="list-group list-group-flush">
                                {% for m in modulos_sem %}
                                  <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-0 me-3" style="flex:1;">
                                      <div class="fw-semibold">{{ m.nombre }}</div>
                                      <div class="small text-muted">
                                        {% if m.docente_nombre %}Docente: {{ m.docente_nombre }}{% else %}Docente: ‚Äî{% endif %}
                                        {% if m.temario %}<div class="mt-1 text-truncate" style="max-width:60ch;">Temario: {{ m.temario }}</div>{% endif %}
                                      </div>
                                    </div>
                                    <div class="text-end">
                                      <span class="badge bg-outline-secondary">{{ m.horas_modulo or 0 }} h</span>
                                    </div>
                                  </li>
                                {% endfor %}
                              </ul>
                            {% else %}
                              <div class="text-muted">No hay m√≥dulos registrados en este semestre.</div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

      {% else %}
        <!-- Vista general (intensivos u otros) -->
        {% if curso.modulos and curso.modulos|length > 0 %}
          <div class="row">
            {% for m in curso.modulos %}
              <div class="col-md-6 mb-3">
                <div class="card h-100 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h6 class="fw-semibold mb-1">{{ m.nombre }}</h6>
                        <div class="small text-muted">
                          {% if m.docente_nombre %}Docente: {{ m.docente_nombre }}{% else %}Docente: ‚Äî{% endif %}
                        </div>
                      </div>
                      <div class="text-end">
                        <div class="badge bg-success mb-2">{{ m.horas_modulo or 0 }} h</div>
                        <div class="small text-muted">A√±o: {{ m.anio_fp or '‚Äî' }} ¬∑ Sem: {{ m.semestre_fp or '‚Äî' }}</div>
                      </div>
                    </div>
                    {% if m.temario %}
                      <div class="small text-muted mt-2" style="white-space:pre-wrap;">{{ m.temario }}</div>
                    {% else %}
                      <div class="text-muted small">Sin temario registrado.</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-info mb-0">No hay m√≥dulos registrados para este curso.</div>
        {% endif %}
      {% endif %}

      <hr class="my-4">

      <!-- Acciones -->
      <div class="d-flex justify-content-between align-items-center">
        <div>
          {% if curso.estado != 'CERRADO' %}
            <a href="{{ url_for('cursos.editar', curso_id=curso.id) }}" class="btn btn-success">
              <i class="fas fa-edit me-1"></i> Editar
            </a>
          {% endif %}
          <a href="{{ url_for('cursos.index') }}" class="btn btn-outline-secondary ms-2">Volver a lista</a>
        </div>

        <div class="d-flex align-items-center">
          <form method="POST" action="{{ url_for('cursos.programar', curso_id=curso.id) }}" class="me-2 d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            {% if curso.estado == 'VALIDADO' %}
              <button type="submit" class="btn btn-outline-success"><i class="fas fa-calendar-plus me-1"></i> Programar</button>
            {% endif %}
          </form>

          <a href="{{ url_for('validaciones.index') }}" class="btn btn-outline-primary">
            <i class="fas fa-check-double me-1"></i> Ir a Validaciones
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\editar.html
================================================================================

{% extends "base.html" %}
{% block title %}Editar Curso ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        <i class="fas fa-pen-to-square me-2"></i> Editar curso: {{ curso.nombre }}
      </h4>
      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}

        <!-- === Informaci√≥n b√°sica del curso === -->
        <div class="row">
          <div class="col-md-6 mb-3">
            {{ form.nombre.label(class="form-label fw-bold") }}
            {{ form.nombre(class="form-control", placeholder="Nombre del curso") }}
            {% for error in form.nombre.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-3 mb-3">
            {{ form.tipo.label(class="form-label fw-bold") }}
            {{ form.tipo(class="form-select") }}
            {% for error in form.tipo.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-3 mb-3">
            {{ form.horas_totales.label(class="form-label fw-bold") }}
            {{ form.horas_totales(class="form-control", placeholder="Horas totales") }}
            {% for error in form.horas_totales.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-3 mb-3">
            {{ form.horas_semanales.label(class="form-label fw-bold") }}
            {{ form.horas_semanales(class="form-control", placeholder="Horas semanales") }}
            {% for error in form.horas_semanales.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <hr class="my-4">

        <!-- === M√≥dulos del curso === -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="text-success fw-bold mb-0"><i class="fas fa-layer-group me-2"></i>M√≥dulos del curso</h5>
          <button type="button" class="btn btn-outline-success btn-sm" id="add-module-btn">
            <i class="fas fa-plus"></i> Agregar m√≥dulo
          </button>
        </div>

        <div id="modules-container">
          {% for subform in form.modulos %}
            <div class="module-card border rounded p-3 mb-3 bg-light">
              <div class="row">
                <div class="col-md-6 mb-3">
                  {{ subform.nombre.label(class="form-label fw-bold") }}
                  {{ subform.nombre(class="form-control", placeholder="Nombre del m√≥dulo") }}
                </div>
                <div class="col-md-3 mb-3">
                  {{ subform.horas_modulo.label(class="form-label fw-bold") }}
                  {{ subform.horas_modulo(class="form-control", placeholder="Horas del m√≥dulo") }}
                </div>
                <div class="col-md-3 mb-3">
                  {{ subform.docente_nombre.label(class="form-label fw-bold") }}
                  {{ subform.docente_nombre(class="form-control", placeholder="Docente responsable") }}
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  {{ subform.temario.label(class="form-label fw-bold") }}
                  {{ subform.temario(class="form-control", rows="2", placeholder="Temario o contenidos") }}
                </div>
                <div class="col-md-3 mb-3">
                  {{ subform.anio_fp.label(class="form-label fw-bold") }}
                  {{ subform.anio_fp(class="form-select") }}
                </div>
                <div class="col-md-3 mb-3">
                  {{ subform.semestre_fp.label(class="form-label fw-bold") }}
                  {{ subform.semestre_fp(class="form-select") }}
                </div>
              </div>

              <div class="text-end">
                <button type="button" class="btn btn-outline-danger btn-sm remove-module-btn">
                  <i class="fas fa-trash"></i> Eliminar m√≥dulo
                </button>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="text-end mt-4">
          {{ form.submit(class="btn btn-success px-5 py-2") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- === Script para a√±adir/eliminar m√≥dulos din√°micamente === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const addButton = document.getElementById('add-module-btn');
  const container = document.getElementById('modules-container');

  if (addButton) {
    addButton.addEventListener('click', () => {
      const count = container.children.length;
      const newModule = document.createElement('div');
      newModule.classList.add('module-card', 'border', 'rounded', 'p-3', 'mb-3', 'bg-light');
      newModule.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Nombre del m√≥dulo</label>
            <input class="form-control" name="modulos-${count}-nombre" required placeholder="Nombre del m√≥dulo">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">Horas del m√≥dulo</label>
            <input class="form-control" name="modulos-${count}-horas_modulo" type="number" min="1" required>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">Docente</label>
            <input class="form-control" name="modulos-${count}-docente_nombre" placeholder="Docente responsable">
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Temario</label>
            <textarea class="form-control" name="modulos-${count}-temario" rows="2"></textarea>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">A√±o (FP)</label>
            <select class="form-select" name="modulos-${count}-anio_fp">
              <option value="">‚Äî</option>
              <option value="1">1¬∫</option>
              <option value="2">2¬∫</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">Semestre (FP)</label>
            <select class="form-select" name="modulos-${count}-semestre_fp">
              <option value="">‚Äî</option>
              <option value="1">1¬∫</option>
              <option value="2">2¬∫</option>
            </select>
          </div>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-module-btn">
            <i class="fas fa-trash"></i> Eliminar m√≥dulo
          </button>
        </div>`;
      container.appendChild(newModule);
    });
  }

  container.addEventListener('click', (e) => {
    if (e.target.closest('.remove-module-btn')) {
      e.target.closest('.module-card').remove();
    }
  });
});
</script>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Gesti√≥n de Cursos ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

  <!-- DASHBOARD DE M√âTRICAS -->
  <div class="row g-3 mb-4 text-center">
    <div class="col-md-2 col-6">
      <div class="metric-card bg-success text-white p-3 rounded shadow-sm">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <h6 class="fw-bold mb-1">Validados</h6>
        <h4>{{ total_validados or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="metric-card bg-warning text-dark p-3 rounded shadow-sm">
        <i class="fas fa-hourglass-half fa-2x mb-2"></i>
        <h6 class="fw-bold mb-1">Pendientes</h6>
        <h4>{{ total_pendientes or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="metric-card bg-primary text-white p-3 rounded shadow-sm">
        <i class="fas fa-calendar-check fa-2x mb-2"></i>
        <h6 class="fw-bold mb-1">Programados</h6>
        <h4>{{ total_programados or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="metric-card bg-danger text-white p-3 rounded shadow-sm">
        <i class="fas fa-times-circle fa-2x mb-2"></i>
        <h6 class="fw-bold mb-1">Cancelados</h6>
        <h4>{{ total_cancelados or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="metric-card bg-secondary text-white p-3 rounded shadow-sm">
        <i class="fas fa-lock fa-2x mb-2"></i>
        <h6 class="fw-bold mb-1">Cerrados</h6>
        <h4>{{ total_cerrados or 0 }}</h4>
      </div>
    </div>
  </div>

  <!-- ENCABEZADO PRINCIPAL -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold text-success"><i class="fas fa-book-open me-2"></i>Gesti√≥n de Cursos</h3>
      <p class="text-muted mb-0">Panel de visualizaci√≥n y control de cursos registrados en el sistema</p>
    </div>
    <div>
      <a href="{{ url_for('cursos.nuevo') }}" class="btn btn-success me-2">
        <i class="fas fa-plus"></i> Nuevo Curso
      </a>
      <a href="{{ url_for('cursos.desde_plantilla') }}" class="btn btn-outline-success">
        <i class="fas fa-copy"></i> Desde Plantilla
      </a>
    </div>
  </div>

  <!-- LISTADO DE CURSOS -->
  <div class="accordion" id="accordionCursos">
    <!-- Formaci√≥n Profesional -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button bg-success text-white fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#fp">
          <i class="fas fa-layer-group me-2"></i> FORMACI√ìN PROFESIONAL (FP)
        </button>
      </h2>
      <div id="fp" class="accordion-collapse collapse show">
        <div class="accordion-body">
          {% if cursos_fp %}
            <div class="row g-3">
              {% for curso in cursos_fp %}
                <div class="col-md-6 col-lg-4">
                  <div class="card shadow-sm border-0 rounded-3 h-100">
                    <div class="card-body">
                      <h5 class="fw-bold text-success">{{ curso.nombre }}</h5>
                      <p class="text-muted mb-2">Estado:
                        {% if curso.estado == 'VALIDADO' %}
                          <span class="badge bg-success">VALIDADO</span>
                        {% elif curso.estado == 'BORRADOR' %}
                          <span class="badge bg-warning text-dark">BORRADOR</span>
                        {% elif curso.estado == 'PROGRAMADO' %}
                          <span class="badge bg-primary">PROGRAMADO</span>
                        {% elif curso.estado == 'CANCELADO' %}
                          <span class="badge bg-danger">CANCELADO</span>
                        {% elif curso.estado == 'CERRADO' %}
                          <span class="badge bg-secondary">CERRADO</span>
                        {% else %}
                          <span class="badge bg-light text-dark">Desconocido</span>
                        {% endif %}
                      </p>
                      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye"></i> Ver detalles
                      </a>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted fst-italic">No hay cursos FP registrados.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Cursos Intensivos -->
    <div class="accordion-item mt-3">
      <h2 class="accordion-header">
        <button class="accordion-button bg-success text-white fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#intensivos">
          <i class="fas fa-bolt me-2"></i> CURSOS INTENSIVOS
        </button>
      </h2>
      <div id="intensivos" class="accordion-collapse collapse show">
        <div class="accordion-body">
          {% if cursos_int %}
            <div class="row g-3">
              {% for curso in cursos_int %}
                <div class="col-md-6 col-lg-4">
                  <div class="card shadow-sm border-0 rounded-3 h-100">
                    <div class="card-body">
                      <h5 class="fw-bold text-success">{{ curso.nombre }}</h5>
                      <p class="text-muted mb-2">Estado:
                        {% if curso.estado == 'VALIDADO' %}
                          <span class="badge bg-success">VALIDADO</span>
                        {% elif curso.estado == 'BORRADOR' %}
                          <span class="badge bg-warning text-dark">BORRADOR</span>
                        {% elif curso.estado == 'PROGRAMADO' %}
                          <span class="badge bg-primary">PROGRAMADO</span>
                        {% elif curso.estado == 'CANCELADO' %}
                          <span class="badge bg-danger">CANCELADO</span>
                        {% elif curso.estado == 'CERRADO' %}
                          <span class="badge bg-secondary">CERRADO</span>
                        {% else %}
                          <span class="badge bg-light text-dark">Desconocido</span>
                        {% endif %}
                      </p>
                      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye"></i> Ver detalles
                      </a>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted fst-italic">No hay cursos intensivos registrados.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.metric-card {
  min-height: 130px;
  transition: all .2s ease-in-out;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.metric-card:hover {
  transform: translateY(-5px);
}
</style>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\nuevo.html
================================================================================

{% extends "base.html" %}
{% block title %}Nuevo Curso ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        <i class="fas fa-book me-2"></i>
        {% if modo == 'plantilla' %}
          Crear curso desde plantilla
        {% else %}
          Crear nuevo curso
        {% endif %}
      </h4>
      <a href="{{ url_for('cursos.index') }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}

        {% if modo == 'plantilla' %}
          <div class="mb-3">
            {{ form.nombre.label(class="form-label fw-bold") }}
            {{ form.nombre(class="form-control", placeholder="Ej: T√©cnico en Contabilidad") }}
            {% for error in form.nombre.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-3">
            {{ form.plantilla_id.label(class="form-label fw-bold") }}
            {{ form.plantilla_id(class="form-select") }}
            {% for error in form.plantilla_id.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="text-end mt-4">
            {{ form.submit(class="btn btn-success px-4") }}
          </div>

        {% else %}
          <!-- === Informaci√≥n b√°sica del curso === -->
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.nombre.label(class="form-label fw-bold") }}
              {{ form.nombre(class="form-control", placeholder="Ej: T√©cnico en Administraci√≥n y Finanzas") }}
              {% for error in form.nombre.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>

            <div class="col-md-3 mb-3">
              {{ form.tipo.label(class="form-label fw-bold") }}
              {{ form.tipo(class="form-select") }}
              {% for error in form.tipo.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>

            <div class="col-md-3 mb-3">
              {{ form.horas_totales.label(class="form-label fw-bold") }}
              {{ form.horas_totales(class="form-control", placeholder="Horas totales") }}
              {% for error in form.horas_totales.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.horas_semanales.label(class="form-label fw-bold") }}
              {{ form.horas_semanales(class="form-control", placeholder="Horas semanales") }}
              {% for error in form.horas_semanales.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>

          <hr class="my-4">

          <!-- === M√≥dulos del curso === -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="text-success fw-bold mb-0"><i class="fas fa-layer-group me-2"></i>M√≥dulos</h5>
            <button type="button" class="btn btn-outline-success btn-sm" id="add-module-btn">
              <i class="fas fa-plus"></i> Agregar m√≥dulo
            </button>
          </div>

          <div id="modules-container">
            {% for subform in form.modulos %}
              <div class="module-card border rounded p-3 mb-3 bg-light">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ subform.nombre.label(class="form-label fw-bold") }}
                    {{ subform.nombre(class="form-control", placeholder="Nombre del m√≥dulo") }}
                    {% for error in subform.nombre.errors %}
                      <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                  </div>

                  <div class="col-md-3 mb-3">
                    {{ subform.horas_modulo.label(class="form-label fw-bold") }}
                    {{ subform.horas_modulo(class="form-control", placeholder="Horas") }}
                  </div>

                  <div class="col-md-3 mb-3">
                    {{ subform.docente_nombre.label(class="form-label fw-bold") }}
                    {{ subform.docente_nombre(class="form-control", placeholder="Nombre del docente") }}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ subform.temario.label(class="form-label fw-bold") }}
                    {{ subform.temario(class="form-control", rows="2", placeholder="Temario del m√≥dulo") }}
                  </div>

                  <div class="col-md-3 mb-3">
                    {{ subform.anio_fp.label(class="form-label fw-bold") }}
                    {{ subform.anio_fp(class="form-select") }}
                  </div>

                  <div class="col-md-3 mb-3">
                    {{ subform.semestre_fp.label(class="form-label fw-bold") }}
                    {{ subform.semestre_fp(class="form-select") }}
                  </div>
                </div>

                <div class="text-end">
                  <button type="button" class="btn btn-outline-danger btn-sm remove-module-btn">
                    <i class="fas fa-trash"></i> Eliminar m√≥dulo
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="text-end mt-4">
            {{ form.submit(class="btn btn-success px-5 py-2") }}
          </div>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- === Script para a√±adir/eliminar m√≥dulos din√°micamente === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const addButton = document.getElementById('add-module-btn');
  const container = document.getElementById('modules-container');

  if (addButton) {
    addButton.addEventListener('click', () => {
      const count = container.children.length;
      const newModule = document.createElement('div');
      newModule.classList.add('module-card', 'border', 'rounded', 'p-3', 'mb-3', 'bg-light');
      newModule.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Nombre del m√≥dulo</label>
            <input class="form-control" name="modulos-${count}-nombre" required placeholder="Nombre del m√≥dulo">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">Horas del m√≥dulo</label>
            <input class="form-control" name="modulos-${count}-horas_modulo" type="number" min="1" required>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">Docente</label>
            <input class="form-control" name="modulos-${count}-docente_nombre" placeholder="Nombre del docente">
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Temario</label>
            <textarea class="form-control" name="modulos-${count}-temario" rows="2"></textarea>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">A√±o (FP)</label>
            <select class="form-select" name="modulos-${count}-anio_fp">
              <option value="">‚Äî</option>
              <option value="1">1¬∫</option>
              <option value="2">2¬∫</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-bold">Semestre (FP)</label>
            <select class="form-select" name="modulos-${count}-semestre_fp">
              <option value="">‚Äî</option>
              <option value="1">1¬∫</option>
              <option value="2">2¬∫</option>
            </select>
          </div>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-module-btn">
            <i class="fas fa-trash"></i> Eliminar m√≥dulo
          </button>
        </div>`;
      container.appendChild(newModule);
    });
  }

  container.addEventListener('click', (e) => {
    if (e.target.closest('.remove-module-btn')) {
      e.target.closest('.module-card').remove();
    }
  });
});
</script>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\programacion_revision.html
================================================================================

{% extends "base.html" %}
{% block title %}Programaci√≥n del Curso ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

  <!-- Encabezado -->
  <div class="card shadow-lg border-0 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #198754; color: white;">
      <h4 class="mb-0" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.2);">
        <i class="fas fa-calendar-alt me-2"></i> Programaci√≥n del Curso
      </h4>
      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver al curso
      </a>
    </div>

    <div class="card-body">
      <h5 class="fw-bold text-success mb-2 text-uppercase">{{ curso.nombre }}</h5>
      <p><strong>Tipo:</strong> {{ curso.tipo }}</p>

      {% if curso.tipo == "INTENSIVO" %}
        <p><strong>Duraci√≥n:</strong> {{ prog.fecha_inicio.strftime('%d/%m/%Y') }} ‚Äì {{ prog.fecha_fin.strftime('%d/%m/%Y') }}</p>
      {% else %}
        <p><strong>A√±os escolares:</strong> {{ prog.anio_escolar_inicio }} ‚Äî {{ prog.anio_escolar_fin }}</p>
      {% endif %}

      <p><strong>Estado de programaci√≥n:</strong>
        <span class="badge {% if prog.estado_programacion == 'PENDIENTE' %} bg-warning {% elif prog.estado_programacion == 'VALIDADA' %} bg-success {% else %} bg-secondary {% endif %}">
          {{ prog.estado_programacion }}
        </span>
      </p>
    </div>
  </div>

  <!-- Selector de vista -->
  <div class="text-center mb-4">
    <div class="btn-group" role="group">
      <button id="btn-calendario" class="btn btn-outline-success active">
        <i class="fas fa-th me-1"></i> Ver como calendario
      </button>
      <button id="btn-timeline" class="btn btn-outline-success">
        <i class="fas fa-stream me-1"></i> Ver como l√≠nea temporal
      </button>
    </div>
  </div>

  <!-- Calendario mensual -->
  <div id="vista-calendario" class="card shadow-sm border-0">
    <div class="card-header bg-light">
      <h5 class="mb-0 text-success"><i class="fas fa-calendar-week me-2"></i>Calendario de Semanas</h5>
    </div>
    <div class="card-body">
      {% if semanas_por_mes %}
        <div class="calendar-grid">
          {% for mes, semanas in semanas_por_mes.items() %}
            <div class="month-block shadow-sm">
              <h6 class="month-title"><i class="fas fa-calendar me-2"></i>{{ mes }}</h6>
              <div class="weeks-grid">
                {% for inicio, fin in semanas %}
                  <div class="week-card" data-bs-toggle="tooltip"
                       title="Semana {{ loop.index }}: {{ inicio.strftime('%d/%m') }} - {{ fin.strftime('%d/%m') }}">
                    <span class="week-label">S{{ loop.index }}</span>
                    <small>{{ inicio.strftime('%d/%m') }}</small>
                    <small>{{ fin.strftime('%d/%m') }}</small>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted fst-italic">No hay informaci√≥n disponible del calendario.</p>
      {% endif %}
    </div>
  </div>

  <!-- Timeline -->
  <div id="vista-timeline" class="card shadow-sm border-0 d-none">
    <div class="card-header bg-light">
      <h5 class="mb-0 text-primary"><i class="fas fa-stream me-2"></i>L√≠nea Temporal</h5>
    </div>
    <div class="card-body">
      {% if semanas_por_mes %}
        <div class="timeline-container">
          {% for mes, semanas in semanas_por_mes.items() %}
            <div class="timeline-month">
              <div class="month-title text-primary fw-bold">
                <i class="fas fa-calendar me-2"></i>{{ mes }}
              </div>

              <div class="timeline">
                {% for inicio, fin in semanas %}
                  {% set color_class = 'pending' %}
                  {% if prog.estado_programacion == 'VALIDADA' %}
                    {% set color_class = 'validated' %}
                  {% elif prog.estado_programacion == 'PROGRAMADO' %}
                    {% set color_class = 'done' %}
                  {% endif %}

                  <div class="timeline-item" data-bs-toggle="tooltip"
                       title="Semana {{ loop.index }}: {{ inicio.strftime('%d/%m') }} - {{ fin.strftime('%d/%m') }}">
                    <div class="timeline-dot {{ color_class }}"></div>
                    <div class="timeline-content">
                      <strong>Semana {{ loop.index }}</strong><br>
                      <small>{{ inicio.strftime('%d/%m') }} ‚Äì {{ fin.strftime('%d/%m') }}</small>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted fst-italic">No hay informaci√≥n disponible del calendario.</p>
      {% endif %}
    </div>
  </div>

  <!-- Validar programaci√≥n -->
  {% if current_user.roles | selectattr('nombre', 'equalto', 'Administrador') | list | length > 0 and prog.estado_programacion == 'PENDIENTE' %}
    <form method="POST" action="{{ url_for('cursos.programacion_validar', curso_id=curso.id) }}" onsubmit="return confirm('¬øDeseas validar la programaci√≥n del curso?')">
      {{ form.hidden_tag() if form is defined else '' }}
      <div class="text-end mt-4">
        <button type="submit" class="btn btn-success px-4">
          <i class="fas fa-check-double me-1"></i> Validar programaci√≥n
        </button>
      </div>
    </form>
  {% endif %}
</div>

<!-- ===== ESTILOS ===== -->
<style>
  .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
  .month-block { background: #f8f9fa; border-radius: 10px; padding: 1rem; border: 1px solid #dee2e6; transition: 0.2s; }
  .month-block:hover { transform: scale(1.02); }
  .month-title { color: #198754; font-weight: 600; border-bottom: 1px solid #cce3d3; padding-bottom: .5rem; margin-bottom: 1rem; }
  .weeks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: .8rem; }
  .week-card { background: linear-gradient(135deg, #e9f7ef, #d1f0dc); border-radius: 8px; padding: .5rem; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,.1); transition: all .2s; }
  .week-card:hover { background: linear-gradient(135deg, #c8eed3, #a8e0bb); transform: translateY(-2px); }

  .timeline-container { display: flex; flex-direction: column; gap: 3rem; }
  .timeline-month { padding: 1rem; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6; }
  .timeline { display: flex; flex-wrap: wrap; gap: 2rem 1rem; margin-top: 1.5rem; }
  .timeline-item { display: flex; flex-direction: column; align-items: center; flex: 0 0 100px; }
  .timeline-dot { width: 18px; height: 18px; border-radius: 50%; background: #ccc; margin-bottom: 0.5rem; box-shadow: 0 0 0 4px #fff, 0 0 5px rgba(0,0,0,.15); transition: all 0.3s; }
  .timeline-dot.pending { background: #ffc107; }
  .timeline-dot.validated { background: #28a745; }
  .timeline-dot.done { background: #0d6efd; }
  .timeline-dot:hover { transform: scale(1.2); }
  .timeline-content { text-align: center; font-size: 0.85rem; }

  @media (max-width: 768px) {
    .timeline { flex-direction: column; gap: 1rem; }
    .timeline-item { flex-direction: row; align-items: center; gap: 0.5rem; }
    .timeline-content { text-align: left; }
  }
</style>

<!-- ===== JS ===== -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el))

    const btnCal = document.getElementById('btn-calendario')
    const btnTl = document.getElementById('btn-timeline')
    const cal = document.getElementById('vista-calendario')
    const tl = document.getElementById('vista-timeline')

    btnCal.addEventListener('click', () => {
      btnCal.classList.add('active')
      btnTl.classList.remove('active')
      cal.classList.remove('d-none')
      tl.classList.add('d-none')
    })
    btnTl.addEventListener('click', () => {
      btnTl.classList.add('active')
      btnCal.classList.remove('active')
      tl.classList.remove('d-none')
      cal.classList.add('d-none')
    })
  })
</script>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\cursos\templates\cursos\programar.html
================================================================================

{% extends "base.html" %}
{% block title %}Programar Curso ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

  <div class="card shadow-lg border-0">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#198754; color:white;">
      <h4 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Programar Curso</h4>
      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <form method="POST">
      {{ form.hidden_tag() }}
      <div class="card-body">

        <h5 class="fw-bold text-success mb-3">{{ curso.nombre }}</h5>

        {% if curso.tipo == 'FP' %}
          <div class="row g-3">

            <div class="col-md-12">
              {{ form.anio_escolar_inicio.label(class="form-label fw-semibold") }}
              {{ form.anio_escolar_inicio(class="form-control", placeholder="Ej.: 2025-2026") }}
              <div class="form-text">Introduce el a√±o escolar inicial con formato <strong>YYYY-YYYY</strong>. El final se calcula autom√°ticamente.</div>
            </div>

            <div class="col-md-6">
              {{ form.fecha_inicio_anio1.label(class="form-label fw-semibold") }}
              {{ form.fecha_inicio_anio1(class="form-control") }}
              <div class="form-text">Seleccione la fecha de inicio del primer a√±o.</div>
            </div>
            <div class="col-md-6">
              {{ form.fecha_inicio_anio2.label(class="form-label fw-semibold") }}
              {{ form.fecha_inicio_anio2(class="form-control") }}
              <div class="form-text">Seleccione la fecha de inicio del segundo a√±o.</div>
            </div>

          </div>
        {% else %}
          <!-- Intensivo: tu form de intensivo tal cual -->
          <div class="row g-3">
            <div class="col-md-6">
              {{ form.fecha_inicio.label(class="form-label fw-semibold") }}
              {{ form.fecha_inicio(class="form-control") }}
              <div class="form-text">Fecha de inicio del curso intensivo.</div>
            </div>
          </div>
        {% endif %}

        <div class="text-end mt-4">
          <button class="btn btn-success px-4">Guardar programaci√≥n</button>
        </div>

      </div>
    </form>
  </div>

  {% if semanas_por_mes %}
  <div class="card shadow-sm border-0 mt-5">
    <div class="card-header bg-light">
      <h5 class="mb-0 text-success"><i class="fas fa-calendar-week me-2"></i>Previsualizaci√≥n del calendario</h5>
    </div>
    <div class="card-body">
      <div class="calendar-grid">
        {% for mes, semanas in semanas_por_mes.items() %}
          <div class="month-block shadow-sm">
            <h6 class="month-title">{{ mes }}</h6>
            <div class="weeks-grid">
              {% for inicio, fin in semanas %}
                <div class="week-card">
                  <strong>Semana {{ loop.index }}</strong><br>
                  <small>{{ inicio.strftime('%d/%m') }} - {{ fin.strftime('%d/%m') }}</small>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<style>
  .calendar-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; }
  .month-block { background:#f8f9fa; border-radius:10px; padding:1rem; border:1px solid #dee2e6; }
  .month-title { color:#198754; font-weight:600; margin-bottom:1rem; }
  .week-card { background:linear-gradient(135deg,#e9f7ef,#d1f0dc); border-radius:8px; padding:.6rem; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,.1); }
</style>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\documentos\forms.py
================================================================================

from flask_wtf import FlaskForm
from wtforms import StringField, TextAreaField, DateField, FileField, SubmitField
from wtforms.validators import DataRequired, Length, Optional

class EntradaForm(FlaskForm):
    numero_referencia = StringField("N¬∫ Referencia", validators=[DataRequired(), Length(max=40)])
    fecha_recepcion = DateField("Fecha de recepci√≥n", validators=[DataRequired()])
    remitente = StringField("Remitente", validators=[DataRequired(), Length(max=200)])
    descripcion = TextAreaField("Descripci√≥n", validators=[DataRequired(), Length(max=2000)])
    observaciones = TextAreaField("Observaciones", validators=[Optional(), Length(max=2000)])
    archivo = FileField("Archivo (PDF/Imagen)", validators=[DataRequired()])
    submit = SubmitField("Guardar entrada")

class SalidaForm(FlaskForm):
    numero_referencia = StringField("N¬∫ Referencia", validators=[DataRequired(), Length(max=40)])
    fecha_despacho = DateField("Fecha de despacho", validators=[DataRequired()])
    destinatario = StringField("Destinatario", validators=[DataRequired(), Length(max=200)])
    remitente_interno = StringField("Remitente interno", validators=[Optional(), Length(max=200)])
    descripcion = TextAreaField("Descripci√≥n", validators=[DataRequired(), Length(max=2000)])
    observaciones = TextAreaField("Observaciones", validators=[Optional(), Length(max=2000)])
    archivo = FileField("Archivo (PDF/Imagen)", validators=[DataRequired()])
    submit = SubmitField("Guardar salida")



================================================================================
üìÅ Archivo: .\app\documentos\models.py
================================================================================

from datetime import datetime
import os
from flask import current_app
from app.extensions import db
from app.usuarios.models import Usuario

# Tabla principal: registros de documentos (entradas/salidas) con versionado b√°sico
class Documento(db.Model):
    __tablename__ = "documentos_registros"

    id = db.Column(db.Integer, primary_key=True)
    numero_referencia = db.Column(db.String(40), nullable=False, unique=True, index=True)
    tipo = db.Column(db.String(10), nullable=False)  # 'entrada' | 'salida'
    fecha = db.Column(db.Date, nullable=False)

    # Campos de metadatos
    remitente = db.Column(db.String(200))           # usado en ENTRADA
    destinatario = db.Column(db.String(200))        # usado en SALIDA
    remitente_interno = db.Column(db.String(200))   # usado en SALIDA
    descripcion = db.Column(db.Text, nullable=False)
    observaciones = db.Column(db.Text)

    # Archivo y versionado
    filename = db.Column(db.String(255), nullable=False)   # nombre base (√∫ltima versi√≥n)
    version = db.Column(db.Integer, nullable=False, default=1)

    # Auditor√≠a
    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    created_by_id = db.Column(db.Integer, db.ForeignKey("usuarios.id"), nullable=False)
    created_by = db.relationship(Usuario, backref="documentos_creados")

    # Ruta real del archivo de la versi√≥n actual
    @property
    def file_path(self) -> str:
        updir = current_app.config.get("UPLOAD_FOLDER", os.path.join(current_app.instance_path, "uploads", "documentos"))
        return os.path.join(updir, f"{self.numero_referencia}_v{self.version}{os.path.splitext(self.filename)[1].lower()}")

    # Generaci√≥n de referencia estilo ENT-YYYYMMDD-#### / SAL-YYYYMMDD-####
    @staticmethod
    def generar_referencia(tipo: str) -> str:
        assert tipo in ("entrada", "salida")
        prefix = "ENT" if tipo == "entrada" else "SAL"
        hoy = datetime.utcnow().strftime("%Y%m%d")
        # Contar del d√≠a/tipo para un correlativo simple
        base = f"{prefix}-{hoy}-"
        sec = db.session.query(db.func.count(Documento.id)).filter(
            Documento.tipo == tipo,
            db.func.strftime('%Y%m%d', Documento.created_at) == hoy
        ).scalar() or 0
        return f"{base}{sec + 1:04d}"

    def next_version_filename(self) -> str:
        # Para versionado cuando se re-sube archivo en edici√≥n
        ext = os.path.splitext(self.filename)[1].lower()
        return f"{self.numero_referencia}_v{self.version + 1}{ext}"



================================================================================
üìÅ Archivo: .\app\documentos\routes.py
================================================================================

import os
from datetime import datetime
from flask import render_template, request, redirect, url_for, flash, current_app, send_file, abort
from flask_login import login_required, current_user
from werkzeug.utils import secure_filename
from app.extensions import db
from app.usuarios.models import Usuario
from . import bp
from .models import Documento
from .forms import EntradaForm, SalidaForm

# ====== Configuraci√≥n de subida ======
ALLOWED_EXTENSIONS = {".pdf", ".png", ".jpg", ".jpeg"}
MAX_FILE_MB = 20

def ensure_upload_dir():
    """Crea (si no existe) la carpeta de subida."""
    updir = current_app.config.get(
        "UPLOAD_FOLDER",
        os.path.join(current_app.instance_path, "uploads", "documentos")
    )
    os.makedirs(updir, exist_ok=True)
    return updir

def allowed_file(filename: str) -> bool:
    """Comprueba si la extensi√≥n es v√°lida."""
    return os.path.splitext(filename)[1].lower() in ALLOWED_EXTENSIONS


# ====== Landing del m√≥dulo: tarjetas ENTRADAS / SALIDAS / ESTAD√çSTICAS ======
@bp.route("/")
@login_required
def index():
    total_entradas = db.session.query(Documento).filter_by(tipo="entrada").count()
    total_salidas = db.session.query(Documento).filter_by(tipo="salida").count()
    return render_template(
        "documentos/index.html",
        total_entradas=total_entradas,
        total_salidas=total_salidas
    )


# ====== Listados con filtros ======
@bp.route("/entradas")
@login_required
def entradas():
    q = Documento.query.filter_by(tipo="entrada")

    # filtros
    f_ini = request.args.get("fecha_inicio")
    f_fin = request.args.get("fecha_fin")
    if f_ini:
        q = q.filter(Documento.fecha >= datetime.fromisoformat(f_ini).date())
    if f_fin:
        q = q.filter(Documento.fecha <= datetime.fromisoformat(f_fin).date())

    term = request.args.get("q", "").strip()
    if term:
        like = f"%{term}%"
        q = q.filter(
            db.or_(
                Documento.numero_referencia.ilike(like),
                Documento.remitente.ilike(like),
                Documento.descripcion.ilike(like),
                Documento.observaciones.ilike(like),
            )
        )

    docs = q.order_by(Documento.created_at.desc()).all()
    return render_template("documentos/entradas.html", docs=docs)


@bp.route("/salidas")
@login_required
def salidas():
    q = Documento.query.filter_by(tipo="salida")
    f_ini = request.args.get("fecha_inicio")
    f_fin = request.args.get("fecha_fin")
    if f_ini:
        q = q.filter(Documento.fecha >= datetime.fromisoformat(f_ini).date())
    if f_fin:
        q = q.filter(Documento.fecha <= datetime.fromisoformat(f_fin).date())

    term = request.args.get("q", "").strip()
    if term:
        like = f"%{term}%"
        q = q.filter(
            db.or_(
                Documento.numero_referencia.ilike(like),
                Documento.destinatario.ilike(like),
                Documento.remitente_interno.ilike(like),
                Documento.descripcion.ilike(like),
                Documento.observaciones.ilike(like),
            )
        )

    docs = q.order_by(Documento.created_at.desc()).all()
    return render_template("documentos/salidas.html", docs=docs)


# ====== Crear nuevo registro (entradas/salidas) ======
@bp.route("/nuevo/<string:tipo>", methods=["GET", "POST"])
@login_required
def nuevo(tipo):
    if tipo not in ("entrada", "salida"):
        abort(404)

    form = EntradaForm() if tipo == "entrada" else SalidaForm()

    # Autogenerar referencia al cargar el formulario
    if request.method == "GET":
        form.numero_referencia.data = Documento.generar_referencia(tipo)

    if form.validate_on_submit():
        file = request.files.get("archivo")
        if not file or file.filename == "":
            flash("Debes seleccionar un archivo.", "warning")
            return render_template("documentos/nuevo.html", form=form, tipo=tipo)

        filename = secure_filename(file.filename)
        if not allowed_file(filename):
            flash("Tipo de archivo no permitido. Solo PDF, JPG o PNG.", "danger")
            return render_template("documentos/nuevo.html", form=form, tipo=tipo)

        file.seek(0, os.SEEK_END)
        size_mb = file.tell() / (1024 * 1024)
        file.seek(0)
        if size_mb > MAX_FILE_MB:
            flash(f"El archivo supera {MAX_FILE_MB} MB.", "danger")
            return render_template("documentos/nuevo.html", form=form, tipo=tipo)

        # Crear registro
        doc = Documento(
            numero_referencia=form.numero_referencia.data.strip(),
            tipo=tipo,
            fecha=(form.fecha_recepcion.data if tipo == "entrada" else form.fecha_despacho.data),
            remitente=(form.remitente.data if tipo == "entrada" else None),
            destinatario=(form.destinatario.data if tipo == "salida" else None),
            remitente_interno=(form.remitente_interno.data if tipo == "salida" else None),
            descripcion=form.descripcion.data.strip(),
            observaciones=(form.observaciones.data or "").strip(),
            filename=filename,
            version=1,
            created_by=current_user,
        )
        db.session.add(doc)
        db.session.commit()

        # Guardar archivo f√≠sico
        updir = ensure_upload_dir()
        ext = os.path.splitext(filename)[1].lower()
        target = os.path.join(updir, f"{doc.numero_referencia}_v1{ext}")
        file.save(target)

        flash("Registro guardado correctamente.", "success")
        return redirect(url_for("documentos.entradas" if tipo == "entrada" else "documentos.salidas"))

    return render_template("documentos/nuevo.html", form=form, tipo=tipo)


# ====== Ver detalle ======
@bp.route("/detalle/<int:doc_id>")
@login_required
def detalle(doc_id):
    doc = db.session.get(Documento, doc_id) or abort(404)
    return render_template("documentos/detalle.html", doc=doc)


# ====== Editar ======
@bp.route("/editar/<int:doc_id>", methods=["GET", "POST"])
@login_required
def editar(doc_id):
    doc = db.session.get(Documento, doc_id) or abort(404)
    form = EntradaForm() if doc.tipo == "entrada" else SalidaForm()

    # Mapear valores al formulario
    if request.method == "GET":
        form.numero_referencia.data = doc.numero_referencia
        if doc.tipo == "entrada":
            form.fecha_recepcion.data = doc.fecha
            form.remitente.data = doc.remitente or ""
        else:
            form.fecha_despacho.data = doc.fecha
            form.destinatario.data = doc.destinatario or ""
            form.remitente_interno.data = doc.remitente_interno or ""
        form.descripcion.data = doc.descripcion
        form.observaciones.data = doc.observaciones or ""

    if form.validate_on_submit():
        file = request.files.get("archivo")
        if file and file.filename:
            filename = secure_filename(file.filename)
            if not allowed_file(filename):
                flash("Tipo de archivo no permitido.", "danger")
                return render_template("documentos/nuevo.html", form=form, tipo=doc.tipo)

            file.seek(0, os.SEEK_END)
            size_mb = file.tell() / (1024 * 1024)
            file.seek(0)
            if size_mb > MAX_FILE_MB:
                flash(f"El archivo supera {MAX_FILE_MB}MB.", "danger")
                return render_template("documentos/nuevo.html", form=form, tipo=doc.tipo)

            # Nueva versi√≥n
            doc.version += 1
            doc.filename = filename
            updir = ensure_upload_dir()
            ext = os.path.splitext(filename)[1].lower()
            target = os.path.join(updir, f"{doc.numero_referencia}_v{doc.version}{ext}")
            file.save(target)

        # Actualizar datos
        doc.fecha = form.fecha_recepcion.data if doc.tipo == "entrada" else form.fecha_despacho.data
        doc.remitente = form.remitente.data if doc.tipo == "entrada" else None
        doc.destinatario = form.destinatario.data if doc.tipo == "salida" else None
        doc.remitente_interno = form.remitente_interno.data if doc.tipo == "salida" else None
        doc.descripcion = form.descripcion.data.strip()
        doc.observaciones = (form.observaciones.data or "").strip()

        db.session.commit()
        flash("Registro actualizado correctamente.", "success")
        return redirect(url_for("documentos.detalle", doc_id=doc.id))

    return render_template("documentos/nuevo.html", form=form, tipo=doc.tipo)


# ====== Eliminar (solo admin) ======
@bp.route("/eliminar/<int:doc_id>", methods=["POST"])
@login_required
def eliminar(doc_id):
    if "Administrador" not in {r.nombre for r in current_user.roles}:
        abort(403)
    doc = db.session.get(Documento, doc_id) or abort(404)
    db.session.delete(doc)
    db.session.commit()
    flash("Registro eliminado.", "success")
    return redirect(url_for("documentos.entradas" if doc.tipo == "entrada" else "documentos.salidas"))


# ====== Visualizar/Descargar ======
@bp.route("/ver/<int:doc_id>")
@login_required
def ver_archivo(doc_id):
    doc = db.session.get(Documento, doc_id) or abort(404)
    path = doc.file_path
    if not os.path.isfile(path):
        abort(404)
    return send_file(path, as_attachment=False)


@bp.route("/descargar/<int:doc_id>")
@login_required
def descargar(doc_id):
    doc = db.session.get(Documento, doc_id) or abort(404)
    path = doc.file_path
    if not os.path.isfile(path):
        abort(404)
    return send_file(path, as_attachment=True, download_name=os.path.basename(path))


# ====== Estad√≠sticas ======
@bp.route("/estadisticas")
@login_required
def estadisticas():
    total_entradas = db.session.query(Documento).filter_by(tipo="entrada").count()
    total_salidas = db.session.query(Documento).filter_by(tipo="salida").count()
    return render_template(
        "documentos/estadisticas.html",
        total_entradas=total_entradas,
        total_salidas=total_salidas
    )



================================================================================
üìÅ Archivo: .\app\documentos\__init__.py
================================================================================

from flask import Blueprint

bp = Blueprint("documentos", __name__, template_folder="templates", static_folder="static")
from . import routes  # noqa



================================================================================
üìÅ Archivo: .\app\documentos\static\js\documentos_filtros.js
================================================================================

(function () {
  const go = (params) => {
    const url = new URL(window.__LIST_URL__, window.location.origin);
    Object.entries(params).forEach(([k, v]) => {
      if (v) url.searchParams.set(k, v); else url.searchParams.delete(k);
    });
    window.location.href = url.toString();
  };

  const f_ini = document.getElementById("f_ini");
  const f_fin = document.getElementById("f_fin");
  const term = document.getElementById("term");
  const btnF = document.getElementById("btnFiltrar");
  const btnL = document.getElementById("btnLimpiar");

  if (btnF) btnF.addEventListener("click", (e) => {
    e.preventDefault();
    go({
      fecha_inicio: f_ini && f_ini.value || "",
      fecha_fin: f_fin && f_fin.value || "",
      q: term && term.value || ""
    });
  });

  if (btnL) btnL.addEventListener("click", (e) => {
    e.preventDefault();
    go({});
  });

  // B√∫squeda al vuelo (enter)
  if (term) term.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      btnF && btnF.click();
    }
  });
})();



================================================================================
üìÅ Archivo: .\app\documentos\templates\documentos\detalle.html
================================================================================

{% extends "base.html" %}
{% block title %}Detalle de Documento{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="module-header">
    <h1><i class="fas fa-file-alt me-2"></i>Detalle del Registro</h1>
    <p class="lead">{{ doc.numero_referencia }} ‚Äî {{ doc.tipo|capitalize }}</p>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3"><strong>Fecha</strong><br>{{ doc.fecha.strftime('%Y-%m-%d') }}</div>
        <div class="col-md-3"><strong>Versi√≥n</strong><br>v{{ doc.version }}</div>
        {% if doc.tipo == 'entrada' %}
          <div class="col-md-6"><strong>Remitente</strong><br>{{ doc.remitente }}</div>
        {% else %}
          <div class="col-md-3"><strong>Destinatario</strong><br>{{ doc.destinatario }}</div>
          <div class="col-md-3"><strong>Remitente interno</strong><br>{{ doc.remitente_interno or '‚Äî' }}</div>
        {% endif %}
        <div class="col-12"><strong>Descripci√≥n</strong><br>{{ doc.descripcion }}</div>
        {% if doc.observaciones %}<div class="col-12"><strong>Observaciones</strong><br>{{ doc.observaciones }}</div>{% endif %}
      </div>
      <hr>
      <div class="d-flex gap-2">
        <a href="{{ url_for('documentos.descargar', doc_id=doc.id) }}" class="btn btn-success"><i class="fas fa-download me-2"></i>Descargar</a>
        <a href="{{ url_for('documentos.editar', doc_id=doc.id) }}" class="btn btn-primary"><i class="fas fa-edit me-2"></i>Editar</a>
        <a href="{{ url_for('documentos.entradas' if doc.tipo=='entrada' else 'documentos.salidas') }}" class="btn btn-secondary">Volver</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\documentos\templates\documentos\entradas.html
================================================================================

{% extends "base.html" %}
{% block title %}Registro de Entradas ‚Äî BBS{% endblock %}

{% block content %}
<div class="container-fluid mt-4 fade-in">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-success"><i class="fas fa-file-import me-2"></i>Registros de Entrada</h2>
    <a href="{{ url_for('documentos.nuevo', tipo='entrada') }}" class="btn btn-success">
      <i class="fas fa-plus me-1"></i> Nuevo Registro
    </a>
  </div>

  <!-- üîç Barra de b√∫squeda -->
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="Buscar por referencia, remitente o asunto...">

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle" id="tablaDocs">
          <thead class="table-success">
            <tr>
              <th>#</th>
              <th>Referencia</th>
              <th>Remitente</th>
              <th>Fecha</th>
              <th>Descripci√≥n</th>
              <th>Archivo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for d in docs %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ d.numero_referencia }}</td>
              <td>{{ d.remitente or '‚Äî' }}</td>
              <td>{{ d.fecha.strftime('%d/%m/%Y') }}</td>
              <td>{{ d.descripcion }}</td>
              <td>
                {% if d.filename %}
                  <a href="{{ url_for('documentos.ver_archivo', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-file-pdf"></i>
                  </a>
                {% else %} ‚Äî {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('documentos.detalle', doc_id=d.id) }}" class="btn btn-outline-secondary"><i class="fas fa-eye"></i></a>
                  <a href="{{ url_for('documentos.editar', doc_id=d.id) }}" class="btn btn-outline-success"><i class="fas fa-edit"></i></a>

                  {# ‚úÖ Correcci√≥n: comprobaci√≥n de rol de forma compatible con Jinja #}
                  {% set es_admin = false %}
                  {% for rol in current_user.roles %}
                    {% if rol.nombre == 'Administrador' %}
                      {% set es_admin = true %}
                    {% endif %}
                  {% endfor %}

                  {% if es_admin %}
                    <form method="POST" action="{{ url_for('documentos.eliminar', doc_id=d.id) }}" class="d-inline" onsubmit="return confirm('¬øEliminar registro?');">
                      <button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted">No hay registros de entrada</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- üîé Filtro interactivo -->
<script>
document.getElementById('searchInput').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  document.querySelectorAll('#tablaDocs tbody tr').forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
  });
});
</script>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\documentos\templates\documentos\estadisticas.html
================================================================================

{% extends "base.html" %}
{% block title %}Estad√≠sticas de Documentos{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="dashboard-header text-center mb-4">
    <h1 class="fw-bold text-success"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas de Documentos</h1>
    <p class="text-muted">Indicadores r√°pidos</p>
  </div>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h3>{{ total_entradas }}</h3>
          <p class="text-muted">Entradas</p>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h3>{{ total_salidas }}</h3>
          <p class="text-muted">Salidas</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\documentos\templates\documentos\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Documentos ‚Äî Registro Entrada/Salida{% endblock %}
{% block content %}
<div class="container-fluid py-3">

  <div class="row">
    <!-- Tarjeta Nuevo Registro -->
    <div class="col-md-6 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Nuevo Registro</h5>
        </div>
        <div class="card-body text-center">
          <p class="card-text">Crear un nuevo registro de entrada o salida de documentos</p>
          <div class="btn-group" role="group">
            <a href="{{ url_for('documentos.nuevo', tipo='entrada') }}" class="btn btn-success">
              <i class="fas fa-file-import me-2"></i>Entrada
            </a>
            <a href="{{ url_for('documentos.nuevo', tipo='salida') }}" class="btn btn-info">
              <i class="fas fa-file-export me-2"></i>Salida
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta Historial -->
    <div class="col-md-6 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historial</h5>
        </div>
        <div class="card-body text-center">
          <p class="card-text">Consultar el historial de registros de entrada y salida</p>
          <div class="btn-group" role="group">
            <a href="{{ url_for('documentos.entradas') }}" class="btn btn-outline-primary">
              <i class="fas fa-inbox me-2"></i>Entradas
            </a>
            <a href="{{ url_for('documentos.salidas') }}" class="btn btn-outline-info">
              <i class="fas fa-outbox me-2"></i>Salidas
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta Estad√≠sticas -->
    <div class="col-md-6 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-warning">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas</h5>
        </div>
        <div class="card-body text-center">
          <p class="card-text">Ver estad√≠sticas y reportes de documentos</p>
          <a href="{{ url_for('documentos.estadisticas') }}" class="btn btn-warning">
            <i class="fas fa-chart-line me-2"></i>Ver estad√≠sticas
          </a>
          <div class="row text-center mt-4">
            <div class="col-6"><h3>{{ total_entradas }}</h3><p class="text-muted">Entradas</p></div>
            <div class="col-6"><h3>{{ total_salidas }}</h3><p class="text-muted">Salidas</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\documentos\templates\documentos\nuevo.html
================================================================================

{% extends "base.html" %}
{% block title %}Nuevo Registro{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="module-header">
    <h1>
      <i class="fas fa-{% if tipo == 'entrada' %}file-import{% else %}file-export{% endif %} me-2"></i>
      Nuevo Registro de {{ 'Entrada' if tipo == 'entrada' else 'Salida' }}
    </h1>
    <p class="lead">Complete la informaci√≥n del documento</p>
  </div>

  <div class="card">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item">
          <a class="nav-link {% if tipo == 'entrada' %}active{% endif %}" href="{{ url_for('documentos.nuevo', tipo='entrada') }}">
            <i class="fas fa-file-import me-2"></i>Entrada
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if tipo == 'salida' %}active{% endif %}" href="{{ url_for('documentos.nuevo', tipo='salida') }}">
            <i class="fas fa-file-export me-2"></i>Salida
          </a>
        </li>
      </ul>
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.numero_referencia.label(class="form-label") }}
              {{ form.numero_referencia(class="form-control", readonly=true) }}
              {% for error in form.numero_referencia.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              {% if tipo == 'entrada' %}
                {{ form.fecha_recepcion.label(class="form-label") }}
                {{ form.fecha_recepcion(class="form-control", type="date") }}
                {% for error in form.fecha_recepcion.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
              {% else %}
                {{ form.fecha_despacho.label(class="form-label") }}
                {{ form.fecha_despacho(class="form-control", type="date") }}
                {% for error in form.fecha_despacho.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
              {% endif %}
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              {% if tipo == 'entrada' %}
                {{ form.remitente.label(class="form-label") }}
                {{ form.remitente(class="form-control") }}
                {% for error in form.remitente.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
              {% else %}
                {{ form.destinatario.label(class="form-label") }}
                {{ form.destinatario(class="form-control") }}
                {% for error in form.destinatario.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
              {% endif %}
            </div>
          </div>
          <div class="col-md-6">
            {% if tipo == 'salida' %}
            <div class="mb-3">
              {{ form.remitente_interno.label(class="form-label") }}
              {{ form.remitente_interno(class="form-control") }}
              {% for error in form.remitente_interno.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="mb-3">
          {{ form.descripcion.label(class="form-label") }}
          {{ form.descripcion(class="form-control", rows="3") }}
          {% for error in form.descripcion.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
        </div>

        <div class="mb-3">
          {{ form.observaciones.label(class="form-label") }}
          {{ form.observaciones(class="form-control", rows="2") }}
          {% for error in form.observaciones.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
        </div>

        <div class="mb-3">
          {{ form.archivo.label(class="form-label") }}
          {{ form.archivo(class="form-control") }}
          <div class="form-text">Se permiten PDF, JPG o PNG (m√°x. 20MB)</div>
          {% for error in form.archivo.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
        </div>

        <div class="d-flex gap-2">
          {{ form.submit(class="btn btn-success") }}
          <a href="{{ url_for('documentos.index') }}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\documentos\templates\documentos\salidas.html
================================================================================

{% extends "base.html" %}
{% block title %}Registro de Salidas ‚Äî BBS{% endblock %}

{% block content %}
<div class="container-fluid mt-4 fade-in">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-success"><i class="fas fa-file-export me-2"></i>Registros de Salida</h2>
    <a href="{{ url_for('documentos.nuevo', tipo='salida') }}" class="btn btn-success">
      <i class="fas fa-plus me-1"></i> Nuevo Registro
    </a>
  </div>

  <input type="text" id="searchInput" class="form-control mb-3" placeholder="Buscar por referencia, destinatario o asunto...">

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle" id="tablaDocs">
          <thead class="table-success">
            <tr>
              <th>#</th>
              <th>Referencia</th>
              <th>Destinatario</th>
              <th>Fecha</th>
              <th>Descripci√≥n</th>
              <th>Archivo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for d in docs %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ d.numero_referencia }}</td>
              <td>{{ d.destinatario or '‚Äî' }}</td>
              <td>{{ d.fecha.strftime('%d/%m/%Y') }}</td>
              <td>{{ d.descripcion }}</td>
              <td>
                {% if d.filename %}
                  <a href="{{ url_for('documentos.ver_archivo', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-file-pdf"></i>
                  </a>
                {% else %} ‚Äî {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('documentos.detalle', doc_id=d.id) }}" class="btn btn-outline-secondary"><i class="fas fa-eye"></i></a>
                  <a href="{{ url_for('documentos.editar', doc_id=d.id) }}" class="btn btn-outline-success"><i class="fas fa-edit"></i></a>

                  {# ‚úÖ Correcci√≥n: comprobaci√≥n de rol compatible con Jinja #}
                  {% set es_admin = false %}
                  {% for rol in current_user.roles %}
                    {% if rol.nombre == 'Administrador' %}
                      {% set es_admin = true %}
                    {% endif %}
                  {% endfor %}

                  {% if es_admin %}
                    <form method="POST" action="{{ url_for('documentos.eliminar', doc_id=d.id) }}" class="d-inline" onsubmit="return confirm('¬øEliminar registro?');">
                      <button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted">No hay registros de salida</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('searchInput').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  document.querySelectorAll('#tablaDocs tbody tr').forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
  });
});
</script>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\estadisticas\routes.py
================================================================================

from flask import render_template, flash
from flask_login import login_required, current_user
from sqlalchemy import func, and_, extract
from datetime import datetime, timedelta
from app.extensions import db

# Importar modelos necesarios
from app.matriculas.models import Matricula, ESTADO_MAT_VALIDADA, ESTADO_MAT_PENDIENTE, ESTADO_MAT_RECHAZADA
from app.cursos.models import Curso
from app.pagos.models import Pago, ESTADO_PAGO_VALIDADO, ESTADO_PAGO_PENDIENTE, ESTADO_PAGO_RECHAZADO, ESTADO_PAGO_INICIAL
from app.usuarios.models import Usuario

from . import bp

# Funciones de permisos
def es_admin():
    return any(r.nombre == "Administrador" for r in current_user.roles)

def es_supervisor():
    return any(r.nombre == "Supervisor" for r in current_user.roles)

def puede_ver_facturacion():
    return es_admin() or es_supervisor()

@bp.route('/')
@login_required
def index():
    """Dashboard principal de estad√≠sticas del sistema"""
    
    # Fecha actual y rango para m√©tricas temporales
    hoy = datetime.now().date()
    hace_30_dias = hoy - timedelta(days=30)
    hace_7_dias = hoy - timedelta(days=7)
    
    try:
        # ========== M√âTRICAS B√ÅSICAS ==========
        
        # Total de estudiantes matriculados
        total_estudiantes = Matricula.query.filter_by(estado=ESTADO_MAT_VALIDADA).count()
        
        # Estudiantes por campus
        estudiantes_bata = Matricula.query.filter_by(
            estado=ESTADO_MAT_VALIDADA, 
            campus="BATA"
        ).count()
        
        estudiantes_malabo = Matricula.query.filter_by(
            estado=ESTADO_MAT_VALIDADA, 
            campus="MALABO"
        ).count()
        
        # ========== ESTAD√çSTICAS POR CURSO ==========
        
        estudiantes_por_curso = db.session.query(
            Curso.nombre,
            func.count(Matricula.id).label('total')
        ).join(Matricula, Matricula.curso_id == Curso.id)\
         .filter(Matricula.estado == ESTADO_MAT_VALIDADA)\
         .group_by(Curso.nombre)\
         .order_by(func.count(Matricula.id).desc())\
         .all()
        
        # ========== FACTURACI√ìN (solo para admin/supervisor) ==========
        facturacion = None
        if puede_ver_facturacion():
            # Total esperado (suma de todos los costes de matr√≠culas validadas)
            total_esperado_result = db.session.query(
                func.sum(Matricula.coste_total)
            ).filter(Matricula.estado == ESTADO_MAT_VALIDADA).first()
            total_esperado = total_esperado_result[0] if total_esperado_result[0] else 0
            
            # Total pagado (pagos iniciales + cuotas validadas)
            total_pagado_result = db.session.query(
                func.sum(Pago.monto)
            ).filter(
                (Pago.estado == ESTADO_PAGO_VALIDADO) | (Pago.es_pago_inicial == True)
            ).first()
            total_pagado = total_pagado_result[0] if total_pagado_result[0] else 0
            
            # Deuda total
            deuda_total = total_esperado - total_pagado
            
            # Facturaci√≥n del √∫ltimo mes
            facturacion_mes_result = db.session.query(
                func.sum(Pago.monto)
            ).filter(
                and_(
                    (Pago.estado == ESTADO_PAGO_VALIDADO) | (Pago.es_pago_inicial == True),
                    Pago.fecha_pago >= hace_30_dias
                )
            ).first()
            facturacion_mes = facturacion_mes_result[0] if facturacion_mes_result[0] else 0
            
            facturacion = {
                'total_esperado': total_esperado,
                'total_pagado': total_pagado,
                'deuda_total': deuda_total,
                'facturacion_mes': facturacion_mes,
                'porcentaje_pagado': (total_pagado / total_esperado * 100) if total_esperado > 0 else 0
            }
        
        # ========== M√âTRICAS ADICIONALES ==========
        
        # Estado de matr√≠culas
        matriculas_pendientes = Matricula.query.filter_by(estado=ESTADO_MAT_PENDIENTE).count()
        matriculas_rechazadas = Matricula.query.filter_by(estado=ESTADO_MAT_RECHAZADA).count()
        
        # Estado de pagos
        pagos_pendientes = Pago.query.filter_by(estado=ESTADO_PAGO_PENDIENTE).count()
        pagos_rechazados = Pago.query.filter_by(estado=ESTADO_PAGO_RECHAZADO).count()
        pagos_validados = Pago.query.filter_by(estado=ESTADO_PAGO_VALIDADO).count()
        
        # Cursos activos
        cursos_activos = Curso.query.filter(
            Curso.estado.in_(['VALIDADO', 'PROGRAMADO'])
        ).count()
        
        # Nuevas matr√≠culas (√∫ltimos 7 d√≠as) - Versi√≥n compatible
        # Verificar si la tabla tiene la columna created_at
        try:
            nuevas_matriculas = Matricula.query.filter(
                Matricula.created_at >= hace_7_dias
            ).count()
        except Exception:
            # Si no existe created_at, contar todas las matr√≠culas
            nuevas_matriculas = Matricula.query.count()
        
        # Pagos pendientes de validaci√≥n
        pagos_pendientes_validacion = Pago.query.filter_by(
            estado='PENDIENTE_VALIDACION'
        ).count()
        
        # ========== M√âTRICAS DE USUARIOS ==========
        
        total_usuarios = Usuario.query.count()
        usuarios_activos = Usuario.query.filter_by(activo=True).count()
        
        # ========== M√âTRICAS TEMPORALES COMPATIBLES ==========
        # Eliminamos date_trunc que no es compatible con SQLite
        
    except Exception as e:
        flash(f"Error al cargar las estad√≠sticas: {str(e)}", "danger")
        # En caso de error, devolver valores por defecto basados en consultas simples
        total_estudiantes = Matricula.query.count()
        estudiantes_bata = Matricula.query.filter_by(campus="BATA").count()
        estudiantes_malabo = Matricula.query.filter_by(campus="MALABO").count()
        estudiantes_por_curso = []
        matriculas_pendientes = Matricula.query.filter_by(estado=ESTADO_MAT_PENDIENTE).count()
        matriculas_rechazadas = Matricula.query.filter_by(estado=ESTADO_MAT_RECHAZADA).count()
        pagos_pendientes = Pago.query.filter_by(estado=ESTADO_PAGO_PENDIENTE).count()
        pagos_rechazados = Pago.query.filter_by(estado=ESTADO_PAGO_RECHAZADO).count()
        pagos_validados = Pago.query.filter_by(estado=ESTADO_PAGO_VALIDADO).count()
        cursos_activos = Curso.query.count()
        nuevas_matriculas = Matricula.query.count()
        pagos_pendientes_validacion = Pago.query.filter_by(estado='PENDIENTE_VALIDACION').count()
        total_usuarios = Usuario.query.count()
        usuarios_activos = Usuario.query.filter_by(activo=True).count()
        facturacion = None

    return render_template(
        'estadisticas/index.html',
        # M√©tricas b√°sicas
        total_estudiantes=total_estudiantes,
        estudiantes_bata=estudiantes_bata,
        estudiantes_malabo=estudiantes_malabo,
        
        # Por curso
        estudiantes_por_curso=estudiantes_por_curso,
        
        # Facturaci√≥n
        facturacion=facturacion,
        puede_ver_facturacion=puede_ver_facturacion(),
        
        # M√©tricas adicionales
        matriculas_pendientes=matriculas_pendientes,
        matriculas_rechazadas=matriculas_rechazadas,
        pagos_pendientes=pagos_pendientes,
        pagos_rechazados=pagos_rechazados,
        pagos_validados=pagos_validados,
        cursos_activos=cursos_activos,
        nuevas_matriculas=nuevas_matriculas,
        pagos_pendientes_validacion=pagos_pendientes_validacion,
        
        # M√©tricas de usuarios
        total_usuarios=total_usuarios,
        usuarios_activos=usuarios_activos,
        
        # Fechas
        hoy=hoy,
        hace_7_dias=hace_7_dias,
        hace_30_dias=hace_30_dias
    )


================================================================================
üìÅ Archivo: .\app\estadisticas\__init__.py
================================================================================

from flask import Blueprint
bp = Blueprint("estadisticas", __name__, template_folder="templates")
from . import routes  # noqa

from app.estadisticas import routes



================================================================================
üìÅ Archivo: .\app\estadisticas\templates\estadisticas\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Estad√≠sticas ‚Äî BBS{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary"><i class="fas fa-chart-line me-2"></i>Dashboard de Estad√≠sticas</h1>
        <div class="text-muted">
            <small>Actualizado: {{ hoy.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tarjetas de Resumen Principal -->
    <div class="row mb-4">
        <!-- Total Estudiantes -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Estudiantes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_estudiantes }}</div>
                            <div class="mt-2">
                                <span class="badge bg-info">Bata: {{ estudiantes_bata }}</span>
                                <span class="badge bg-warning ms-1">Malabo: {{ estudiantes_malabo }}</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cursos Activos -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Cursos Activos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ cursos_activos }}</div>
                            <div class="mt-2 text-muted small">
                                Programados y Validados
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matr√≠culas Pendientes -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Matr√≠culas Pendientes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ matriculas_pendientes }}</div>
                            <div class="mt-2 text-muted small">
                                Esperando validaci√≥n
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagos Pendientes -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Pagos Pendientes Validaci√≥n
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pagos_pendientes_validacion }}</div>
                            <div class="mt-2 text-muted small">
                                Esperando revisi√≥n
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda Fila -->
    <div class="row mb-4">
        <!-- Distribuci√≥n por Curso -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Estudiantes por Curso</h6>
                </div>
                <div class="card-body">
                    {% if estudiantes_por_curso %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Curso</th>
                                    <th class="text-end">Estudiantes</th>
                                    <th class="text-end">Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for curso, total in estudiantes_por_curso %}
                                <tr>
                                    <td>{{ curso }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ total }}</span>
                                    </td>
                                    <td class="text-end">
                                        <small class="text-muted">
                                            {{ "%.1f"|format((total / total_estudiantes * 100) if total_estudiantes > 0 else 0) }}%
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        No hay datos de estudiantes por curso
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Facturaci√≥n (Solo Admin/Supervisor) -->
        {% if puede_ver_facturacion and facturacion %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Facturaci√≥n</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="row mb-3">
                            <div class="col-6">
                                <h5 class="text-primary">{{ "%.2f"|format(facturacion.total_esperado) }} XAF</h5>
                                <small class="text-muted">Total Esperado</small>
                            </div>
                            <div class="col-6">
                                <h5 class="text-success">{{ "%.2f"|format(facturacion.total_pagado) }} XAF</h5>
                                <small class="text-muted">Total Pagado</small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <h5 class="text-warning">{{ "%.2f"|format(facturacion.deuda_total) }} XAF</h5>
                                <small class="text-muted">Deuda Total</small>
                            </div>
                            <div class="col-6">
                                <h5 class="text-info">{{ "%.2f"|format(facturacion.facturacion_mes) }} XAF</h5>
                                <small class="text-muted">√öltimos 30 d√≠as</small>
                            </div>
                        </div>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ facturacion.porcentaje_pagado }}%"
                                 aria-valuenow="{{ facturacion.porcentaje_pagado }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ "%.1f"|format(facturacion.porcentaje_pagado) }}%
                            </div>
                        </div>
                        <small class="text-muted">Progreso de Pagos</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Tercera Fila: M√©tricas Adicionales -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>M√©tricas del Sistema</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h4 class="text-primary">{{ pagos_validados }}</h4>
                                <small class="text-muted">Pagos Validados</small>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h4 class="text-warning">{{ pagos_pendientes }}</h4>
                                <small class="text-muted">Pagos Pendientes</small>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h4 class="text-danger">{{ pagos_rechazados }}</h4>
                                <small class="text-muted">Pagos Rechazados</small>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h4 class="text-info">{{ nuevas_matriculas }}</h4>
                                <small class="text-muted">Total Matr√≠culas</small>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h4 class="text-success">{{ usuarios_activos }}</h4>
                                <small class="text-muted">Usuarios Activos</small>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h4 class="text-dark">{{ total_usuarios }}</h4>
                                <small class="text-muted">Total Usuarios</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
}
.border-left-primary { border-left: 0.25rem solid #4e73df !important; }
.border-left-success { border-left: 0.25rem solid #1cc88a !important; }
.border-left-info { border-left: 0.25rem solid #36b9cc !important; }
.border-left-warning { border-left: 0.25rem solid #f6c23e !important; }
</style>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\estadisticas\templates\estadisticas\simple.html
================================================================================

{% extends "base.html" %}
{% block title %}Estad√≠sticas ‚Äî BBS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary"><i class="fas fa-chart-line me-2"></i>Dashboard de Estad√≠sticas</h1>
        <div class="text-muted">
            <small>Actualizado: {{ hoy.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
    </div>

    <!-- Tarjetas B√°sicas -->
    <div class="row mb-4">
        <div class="col-md-3 mb-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Estudiantes</h5>
                    <h2 class="card-text">{{ total_estudiantes }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Estudiantes Bata</h5>
                    <h2 class="card-text">{{ estudiantes_bata }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Estudiantes Malabo</h5>
                    <h2 class="card-text">{{ estudiantes_malabo }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Cursos Activos</h5>
                    <h2 class="card-text">{{ cursos_activos }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n adicional simple -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">Estado de Matr√≠culas</h6>
                </div>
                <div class="card-body">
                    <p>Validadas: <strong>{{ total_estudiantes }}</strong></p>
                    <p>Pendientes: <strong>{{ matriculas_pendientes }}</strong></p>
                    <p>Rechazadas: <strong>{{ matriculas_rechazadas }}</strong></p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">Estado de Pagos</h6>
                </div>
                <div class="card-body">
                    <p>Validados: <strong>{{ pagos_validados }}</strong></p>
                    <p>Pendientes: <strong>{{ pagos_pendientes }}</strong></p>
                    <p>Rechazados: <strong>{{ pagos_rechazados }}</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\matriculas\forms.py
================================================================================

# app/matriculas/forms.py
from flask_wtf import FlaskForm
from wtforms import (
    StringField,
    SelectField,
    RadioField,
    TextAreaField,
    SubmitField,
    HiddenField,
    FloatField,
    IntegerField
)
from wtforms.validators import DataRequired, Optional, Length, NumberRange
from flask_wtf.file import FileField, FileAllowed, FileRequired

# -------------------------------------------------------------------
# OPCIONES DE CAMPUS
# -------------------------------------------------------------------
CAMPUS_CHOICES = [("BATA", "BATA"), ("MALABO", "MALABO")]

# -------------------------------------------------------------------
# FORMULARIO DE FILTROS (para la vista de lista)
# -------------------------------------------------------------------
class FiltrosTablaForm(FlaskForm):
    """Filtros para la tabla de matr√≠culas"""
    q = StringField("Buscar", validators=[Optional()])
    campus = SelectField("Campus", choices=[("", "Todos")] + CAMPUS_CHOICES, validators=[Optional()])
    estado = SelectField(
        "Estado",
        choices=[
            ("", "Todos"),
            ("PENDIENTE_VALIDACION", "Pendiente"),
            ("VALIDADA", "Validada"),
            ("RECHAZADA", "Rechazada"),
        ],
        validators=[Optional()],
    )

# -------------------------------------------------------------------
# FORMULARIO BASE DE MATR√çCULA (com√∫n para FP e Intensivo)
# -------------------------------------------------------------------
class MatriculaBaseForm(FlaskForm):
    """Formulario base de matr√≠cula (datos personales + documentos requeridos)"""

    # Datos personales
    estudiante_nombre = StringField("Nombre completo", validators=[DataRequired(), Length(max=150)])
    doc_identidad = StringField("Documento de identidad", validators=[Optional(), Length(max=64)])
    telefono = StringField("Tel√©fono", validators=[Optional(), Length(max=32)])
    email = StringField("Correo electr√≥nico", validators=[Optional(), Length(max=120)])
    direccion = StringField("Direcci√≥n", validators=[Optional(), Length(max=200)])
    campus = SelectField("Campus", choices=[("BATA", "BATA"), ("MALABO", "MALABO")], validators=[DataRequired()])

    # Coste total y n√∫mero de plazos
    coste_total = FloatField(
        "Coste total de la matr√≠cula (XAF)",
        validators=[DataRequired(), NumberRange(min=0, message="Debe ser un valor positivo")],
    )
    
    numero_plazos = IntegerField(
        "N√∫mero de plazos de pago",
        validators=[DataRequired(), NumberRange(min=1, max=24, message="Debe ser entre 1 y 24 plazos")],
        default=1
    )

    # ‚úÖ NUEVO CAMPO: Monto del pago inicial
    monto_inicial = FloatField(
        "Monto del primer pago (XAF)",
        validators=[DataRequired(), NumberRange(min=0, message="Debe ser un valor positivo")],
    )

    # Documentos requeridos
    expediente_academico = FileField(
        "Expediente Acad√©mico (PDF)",
        validators=[
            FileRequired(message="Debe adjuntar el expediente acad√©mico."),
            FileAllowed(["pdf"], "Solo se permiten archivos PDF.")
        ],
    )

    factura_primer_pago = FileField(
        "Factura del Primer Pago (PDF)",
        validators=[
            FileRequired(message="Debe adjuntar la factura del primer pago."),
            FileAllowed(["pdf"], "Solo se permiten archivos PDF.")
        ],
    )

    enviar = SubmitField("Guardar matr√≠cula")
# -------------------------------------------------------------------
# FORMULARIO FP (a√±ade campo para a√±o acad√©mico)
# -------------------------------------------------------------------
class MatriculaFPForm(MatriculaBaseForm):
    """Formulario para matr√≠culas de Formaci√≥n Profesional"""
    tipo_fp_anho = RadioField(
        "¬øA qu√© a√±o se matricula?",
        choices=[
            ("PRIMER_ANO", "Primer a√±o"),
            ("SEGUNDO_ANO", "Segundo a√±o")
        ],
        validators=[DataRequired()],
    )
    no_esta_en_lista = HiddenField()

# -------------------------------------------------------------------
# FORMULARIO INTENSIVO (hereda directamente de base)
# -------------------------------------------------------------------
class MatriculaIntensivoForm(MatriculaBaseForm):
    """Formulario para matr√≠culas de cursos intensivos"""
    pass

# -------------------------------------------------------------------
# FORMULARIOS DE VALIDACI√ìN / RECHAZO (administraci√≥n)
# -------------------------------------------------------------------
class ValidarForm(FlaskForm):
    confirmar = SubmitField("Validar matr√≠cula")

class RechazoForm(FlaskForm):
    motivo = TextAreaField(
        "Motivo del rechazo",
        validators=[DataRequired(), Length(min=5, message="Debe indicar al menos 5 caracteres.")],
    )
    rechazar = SubmitField("Rechazar matr√≠cula")


from flask_wtf import FlaskForm
from wtforms import (
    StringField, SelectField, RadioField, TextAreaField, 
    SubmitField, HiddenField, FloatField, IntegerField
)
from wtforms.validators import DataRequired, Optional, Length, NumberRange
from flask_wtf.file import FileField, FileAllowed, FileRequired

class MatriculaBaseForm(FlaskForm):
    """Formulario base de matr√≠cula (datos personales + documentos requeridos)"""

    # Datos personales
    estudiante_nombre = StringField("Nombre completo", validators=[DataRequired(), Length(max=150)])
    doc_identidad = StringField("Documento de identidad", validators=[Optional(), Length(max=64)])
    telefono = StringField("Tel√©fono", validators=[Optional(), Length(max=32)])
    email = StringField("Correo electr√≥nico", validators=[Optional(), Length(max=120)])
    direccion = StringField("Direcci√≥n", validators=[Optional(), Length(max=200)])
    campus = SelectField("Campus", choices=[("BATA", "BATA"), ("MALABO", "MALABO")], validators=[DataRequired()])

    # Coste total y n√∫mero de plazos
    coste_total = FloatField(
        "Coste total de la matr√≠cula (XAF)",
        validators=[DataRequired(), NumberRange(min=0, message="Debe ser un valor positivo")],
    )
    
    numero_plazos = IntegerField(
        "N√∫mero de plazos de pago",
        validators=[DataRequired(), NumberRange(min=1, max=24, message="Debe ser entre 1 y 24 plazos")],
        default=1
    )

    # ‚úÖ NUEVO CAMPO: Monto del pago inicial
    monto_inicial = FloatField(
        "Monto del primer pago (XAF)",
        validators=[DataRequired(), NumberRange(min=0, message="Debe ser un valor positivo")],
    )

    # Documentos requeridos
    expediente_academico = FileField(
        "Expediente Acad√©mico (PDF)",
        validators=[
            FileRequired(message="Debe adjuntar el expediente acad√©mico."),
            FileAllowed(["pdf"], "Solo se permiten archivos PDF.")
        ],
    )

    factura_primer_pago = FileField(
        "Factura del Primer Pago (PDF)",
        validators=[
            FileRequired(message="Debe adjuntar la factura del primer pago."),
            FileAllowed(["pdf"], "Solo se permiten archivos PDF.")
        ],
    )

    enviar = SubmitField("Guardar matr√≠cula")


================================================================================
üìÅ Archivo: .\app\matriculas\models.py
================================================================================

# app/matriculas/models.py
from datetime import datetime
from app.extensions import db

ESTADO_MAT_PENDIENTE = "PENDIENTE_VALIDACION"
ESTADO_MAT_VALIDADA  = "VALIDADA"
ESTADO_MAT_RECHAZADA = "RECHAZADA"

CAMPUS_BATA   = "BATA"
CAMPUS_MALABO = "MALABO"

TIPO_FP_PRIMERO = "PRIMER_ANO"
TIPO_FP_SEGUNDO = "SEGUNDO_ANO"


from datetime import datetime
from app import db


class Matricula(db.Model):
    __tablename__ = "matriculas"
    __table_args__ = {'extend_existing': True}  # ‚úÖ AGREGAR ESTA L√çNEA

    id = db.Column(db.Integer, primary_key=True)
    curso_id = db.Column(db.Integer, db.ForeignKey("cursos.id"), nullable=False)
    
    # Datos b√°sicos del alumno
    estudiante_nombre = db.Column(db.String(150), nullable=False)
    doc_identidad = db.Column(db.String(64), nullable=True, index=True)
    telefono = db.Column(db.String(32), nullable=True)
    email = db.Column(db.String(120), nullable=True)
    direccion = db.Column(db.String(200), nullable=True)

    campus = db.Column(db.String(16), nullable=False)
    tipo_fp_anho = db.Column(db.String(16), nullable=True)

    # Estado y control
    estado = db.Column(db.String(24), nullable=False, default=ESTADO_MAT_VALIDADA)
    motivo_rechazo = db.Column(db.Text, nullable=True)

    # Campos financieros
    coste_total = db.Column(db.Float, nullable=False, default=0.0)
    numero_plazos = db.Column(db.Integer, nullable=False, default=1)
    # ‚úÖ NUEVO CAMPO: Monto del pago inicial
    monto_inicial = db.Column(db.Float, nullable=False, default=0.0)

    # Auditor√≠a
    created_by_id = db.Column(db.Integer, db.ForeignKey("usuarios.id"), nullable=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)

    # Relaciones
    curso = db.relationship("Curso", backref=db.backref("matriculas", lazy="dynamic"))
    documentos = db.relationship("MatriculaDocumento", cascade="all, delete-orphan", lazy="dynamic")
    asignaturas = db.relationship("MatriculaAsignatura", back_populates="matricula", cascade="all, delete-orphan")
    pagos = db.relationship("Pago", back_populates="matricula", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<Matricula {self.estudiante_nombre} ({self.campus})>"


class MatriculaDocumento(db.Model):
    __tablename__ = "matricula_documentos"
    __table_args__ = {'extend_existing': True}  # ‚úÖ AGREGAR ESTA L√çNEA

    id = db.Column(db.Integer, primary_key=True)
    matricula_id = db.Column(db.Integer, db.ForeignKey("matriculas.id"), nullable=False)
    tipo = db.Column(db.String(50), nullable=False)  # 'EXPEDIENTE_ACADEMICO' o 'FACTURA_PRIMER_PAGO'
    filename = db.Column(db.String(200), nullable=False)
    path = db.Column(db.String(300), nullable=False)


class MatriculaAsignatura(db.Model):
    __tablename__ = "matricula_asignaturas"
    __table_args__ = {'extend_existing': True}  # ‚úÖ AGREGAR ESTA L√çNEA

    id = db.Column(db.Integer, primary_key=True)
    matricula_id = db.Column(db.Integer, db.ForeignKey("matriculas.id"), nullable=False)
    modulo_id = db.Column(db.Integer, db.ForeignKey("cursos_modulos.id", ondelete="CASCADE"), nullable=False)

    matricula = db.relationship("Matricula", back_populates="asignaturas")
    modulo = db.relationship("Modulo", backref=db.backref("matriculas_asignadas", lazy=True))

    nota = db.Column(db.Float, nullable=True)
    estado = db.Column(db.String(20), nullable=True)







================================================================================
üìÅ Archivo: .\app\matriculas\routes.py
================================================================================

# app/matriculas/routes.py
import os
import io
import zipfile
from datetime import datetime, timedelta
from flask import (
    render_template, request, redirect, url_for, flash, abort,
    current_app, send_file
)
from flask_login import login_required, current_user
from sqlalchemy import func
from app.extensions import db
from app.usuarios.models import Usuario
from app.cursos.models import Curso, Modulo, CURSO_TIPO_FP, CURSO_TIPO_INTENSIVO, ESTADO_VALIDADO, ESTADO_PROGRAMADO
from . import bp
from .models import (
    Matricula, MatriculaDocumento, MatriculaAsignatura,
    ESTADO_MAT_PENDIENTE, ESTADO_MAT_VALIDADA, ESTADO_MAT_RECHAZADA,
    TIPO_FP_PRIMERO, TIPO_FP_SEGUNDO
)
from .forms import (
    FiltrosTablaForm, MatriculaFPForm, MatriculaIntensivoForm,
    RechazoForm, ValidarForm
)

# üîπ Importaci√≥n adicional para creaci√≥n de pagos autom√°ticos
from app.pagos.models import (
    Pago,
    ESTADO_PAGO_PENDIENTE,
    ESTADO_PAGO_VALIDADO,
    ESTADO_PAGO_INICIAL,
    ESTADO_PAGO_PENDIENTE_VALIDACION
)

# ----------------- Helpers de roles y permisos -----------------
def es_admin() -> bool:
    return any(r.nombre == "Administrador" for r in current_user.roles)

def es_administrativo() -> bool:
    return any(r.nombre == "Administrativo" for r in current_user.roles)

def es_supervisor() -> bool:
    return any(r.nombre == "Supervisor" for r in current_user.roles)

def puede_editar_matricula(m: Matricula) -> bool:
    """Editable solo si est√° pendiente o rechazada, y el usuario es admin/administrativo"""
    return m.estado in (ESTADO_MAT_PENDIENTE, ESTADO_MAT_RECHAZADA) and (es_admin() or es_administrativo())

# ----------------- Funciones auxiliares -----------------
def _save_if_present(file_storage, tipo: str, matricula_id: int):
    """Guarda un archivo si est√° presente"""
    if not file_storage or file_storage.filename == "":
        return None
    upload_dir = os.path.join(current_app.config.get("UPLOAD_FOLDER", "uploads"), "matriculas")
    os.makedirs(upload_dir, exist_ok=True)
    fname = f"{matricula_id}_{tipo}_{int(datetime.utcnow().timestamp())}_{file_storage.filename}"
    path = os.path.join(upload_dir, fname)
    file_storage.save(path)
    doc = MatriculaDocumento(matricula_id=matricula_id, tipo=tipo, filename=file_storage.filename, path=path)
    db.session.add(doc)
    # retornamos la instancia (est√° en la sesi√≥n, puede no tener id hasta commit)
    return doc

def _hook_crear_expediente_pagos(m: Matricula):
    """Hook futuro para crear expediente/pagos autom√°ticamente"""
    pass

def _calcular_fechas_vencimiento(fecha_base, numero_cuota):
    """Calcular fecha de vencimiento (siempre d√≠a 10 de cada mes)"""
    from datetime import date
    
    # El primer vencimiento es el d√≠a 10 del mes siguiente
    if fecha_base.day <= 10:
        # Si es antes del d√≠a 10, el primer vencimiento es el 10 del mes actual
        primer_vencimiento = date(fecha_base.year, fecha_base.month, 10)
    else:
        # Si es despu√©s del d√≠a 10, el primer vencimiento es el 10 del mes siguiente
        if fecha_base.month == 12:
            primer_vencimiento = date(fecha_base.year + 1, 1, 10)
        else:
            primer_vencimiento = date(fecha_base.year, fecha_base.month + 1, 10)
    
    # Para cuotas subsiguientes, sumar meses
    meses_adicionales = numero_cuota - 1
    year = primer_vencimiento.year
    month = primer_vencimiento.month + meses_adicionales
    
    # Ajustar a√±o si pasa de diciembre
    while month > 12:
        month -= 12
        year += 1
    
    return date(year, month, 10)



def calcular_monto_pagado(matricula_id):
    """Calcula el monto total pagado (pago inicial + cuotas validadas)"""
    from app.pagos.models import Pago, ESTADO_PAGO_VALIDADO, ESTADO_PAGO_INICIAL
    
    pagos = Pago.query.filter_by(matricula_id=matricula_id).all()
    monto_pagado = 0
    
    for pago in pagos:
        if pago.estado == ESTADO_PAGO_VALIDADO or getattr(pago, "es_pago_inicial", False):
            monto_pagado += pago.monto
    
    return monto_pagado

def calcular_deuda_actual(matricula):
    """Calcula la deuda actual (costo total - monto pagado)"""
    monto_pagado = calcular_monto_pagado(matricula.id)
    return matricula.coste_total - monto_pagado

def redistribuir_cuotas_pendientes(matricula):
    """Redistribuye el monto de las cuotas pendientes basado en la deuda actual"""
    from app.pagos.models import Pago, ESTADO_PAGO_PENDIENTE
    
    # Obtener cuotas pendientes
    cuotas_pendientes = Pago.query.filter_by(
        matricula_id=matricula.id, 
        estado=ESTADO_PAGO_PENDIENTE
    ).order_by(Pago.numero_cuota).all()
    
    if not cuotas_pendientes:
        return
    
    # Calcular deuda actual
    deuda_actual = calcular_deuda_actual(matricula)
    
    # Recalcular monto por cuota
    nuevo_monto_cuota = round(deuda_actual / len(cuotas_pendientes), 2)
    
    # Ajustar la √∫ltima cuota por posibles diferencias de redondeo
    for i, cuota in enumerate(cuotas_pendientes):
        if i == len(cuotas_pendientes) - 1:
            # La √∫ltima cuota lleva el ajuste por redondeo
            total_asignado = nuevo_monto_cuota * (len(cuotas_pendientes) - 1)
            cuota.monto = round(deuda_actual - total_asignado, 2)
        else:
            cuota.monto = nuevo_monto_cuota
    
    db.session.commit()


# ----------------- INDEX GENERAL -----------------
@bp.route("/")
@login_required
def index():
    total = Matricula.query.count()
    total_val = Matricula.query.filter_by(estado=ESTADO_MAT_VALIDADA).count()
    total_pend = Matricula.query.filter_by(estado=ESTADO_MAT_PENDIENTE).count()
    total_rech = Matricula.query.filter_by(estado=ESTADO_MAT_RECHAZADA).count()

    cursos_visibles = (
        Curso.query.filter(Curso.estado.in_([ESTADO_VALIDADO, ESTADO_PROGRAMADO]))
        .order_by(Curso.nombre.asc())
        .all()
    )

    mats_por_curso = {}
    for m in Matricula.query.order_by(Matricula.created_at.desc()).all():
        mats_por_curso.setdefault(m.curso_id, []).append(m)

    return render_template(
        "matriculas/index.html",
        cursos=cursos_visibles,
        mats_por_curso=mats_por_curso,
        total=total,
        total_val=total_val,
        total_pend=total_pend,
        total_rech=total_rech,
    )


# ----------------- LISTA CON FILTROS -----------------
@bp.route("/lista")
@login_required
def lista():
    """Listado general de matr√≠culas con filtros"""
    search = request.args.get("search", "").strip()
    estado = request.args.get("estado", "").strip()
    campus = request.args.get("campus", "").strip()

    query = Matricula.query
    if search:
        query = query.filter(
            db.or_(
                Matricula.estudiante_nombre.ilike(f"%{search}%"),
                Matricula.doc_identidad.ilike(f"%{search}%")
            )
        )
    if estado:
        query = query.filter(Matricula.estado == estado)
    if campus:
        query = query.filter(Matricula.campus == campus)

    matriculas = query.order_by(Matricula.created_at.desc()).all()
    return render_template(
        "matriculas/lista.html",
        matriculas=matriculas,
        search=search,
        estado=estado,
        campus=campus,
    )


# ----------------- NUEVA MATR√çCULA -----------------
@bp.route("/nueva/<int:curso_id>", methods=["GET", "POST"])
@login_required
def nueva(curso_id):
    curso = db.session.get(Curso, curso_id) or abort(404)
    form = MatriculaFPForm() if curso.tipo == CURSO_TIPO_FP else MatriculaIntensivoForm()

    if request.method == "POST" and form.validate_on_submit():
        tipo_fp_val = getattr(form, "tipo_fp_anho", None)
        tipo_fp_val = tipo_fp_val.data if tipo_fp_val else None

        m = Matricula(
            curso_id=curso.id,
            estudiante_nombre=form.estudiante_nombre.data.strip(),
            doc_identidad=form.doc_identidad.data.strip() if form.doc_identidad.data else None,
            telefono=form.telefono.data.strip() if form.telefono.data else None,
            email=form.email.data.strip() if form.email.data else None,
            direccion=form.direccion.data.strip() if form.direccion.data else None,
            campus=form.campus.data,
            tipo_fp_anho=tipo_fp_val,
            estado=ESTADO_MAT_VALIDADA,  # ‚úÖ Cambiado a VALIDADA
            coste_total=form.coste_total.data,
            numero_plazos=form.numero_plazos.data,  # ‚úÖ Agregado
            monto_inicial=form.monto_inicial.data,  # ‚úÖ Guardar monto inicial
            created_by_id=current_user.id
        )
        db.session.add(m)
        db.session.flush()

        # Guardar documentos requeridos (ahora retornan la instancia doc si se sube)
        doc_expediente = _save_if_present(form.expediente_academico.data, "expediente_academico", m.id)
        doc_factura = _save_if_present(form.factura_primer_pago.data, "factura_primer_pago", m.id)

        # Asignaci√≥n autom√°tica de m√≥dulos para FP
        if curso.tipo == CURSO_TIPO_FP:
            mod_anio1 = Modulo.query.filter_by(curso_id=curso.id, anio_fp=1).all()
            mod_anio2 = Modulo.query.filter_by(curso_id=curso.id, anio_fp=2).all()

            if tipo_fp_val == "PRIMER_ANO":
                for mo in mod_anio1:
                    db.session.add(MatriculaAsignatura(matricula_id=m.id, modulo_id=mo.id))
            elif tipo_fp_val == "SEGUNDO_ANO":
                for mo in mod_anio2:
                    db.session.add(MatriculaAsignatura(matricula_id=m.id, modulo_id=mo.id))

        # üîπ CREAR CALENDARIO DE PAGOS MEJORADO
        # 1. Pago inicial (marcado como pendiente de validaci√≥n)
        pago_inicial = Pago(
            matricula_id=m.id,
            numero_cuota=0,  # Cuota especial para pago inicial
            monto=form.monto_inicial.data,
            estado=ESTADO_PAGO_PENDIENTE_VALIDACION,  # marcar para validaci√≥n
            es_pago_inicial=True,
            monto_inicial=form.monto_inicial.data,
            fecha_vencimiento=None,
            fecha_pago=getattr(m, "created_at", None)
        )
        # intentar marcar origen si existe
        try:
            if hasattr(pago_inicial, "origen"):
                pago_inicial.origen = "MATRICULA"
        except Exception:
            pass

        db.session.add(pago_inicial)

        # Vincular doc_factura con el pago inicial si subieron factura
        try:
            if doc_factura is None:
                # intentar buscarlo en sesi√≥n/DB por si _save_if_present no devolvi√≥
                doc_factura = MatriculaDocumento.query.filter_by(matricula_id=m.id, tipo="factura_primer_pago").order_by(MatriculaDocumento.id.desc()).first()
            if doc_factura is not None:
                # probar distintas propiedades posibles en Pago
                if hasattr(pago_inicial, "documento_id"):
                    pago_inicial.documento_id = getattr(doc_factura, "id", None)
                elif hasattr(pago_inicial, "comprobante_id"):
                    pago_inicial.comprobante_id = getattr(doc_factura, "id", None)
                elif hasattr(pago_inicial, "documento_path"):
                    pago_inicial.documento_path = getattr(doc_factura, "path", None)
                elif hasattr(pago_inicial, "filename"):
                    # no ideal, pero al menos dejamos referencia
                    pago_inicial.filename = getattr(doc_factura, "filename", None)
        except Exception:
            # no rompemos el flujo si no es posible vincular
            pass

        # 2. Calcular monto restante y crear cuotas normales
        monto_restante = (m.coste_total or 0) - (form.monto_inicial.data or 0)
        if m.numero_plazos and m.numero_plazos > 1:
            cuota_normal = monto_restante / (m.numero_plazos - 1)
            
            for i in range(1, m.numero_plazos):
                pago = Pago(
                    matricula_id=m.id,
                    numero_cuota=i,
                    monto=round(cuota_normal, 2),
                    estado=ESTADO_PAGO_PENDIENTE,
                    fecha_vencimiento=_calcular_fechas_vencimiento(getattr(m, "created_at", datetime.utcnow().date()), i)
                )
                db.session.add(pago)

        db.session.commit()
        flash("‚úÖ Matr√≠cula creada correctamente con calendario de pagos.", "success")
        return redirect(url_for("matriculas.detalle", matricula_id=m.id))

    mod_anio1 = mod_anio2 = []
    if curso.tipo == CURSO_TIPO_FP:
        mod_anio1 = Modulo.query.filter_by(curso_id=curso.id, anio_fp=1).order_by(Modulo.nombre).all()
        mod_anio2 = Modulo.query.filter_by(curso_id=curso.id, anio_fp=2).order_by(Modulo.nombre).all()

    return render_template("matriculas/nueva.html", curso=curso, form=form,
                           mod_anio1=mod_anio1, mod_anio2=mod_anio2)


# ----------------- DETALLE -----------------
@bp.route("/<int:matricula_id>")
@login_required
def detalle(matricula_id):
    # Recuperar la matr√≠cula
    # Intentamos usar query normal y luego forzar .all() en relaciones din√°micas
    m = db.session.get(Matricula, matricula_id) or abort(404)

    # Convertir relaciones din√°micas (AppenderQuery) a listas para uso en plantillas
    # Esto evita errores de Jinja al usar |length o len() sobre AppenderQuery.
    try:
        if hasattr(m, "documentos") and hasattr(m.documentos, "all"):
            m.documentos = m.documentos.all()
    except Exception:
        # no rompemos la vista por un fallo en la conversi√≥n
        pass

    try:
        if hasattr(m, "pagos") and hasattr(m.pagos, "all"):
            m.pagos = m.pagos.all()
    except Exception:
        pass

    try:
        if hasattr(m, "asignaturas") and hasattr(m.asignaturas, "all"):
            m.asignaturas = m.asignaturas.all()
    except Exception:
        pass

    return render_template("matriculas/detalle.html", m=m)


# ----------------- EDITAR -----------------
@bp.route("/<int:matricula_id>/editar", methods=["GET", "POST"])
@login_required
def editar(matricula_id):
    m = db.session.get(Matricula, matricula_id) or abort(404)
    if not puede_editar_matricula(m):
        abort(403)

    curso = m.curso
    form = MatriculaFPForm() if curso.tipo == CURSO_TIPO_FP else MatriculaIntensivoForm()

    if request.method == "GET":
        form.estudiante_nombre.data = m.estudiante_nombre
        form.doc_identidad.data = m.doc_identidad
        form.telefono.data = m.telefono
        form.email.data = m.email
        form.direccion.data = m.direccion
        form.campus.data = m.campus
        form.coste_total.data = m.coste_total
        form.numero_plazos.data = m.numero_plazos
        form.monto_inicial.data = m.monto_inicial  # ‚úÖ Agregar monto inicial en edici√≥n
        if curso.tipo == CURSO_TIPO_FP:
            form.tipo_fp_anho.data = m.tipo_fp_anho

        return render_template("matriculas/nueva.html", curso=curso, form=form, edit_mode=True, m=m)

    if form.validate_on_submit():
        m.estudiante_nombre = form.estudiante_nombre.data.strip()
        m.doc_identidad = form.doc_identidad.data.strip() if form.doc_identidad.data else None
        m.telefono = form.telefono.data.strip() if form.telefono.data else None
        m.email = form.email.data.strip() if form.email.data else None
        m.direccion = form.direccion.data.strip() if form.direccion.data else None
        m.campus = form.campus.data
        m.coste_total = form.coste_total.data
        m.numero_plazos = form.numero_plazos.data
        m.monto_inicial = form.monto_inicial.data  # ‚úÖ Actualizar monto inicial

        if m.estado == ESTADO_MAT_RECHAZADA:
            m.estado = ESTADO_MAT_PENDIENTE
            m.motivo_rechazo = None

        doc_expediente = _save_if_present(form.expediente_academico.data, "expediente_academico", m.id)
        doc_factura = _save_if_present(form.factura_primer_pago.data, "factura_primer_pago", m.id)

        # üîπ ACTUALIZAR CALENDARIO DE PAGOS AL EDITAR
        # Eliminar pagos existentes y recrearlos
        Pago.query.filter_by(matricula_id=m.id).delete()
        
        # Crear nuevo pago inicial (marcado para validaci√≥n)
        pago_inicial = Pago(
            matricula_id=m.id,
            numero_cuota=0,
            monto=form.monto_inicial.data,
            estado=ESTADO_PAGO_PENDIENTE_VALIDACION,
            es_pago_inicial=True,
            monto_inicial=form.monto_inicial.data,
            fecha_vencimiento=None,
            fecha_pago=getattr(m, "created_at", None)
        )
        try:
            if hasattr(pago_inicial, "origen"):
                pago_inicial.origen = "MATRICULA"
        except Exception:
            pass

        db.session.add(pago_inicial)

        # Vincular doc_factura con el pago inicial si subieron factura
        try:
            if doc_factura is None:
                doc_factura = MatriculaDocumento.query.filter_by(matricula_id=m.id, tipo="factura_primer_pago").order_by(MatriculaDocumento.id.desc()).first()
            if doc_factura is not None:
                if hasattr(pago_inicial, "documento_id"):
                    pago_inicial.documento_id = getattr(doc_factura, "id", None)
                elif hasattr(pago_inicial, "comprobante_id"):
                    pago_inicial.comprobante_id = getattr(doc_factura, "id", None)
                elif hasattr(pago_inicial, "documento_path"):
                    pago_inicial.documento_path = getattr(doc_factura, "path", None)
                elif hasattr(pago_inicial, "filename"):
                    pago_inicial.filename = getattr(doc_factura, "filename", None)
        except Exception:
            pass

        # Recrear cuotas normales
        monto_restante = (m.coste_total or 0) - (form.monto_inicial.data or 0)
        if m.numero_plazos and m.numero_plazos > 1:
            cuota_normal = monto_restante / (m.numero_plazos - 1)
            
            for i in range(1, m.numero_plazos):
                pago = Pago(
                    matricula_id=m.id,
                    numero_cuota=i,
                    monto=round(cuota_normal, 2),
                    estado=ESTADO_PAGO_PENDIENTE,
                    fecha_vencimiento=_calcular_fechas_vencimiento(getattr(m, "created_at", datetime.utcnow().date()), i)
                )
                db.session.add(pago)

        db.session.commit()
        flash("‚úÖ Matr√≠cula actualizada correctamente con nuevo calendario de pagos.", "success")
        return redirect(url_for("matriculas.detalle", matricula_id=m.id))

    return redirect(url_for("matriculas.detalle", matricula_id=m.id))


# ----------------- ELIMINAR (solo admin) -----------------
@bp.route("/<int:matricula_id>/eliminar", methods=["POST"])
@login_required
def eliminar(matricula_id):
    if not es_admin():
        abort(403)
    m = db.session.get(Matricula, matricula_id) or abort(404)
    db.session.delete(m)
    db.session.commit()
    flash("üóëÔ∏è Matr√≠cula eliminada.", "success")
    return redirect(url_for("matriculas.index"))


# ----------------- DESCARGAR DOCUMENTOS -----------------
@bp.route("/<int:matricula_id>/descargar", defaults={"documento_id": None}, endpoint="descargar_documentos")
@bp.route("/<int:matricula_id>/descargar/<int:documento_id>", endpoint="descargar_documentos")
@login_required
def descargar_documentos(matricula_id, documento_id=None):
    """Descarga todos los documentos de una matr√≠cula en ZIP, o un documento individual si documento_id viene."""
    m = db.session.get(Matricula, matricula_id)
    if not m:
        flash("Matr√≠cula no encontrada.", "danger")
        return redirect(url_for("matriculas.lista"))

    # Si se solicita un documento individual
    if documento_id is not None:
        doc = db.session.get(MatriculaDocumento, documento_id)
        if not doc or doc.matricula_id != m.id or not os.path.exists(doc.path):
            flash("Documento no encontrado.", "danger")
            return redirect(url_for("matriculas.detalle", matricula_id=m.id))
        return send_file(doc.path, as_attachment=True, download_name=doc.filename)

    # Si no, crear ZIP con todos los documentos
    buffer = io.BytesIO()
    with zipfile.ZipFile(buffer, "w", zipfile.ZIP_DEFLATED) as zipf:
        # si m.documentos es AppenderQuery, iterar con .all() por seguridad
        docs_iter = m.documentos.all() if hasattr(m, "documentos") and hasattr(m.documentos, "all") else getattr(m, "documentos", []) or []
        for doc in docs_iter:
            if os.path.exists(doc.path):
                zipf.write(doc.path, arcname=doc.filename)
    buffer.seek(0)
    filename = f"matricula_{m.id}_{(m.estudiante_nombre or 'alumno').replace(' ', '_')}.zip"
    return send_file(buffer, as_attachment=True, download_name=filename, mimetype="application/zip")

# ----------------- DESCARGAR DOCUMENTO INDIVIDUAL -----------------
@bp.route("/documento/<int:documento_id>")
@login_required
def descargar_documento(documento_id):
    """Descarga un documento individual de matr√≠cula"""
    doc = db.session.get(MatriculaDocumento, documento_id)
    if not doc or not os.path.exists(doc.path):
        flash("Documento no encontrado.", "danger")
        return redirect(url_for("matriculas.lista"))
    
    return send_file(doc.path, as_attachment=True, download_name=doc.filename)
# ----------------- VALIDACIONES -----------------
@bp.route("/validaciones")
@login_required
def validaciones_index():
    """Redirige al m√≥dulo central de validaciones"""
    return redirect(url_for('validaciones.index'))


@bp.route("/validaciones/<int:matricula_id>", methods=["GET", "POST"])
@login_required
def validar_o_rechazar(matricula_id):
    if not (es_admin() or es_supervisor()):
        abort(403)
    m = db.session.get(Matricula, matricula_id) or abort(404)
    f_ok = ValidarForm(prefix="ok")
    f_bad = RechazoForm(prefix="bad")

    if f_ok.validate_on_submit() and "ok-confirmar" in request.form:
        m.estado = ESTADO_MAT_VALIDADA
        m.motivo_rechazo = None
        db.session.commit()
        _hook_crear_expediente_pagos(m)
        flash("‚úÖ Matr√≠cula validada correctamente.", "success")
        return redirect(url_for("matriculas.validaciones_index"))

    if f_bad.validate_on_submit() and "bad-rechazar" in request.form:
        m.estado = ESTADO_MAT_RECHAZADA
        m.motivo_rechazo = f_bad.motivo.data.strip()
        db.session.commit()
        flash("‚ùå Matr√≠cula rechazada.", "warning")
        return redirect(url_for("matriculas.validaciones_index"))

    return render_template("matriculas/validaciones/validar.html", m=m, f_ok=f_ok, f_bad=f_bad)


================================================================================
üìÅ Archivo: .\app\matriculas\__init__.py
================================================================================

# app/matriculas/__init__.py
from flask import Blueprint

bp = Blueprint(
    "matriculas",
    __name__,
    template_folder="templates",
    static_folder="static"  # por si luego a√±adimos js/css propios
)

from . import routes  # noqa: E402,F401



================================================================================
üìÅ Archivo: .\app\matriculas\templates\matriculas\detalle.html
================================================================================

{% extends "base.html" %}
{% block title %}Detalle de Matr√≠cula ‚Äî {{ m.id }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">Matr√≠cula #{{ m.id }}</h5>
        <small class="text-muted">{{ m.estudiante_nombre or m.estudiante }}</small>
      </div>
      <div class="text-end">
        <small class="text-muted">Fecha: {{ m.created_at.strftime('%d/%m/%Y') if m.created_at else '‚Äî' }}</small>
      </div>
    </div>

    <div class="card-body">
      <!-- Informaci√≥n b√°sica -->
      <div class="row mb-3">
        <div class="col-md-6">
          <p class="mb-1"><strong>Curso:</strong> {{ m.curso.nombre if m.curso else '‚Äî' }}</p>
          <p class="mb-1"><strong>Estado matr√≠cula:</strong> {{ m.estado or '‚Äî' }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-1"><strong>Alumno:</strong> {{ m.estudiante_nombre or '‚Äî' }}</p>
          <p class="mb-1"><strong>Documentos adjuntos:</strong> {{ m.documentos|list|length if m.documentos is defined else '‚Äî' }}</p>
        </div>
      </div>

      <hr/>

      <!-- Documentos -->
      <h6 class="mb-2">Documentos adjuntos</h6>
      {% if m.documentos is defined and (m.documentos|list)|length > 0 %}
        <div class="list-group mb-3">
          {% for d in m.documentos|list %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ d.nombre or d.filename or 'Documento' }}</strong>
                <div class="small text-muted">{{ d.tipo or '' }} {% if d.subido_en %}- {{ d.subido_en.strftime('%d/%m/%Y') }}{% endif %}</div>
              </div>
              <div>
                <!-- Corregido: ahora pasamos matricula_id y documento_id -->
                <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=m.id, documento_id=d.id) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-download me-1"></i> Descargar
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-info">No hay documentos adjuntos para esta matr√≠cula.</div>
      {% endif %}

      <hr/>

      <!-- Pagos asociados -->
      <h6 class="mb-2">Pagos asociados</h6>
      {% if m.pagos is defined and (m.pagos|list)|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Tipo</th>
                <th># Cuota</th>
                <th>Monto</th>
                <th>Fecha pago</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pago in m.pagos|list %}
                <tr>
                  <td>
                    {% if pago.numero_cuota is defined and (pago.numero_cuota == 0 or pago.numero_cuota == 1) %}
                      Pago inicial (matr√≠cula)
                    {% elif pago.origen is defined and pago.origen == 'MATRICULA' %}
                      Pago inicial (matr√≠cula)
                    {% elif pago.es_pago_inicial is defined and pago.es_pago_inicial %}
                      Pago inicial (matr√≠cula)
                    {% else %}
                      Pago de cuota
                    {% endif %}
                  </td>
                  <td>{{ pago.numero_cuota if pago.numero_cuota is defined else '‚Äî' }}</td>
                  <td>{{ "%.2f"|format(pago.monto) if pago.monto is defined else '‚Äî' }}</td>
                  <td>{{ pago.fecha_pago.strftime('%d/%m/%Y') if pago.fecha_pago else '‚Äî' }}</td>
                  <td>{{ pago.estado or '‚Äî' }}</td>
                  <td>
                    <a href="{{ url_for('pagos.detalles_pago', pago_id=pago.id) }}" class="btn btn-sm btn-outline-info">
                      <i class="fas fa-eye"></i> Ver
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-secondary">No hay pagos registrados para esta matr√≠cula.</div>
      {% endif %}

      <hr/>

      <div class="d-flex justify-content-between">
        <a href="{{ url_for('matriculas.index') }}" class="btn btn-light">Volver</a>
        <div>
          <a href="{{ url_for('matriculas.editar', matricula_id=m.id) }}" class="btn btn-primary">Editar matr√≠cula</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\matriculas\templates\matriculas\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Matr√≠culas ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

  <!-- M√©tricas -->
  <div class="row g-3 text-center mb-4">
    <div class="col-6 col-md-3">
      <div class="p-3 rounded shadow-sm bg-primary text-white">
        <i class="fas fa-users fa-2x mb-2"></i><h6 class="mb-1">Total matriculados</h6><h4>{{ total or 0 }}</h4>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="p-3 rounded shadow-sm bg-success text-white">
        <i class="fas fa-check-circle fa-2x mb-2"></i><h6 class="mb-1">Validadas</h6><h4>{{ total_val or 0 }}</h4>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="p-3 rounded shadow-sm bg-warning">
        <i class="fas fa-hourglass-half fa-2x mb-2"></i><h6 class="mb-1">Pendientes</h6><h4>{{ total_pend or 0 }}</h4>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="p-3 rounded shadow-sm bg-danger text-white">
        <i class="fas fa-times-circle fa-2x mb-2"></i><h6 class="mb-1">Rechazadas</h6><h4>{{ total_rech or 0 }}</h4>
      </div>
    </div>
  </div>

  <!-- Tarjetas por curso -->
  {% for c in cursos %}
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <h5 class="mb-0 text-success"><i class="fas fa-book-open me-2"></i>{{ c.nombre }}</h5>
          <span class="badge {% if c.estado=='PROGRAMADO' %}bg-info{% else %}bg-success{% endif %}">
            {{ c.estado }}
          </span>
          {% if c.tipo == 'FP' and c.programacion %}
            <span class="badge bg-secondary">A√±os: {{ c.programacion.anio_escolar_inicio }} / {{ c.programacion.anio_escolar_fin }}</span>
          {% elif c.tipo == 'INTENSIVO' and c.programacion %}
            <span class="badge bg-secondary">Fechas: {{ c.programacion.fecha_inicio.strftime('%d/%m/%Y') }} - {{ c.programacion.fecha_fin.strftime('%d/%m/%Y') }}</span>
          {% endif %}
        </div>
        <div>
          <a class="btn btn-sm btn-success" href="{{ url_for('matriculas.nueva', curso_id=c.id) }}">
            <i class="fas fa-user-plus me-1"></i> Nueva matr√≠cula
          </a>
        </div>
      </div>
      <div class="card-body">

        <!-- Contadores campus -->
        {% set mats = mats_por_curso.get(c.id, []) %}
        {% set bata = mats|selectattr('campus','equalto','BATA')|list|length %}
        {% set malabo = mats|selectattr('campus','equalto','MALABO')|list|length %}
        <div class="d-flex gap-3 mb-3">
          <span class="badge bg-dark">Total: {{ mats|length }}</span>
          <span class="badge bg-success">BATA: {{ bata }}</span>
          <span class="badge bg-primary">MALABO: {{ malabo }}</span>
        </div>

        {% include "matriculas/partials/_tabla_matriculas.html" with context %}

      </div>
    </div>
  {% else %}
    <div class="alert alert-info">No hay cursos validados o programados todav√≠a.</div>
  {% endfor %}

</div>

<script>
/* Filtros en tiempo real por curso (un set por tabla) */
document.querySelectorAll('[data-table-filter]').forEach(function(wrapper){
  const input = wrapper.querySelector('.filter-q');
  const campus = wrapper.querySelector('.filter-campus');
  const estado = wrapper.querySelector('.filter-estado');
  const rows = wrapper.querySelectorAll('tbody tr');

  function apply(){
    const q = (input?.value || '').toLowerCase();
    const cam = campus?.value || '';
    const est = estado?.value || '';
    rows.forEach(tr=>{
      const t = (tr.dataset.text || '').toLowerCase();
      const rc = tr.dataset.campus || '';
      const re = tr.dataset.estado || '';
      let ok = true;
      if (q && !t.includes(q)) ok = false;
      if (cam && rc !== cam) ok = false;
      if (est && re !== est) ok = false;
      tr.style.display = ok ? '' : 'none';
    });
  }
  [input, campus, estado].forEach(el => el && el.addEventListener('input', apply));
});
</script>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\matriculas\templates\matriculas\lista.html
================================================================================

{% extends "base.html" %}
{% block title %}Matr√≠culas ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Matr√≠culas</h5>
      <a href="{{ url_for('matriculas.index') }}" class="btn btn-outline-secondary btn-sm">Ver por curso</a>
    </div>
    <div class="card-body">
      {% if matriculas %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Estudiante</th>
                <th>Curso</th>
                <th>Fecha</th>
                <th>Documentos</th>
                <th>Pagos</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for m in matriculas %}
                <tr>
                  <td>{{ m.id }}</td>
                  <td>{{ m.estudiante_nombre }}</td>
                  <td>{{ m.curso.nombre if m.curso else '‚Äî' }}</td>
                  <td>{{ m.created_at.strftime('%d/%m/%Y') if m.created_at else '‚Äî' }}</td>

                  {# Documentos: usar list() para evitar AppenderQuery issues #}
                  <td>
                    {% set docs = (m.documentos|list) if m.documentos is defined else [] %}
                    {{ docs|length }}
                  </td>

                  {# Pagos: contar de forma defensiva #}
                  <td>
                    {% set pagos = (m.pagos|list) if m.pagos is defined else [] %}
                    {{ pagos|length }}
                  </td>

                  <td>{{ m.estado or '‚Äî' }}</td>
                  <td>
                    <a href="{{ url_for('matriculas.detalle', matricula_id=m.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                    {% if (current_user and (current_user|attr('roles')|length) and (current_user.roles|map(attribute='nombre')|list)|length) %}
                      {% if current_user|attr('roles') and ('Administrador' in (current_user.roles|map(attribute='nombre')|list) or 'Administrativo' in (current_user.roles|map(attribute='nombre')|list)) %}
                        <a href="{{ url_for('matriculas.editar', matricula_id=m.id) }}" class="btn btn-sm btn-outline-secondary">Editar</a>
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No hay matr√≠culas registradas.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\matriculas\templates\matriculas\nueva.html
================================================================================

{% extends "base.html" %}
{% block title %}Nueva Matr√≠cula ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-user-plus me-2"></i>{{ 'Editar' if edit_mode else 'Nueva' }} Matr√≠cula</h4>
      <a href="{{ url_for('matriculas.index') }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <form method="POST" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="card-body">
        <h5 class="fw-bold text-success mb-3">{{ curso.nombre }}</h5>

        {% if curso.tipo == 'FP' %}
          <div class="mb-3">
            {{ form.tipo_fp_anho.label(class="form-label fw-semibold") }}
            <div>
              {% for sub in form.tipo_fp_anho %}
                <div class="form-check form-check-inline">
                  {{ sub(class="form-check-input") }}
                  <label class="form-check-label" for="{{ sub.id }}">{{ sub.label.text }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- DATOS GENERALES -->
        <div class="row g-3">
          <div class="col-md-6">
            {{ form.estudiante_nombre.label(class="form-label") }}
            {{ form.estudiante_nombre(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.doc_identidad.label(class="form-label") }}
            {{ form.doc_identidad(class="form-control") }}
          </div>
          <div class="col-md-4">
            {{ form.telefono.label(class="form-label") }}
            {{ form.telefono(class="form-control") }}
          </div>
          <div class="col-md-4">
            {{ form.email.label(class="form-label") }}
            {{ form.email(class="form-control") }}
          </div>
          <div class="col-md-4">
            {{ form.campus.label(class="form-label") }}
            {{ form.campus(class="form-select") }}
          </div>
          <div class="col-md-12">
            {{ form.direccion.label(class="form-label") }}
            {{ form.direccion(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.coste_total.label(class="form-label") }}
            {{ form.coste_total(class="form-control", placeholder="Ej: 150000") }}
          </div>
          <div class="col-md-6">
        {{ form.numero_plazos.label(class="form-label") }}
        {{ form.numero_plazos(class="form-control", placeholder="Ej: 6") }}
    </div>

    <div class="col-md-6">
    {{ form.monto_inicial.label(class="form-label") }}
    {{ form.monto_inicial(class="form-control", placeholder="Ej: 50000") }}
    <small class="text-muted">Monto del primer pago que se adjunta con la matr√≠cula</small>
</div>
        </div>

        <hr class="my-4">

        <!-- DOCUMENTOS REQUERIDOS -->
        <h6 class="fw-bold text-success mb-3">
          <i class="fas fa-file-upload me-2"></i>Documentos Requeridos
        </h6>
        <div class="row g-3">
          <div class="col-md-6">
            {{ form.expediente_academico.label(class="form-label") }}
            {{ form.expediente_academico(class="form-control", accept=".pdf") }}
            <small class="text-muted">Sube el expediente acad√©mico en formato PDF.</small>
          </div>
          <div class="col-md-6">
            {{ form.factura_primer_pago.label(class="form-label") }}
            {{ form.factura_primer_pago(class="form-control", accept=".pdf") }}
            <small class="text-muted">Sube la factura del primer pago en formato PDF.</small>
          </div>
        </div>

        {% if curso.tipo == 'FP' %}
          <hr class="my-4">

          <!-- BLOQUE SELECCI√ìN M√ìDULOS -->
          <div id="bloque-segundo-ano" style="display:none;">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
              <div>
                <i class="fas fa-info-circle me-2"></i>
                Si el alumno tiene pendientes del 1¬∫ a√±o, m√°rquelas a continuaci√≥n.
                Para poder elegir asignaturas del 2¬∫ a√±o debe seleccionar todas las pendientes del 1¬∫.
              </div>
              <div class="form-check">
                {{ form.no_esta_en_lista(id="noLista", value="0") }}
                <input type="checkbox" id="no-lista-chk" class="form-check-input">
                <label class="form-check-label" for="no-lista-chk">
                  El alumno no est√° en la lista (asignar todo 2¬∫ a√±o)
                </label>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-2">
                  <i class="fas fa-list-check me-2"></i>Pendientes de 1¬∫ a√±o
                </h6>
                {% for mo in mod_anio1 %}
                  <div class="form-check">
                    <input class="form-check-input ck-ano1"
                           type="checkbox"
                           name="mod_ano1[]" id="mo1-{{ mo.id }}"
                           value="{{ mo.id }}"
                           {% if sel_ano1 and (mo.id in sel_ano1) %}checked{% endif %}>
                    <label class="form-check-label" for="mo1-{{ mo.id }}">{{ mo.nombre }}</label>
                  </div>
                {% else %}
                  <div class="text-muted fst-italic">Sin m√≥dulos definidos para 1¬∫ a√±o.</div>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <h6 class="text-success mb-2">
                  <i class="fas fa-list-ul me-2"></i>Asignaturas de 2¬∫ a√±o
                </h6>
                {% for mo in mod_anio2 %}
                  <div class="form-check">
                    <input class="form-check-input ck-ano2"
                           type="checkbox"
                           name="mod_ano2[]" id="mo2-{{ mo.id }}"
                           value="{{ mo.id }}"
                           {% if sel_ano2 and (mo.id in sel_ano2) %}checked{% endif %}>
                    <label class="form-check-label" for="mo2-{{ mo.id }}">{{ mo.nombre }}</label>
                  </div>
                {% else %}
                  <div class="text-muted fst-italic">Sin m√≥dulos definidos para 2¬∫ a√±o.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}

        <!-- BOT√ìN GUARDAR -->
        <div class="text-end mt-4">
          {{ form.enviar(class="btn btn-success px-4") }}
        </div>
      </div>
    </form>
  </div>
</div>

{% if curso.tipo == 'FP' %}
<script>
(function(){
  const radios = document.querySelectorAll('input[name="{{ form.tipo_fp_anho.name }}"]');
  const block2 = document.getElementById('bloque-segundo-ano');
  const noListaChk = document.getElementById('no-lista-chk');
  const hiddenNoLista = document.getElementById('noLista');
  const ano1 = document.querySelectorAll('.ck-ano1');
  const ano2 = document.querySelectorAll('.ck-ano2');

  function refresh(){
    const v = document.querySelector('input[name="{{ form.tipo_fp_anho.name }}"]:checked')?.value;
    block2.style.display = (v === 'SEGUNDO_ANO') ? '' : 'none';
    const noLista = noListaChk.checked;
    hiddenNoLista.value = noLista ? '1' : '0';
    [...ano1, ...ano2].forEach(el => el.disabled = noLista);
  }

  function enforce(){
    if (!noListaChk.checked){
      const total1 = Array.from(ano1).length;
      const sel1 = Array.from(ano1).filter(el => el.checked).length;
      const allow2 = (total1 === 0) || (sel1 === total1);
      ano2.forEach(el => {
        el.disabled = !allow2;
        if (!allow2) el.checked = false;
      });
    }
  }

  radios.forEach(r => r.addEventListener('change', ()=>{ refresh(); enforce(); }));
  noListaChk?.addEventListener('change', ()=>{ refresh(); enforce(); });
  ano1.forEach(c => c.addEventListener('change', enforce));
  refresh(); enforce();
})();
</script>
{% endif %}
{% endblock %}



================================================================================
üìÅ Archivo: .\app\matriculas\templates\matriculas\partials\_tabla_matriculas.html
================================================================================

<div data-table-filter>
  <div class="row g-2 mb-2">
    <div class="col-md-6">
      <input type="text" class="form-control filter-q" placeholder="Buscar estudiante‚Ä¶">
    </div>
    <div class="col-md-3">
      <select class="form-select filter-campus">
        <option value="">Campus: todos</option>
        <option value="BATA">BATA</option>
        <option value="MALABO">MALABO</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select filter-estado">
        <option value="">Estado: todos</option>
        <option value="PENDIENTE_VALIDACION">Pendiente</option>
        <option value="VALIDADA">Validada</option>
        <option value="RECHAZADA">Rechazada</option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th><th>Estudiante</th><th>Documento</th><th>Campus</th><th>Tipo</th><th>Estado</th><th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for m in mats %}
          <tr data-text="{{ m.estudiante_nombre }} {{ m.doc_identidad }} {{ m.email }} {{ m.telefono }}"
              data-campus="{{ m.campus }}" data-estado="{{ m.estado }}">
            <td>{{ m.id }}</td>
            <td>{{ m.estudiante_nombre }}</td>
            <td>{{ m.doc_identidad or '‚Äî' }}</td>
            <td><span class="badge bg-secondary">{{ m.campus }}</span></td>
            <td>
              {% if m.curso.tipo == 'FP' %}
                <span class="badge bg-info">{{ '1¬∫ a√±o' if m.tipo_fp_anho=='PRIMER_ANO' else '2¬∫ a√±o' }}</span>
              {% else %}
                <span class="badge bg-dark">Intensivo</span>
              {% endif %}
            </td>
            <td>
              <span class="badge
                {% if m.estado=='VALIDADA' %} bg-success
                {% elif m.estado=='RECHAZADA' %} bg-danger
                {% else %} bg-warning {% endif %}">
                {{ 'Pendiente' if m.estado=='PENDIENTE_VALIDACION' else m.estado }}
              </span>
              {% if m.estado=='RECHAZADA' and m.motivo_rechazo %}<br><small class="text-muted">{{ m.motivo_rechazo }}</small>{% endif %}
            </td>
            <td class="text-end">
              <a href="{{ url_for('matriculas.detalle', matricula_id=m.id) }}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-eye"></i>
              </a>
              {% if (m.estado in ['PENDIENTE_VALIDACION','RECHAZADA']) and (current_user.roles | selectattr('nombre', 'in', ['Administrador','Administrativo']) | list | length > 0) %}
                <a href="{{ url_for('matriculas.editar', matricula_id=m.id) }}" class="btn btn-warning btn-sm">
                  <i class="fas fa-edit"></i>
                </a>
              {% endif %}
              {% if current_user.roles | selectattr('nombre', 'equalto', 'Administrador') | list | length > 0 %}
                <form method="POST" action="{{ url_for('matriculas.eliminar', matricula_id=m.id) }}" class="d-inline"
                      onsubmit="return confirm('¬øEliminar matr√≠cula? Esta acci√≥n no se puede deshacer.')">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="7" class="text-muted fst-italic">No hay matr√≠culas para este curso.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


================================================================================
üìÅ Archivo: .\app\pagos\forms.py
================================================================================

# app/pagos/forms.py
from flask_wtf import FlaskForm
from wtforms import FloatField, FileField, SubmitField, TextAreaField
from wtforms.validators import DataRequired, NumberRange, Optional, Length
from flask_wtf.file import FileAllowed

class RegistrarPagoForm(FlaskForm):
    """Formulario para registrar un pago"""
    monto = FloatField(
        "Monto del pago (XAF)",
        validators=[DataRequired(), NumberRange(min=1, message="El monto debe ser mayor a 0")]
    )
    factura = FileField(
        "Factura (PDF)",
        validators=[
            DataRequired(message="Debe adjuntar la factura del pago."),
            FileAllowed(["pdf"], "Solo se permiten archivos PDF.")
        ]
    )
    registrar = SubmitField("Registrar Pago")

class ValidarPagoForm(FlaskForm):
    """Formulario para validar/rechazar pagos"""
    motivo = TextAreaField(
        "Motivo del rechazo",
        validators=[Optional(), Length(min=5, message="Debe indicar al menos 5 caracteres.")]
    )
    validar = SubmitField("Validar Pago")
    rechazar = SubmitField("Rechazar Pago")


================================================================================
üìÅ Archivo: .\app\pagos\models.py
================================================================================

from datetime import datetime, date
from sqlalchemy.types import TypeDecorator, Date
from app.extensions import db

# Estados de pago
ESTADO_PAGO_PENDIENTE = "PENDIENTE"
ESTADO_PAGO_VALIDADO = "VALIDADO"
ESTADO_PAGO_RECHAZADO = "RECHAZADO"
ESTADO_PAGO_INICIAL = "INICIAL"
ESTADO_PAGO_PENDIENTE_VALIDACION = "PENDIENTE_VALIDACION"

class SafeDate(TypeDecorator):
    """Tipo de columna que maneja de forma segura diferentes formatos de fecha"""
    impl = Date
    
    def process_result_value(self, value, dialect):
        """Convierte valores de la base de datos a objetos date de Python"""
        if value is None:
            return None
        
        if isinstance(value, date):
            return value
        
        if isinstance(value, datetime):
            return value.date()
        
        if isinstance(value, str):
            try:
                # Intentar formato YYYY-MM-DD
                if ' ' in value:
                    # Si tiene espacio, es formato datetime
                    return datetime.strptime(value, '%Y-%m-%d %H:%M:%S.%f').date()
                else:
                    # Formato date simple
                    return datetime.strptime(value, '%Y-%m-%d').date()
            except ValueError:
                # Si falla, intentar otros formatos comunes
                try:
                    return datetime.strptime(value, '%Y-%m-%d').date()
                except ValueError:
                    print(f"‚ö†Ô∏è No se pudo parsear la fecha: {value}")
                    return None
        
        return value

# Actualizar el modelo Pago para usar SafeDate
class Pago(db.Model):
    __tablename__ = "pagos"
    __table_args__ = {'extend_existing': True}

    id = db.Column(db.Integer, primary_key=True)
    matricula_id = db.Column(db.Integer, db.ForeignKey("matriculas.id"), nullable=False)
    numero_cuota = db.Column(db.Integer, nullable=False)
    monto = db.Column(db.Float, nullable=False)
    estado = db.Column(db.String(20), nullable=False, default=ESTADO_PAGO_PENDIENTE)
    
    # Campos para pago inicial
    es_pago_inicial = db.Column(db.Boolean, default=False)
    monto_inicial = db.Column(db.Float, nullable=True)
    
    # Campos para control de validaci√≥n - USAR SafeDate
    fecha_vencimiento = db.Column(SafeDate, nullable=True)
    fecha_pago = db.Column(SafeDate, nullable=True)
    comprobante_path = db.Column(db.String(300), nullable=True)
    motivo_rechazo = db.Column(db.Text, nullable=True)
    
    # Campos legacy para compatibilidad
    factura_nombre = db.Column(db.String(200), nullable=True)
    factura_path = db.Column(db.String(300), nullable=True)
    
    # Auditor√≠a
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)

    # Relaci√≥n
    matricula = db.relationship("Matricula", back_populates="pagos")

    def __repr__(self):
        return f"<Pago {self.numero_cuota} - {self.estado}>"

    def esta_vencido(self):
        """Verifica si el pago est√° fuera de plazo"""
        if not self.fecha_vencimiento:
            return False
        return self.fecha_vencimiento < date.today() and self.estado in [ESTADO_PAGO_PENDIENTE, ESTADO_PAGO_PENDIENTE_VALIDACION]

    def get_estado_display(self):
        """Retorna el estado para mostrar en la interfaz"""
        if self.estado == ESTADO_PAGO_VALIDADO:
            return "Validado"
        elif self.estado == ESTADO_PAGO_RECHAZADO:
            return "Rechazado"
        elif self.estado == ESTADO_PAGO_INICIAL:
            return "Pago Inicial"
        elif self.estado == ESTADO_PAGO_PENDIENTE_VALIDACION:
            return "Pendiente de Validaci√≥n"
        elif self.esta_vencido():
            return "Fuera de Plazo"
        else:
            return "Pendiente"


================================================================================
üìÅ Archivo: .\app\pagos\routes.py
================================================================================

# app/pagos/routes.py
import os
from datetime import datetime, date, timedelta
from flask import (
    render_template, redirect, url_for, flash, request, 
    abort, send_file, current_app
)
from flask_login import login_required, current_user
import os
from werkzeug.utils import secure_filename
from app.extensions import db
from app.matriculas.models import Matricula
from app.pagos.models import Pago, ESTADO_PAGO_PENDIENTE, ESTADO_PAGO_VALIDADO, ESTADO_PAGO_RECHAZADO, ESTADO_PAGO_PENDIENTE_VALIDACION, ESTADO_PAGO_INICIAL
from app.pagos.forms import RegistrarPagoForm

from . import bp

# Configuraci√≥n de subida de archivos
ALLOWED_EXTENSIONS = {'.pdf', '.png', '.jpg', '.jpeg'}
MAX_FILE_MB = 10

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ['pdf', 'png', 'jpg', 'jpeg']

def ensure_upload_dir():
    upload_dir = os.path.join(current_app.instance_path, "uploads", "pagos")
    os.makedirs(upload_dir, exist_ok=True)
    return upload_dir

# ----------------- NUEVAS FUNCIONES PARA C√ÅLCULOS FINANCIEROS -----------------
def calcular_monto_pagado(matricula_id):
    """Calcula el monto total pagado (pago inicial + cuotas validadas)"""
    pagos = Pago.query.filter_by(matricula_id=matricula_id).all()
    monto_pagado = 0
    
    for pago in pagos:
        if pago.estado == ESTADO_PAGO_VALIDADO or pago.es_pago_inicial:
            monto_pagado += pago.monto
    
    return monto_pagado

def calcular_deuda_actual(matricula):
    """Calcula la deuda actual (costo total - monto pagado)"""
    monto_pagado = calcular_monto_pagado(matricula.id)
    return matricula.coste_total - monto_pagado

def obtener_cuotas_pendientes(matricula_id):
    """Obtiene las cuotas pendientes de validaci√≥n"""
    return Pago.query.filter_by(
        matricula_id=matricula_id, 
        estado=ESTADO_PAGO_PENDIENTE
    ).order_by(Pago.numero_cuota).all()

def redistribuir_cuotas_pendientes(matricula):
    """Redistribuye el monto de las cuotas pendientes basado en la deuda actual"""
    # Obtener cuotas pendientes
    cuotas_pendientes = obtener_cuotas_pendientes(matricula.id)
    
    if not cuotas_pendientes:
        return
    
    # Calcular deuda actual
    deuda_actual = calcular_deuda_actual(matricula)
    
    # Recalcular monto por cuota
    nuevo_monto_cuota = round(deuda_actual / len(cuotas_pendientes), 2)
    
    # Ajustar la √∫ltima cuota por posibles diferencias de redondeo
    for i, cuota in enumerate(cuotas_pendientes):
        if i == len(cuotas_pendientes) - 1:
            # La √∫ltima cuota lleva el ajuste por redondeo
            total_asignado = nuevo_monto_cuota * (len(cuotas_pendientes) - 1)
            cuota.monto = round(deuda_actual - total_asignado, 2)
        else:
            cuota.monto = nuevo_monto_cuota
    
    db.session.commit()

def _calcular_balance(matricula):
    """Calcular balance total pagado y adeudado - VERSI√ìN MEJORADA"""
    monto_pagado = calcular_monto_pagado(matricula.id)
    deuda_actual = calcular_deuda_actual(matricula)
    
    # Obtener informaci√≥n de cuotas
    cuotas_totales = Pago.query.filter_by(matricula_id=matricula.id).count()
    cuotas_pagadas = Pago.query.filter(
        Pago.matricula_id == matricula.id,
        db.or_(Pago.estado == ESTADO_PAGO_VALIDADO, Pago.es_pago_inicial == True)
    ).count()
    cuotas_pendientes = cuotas_totales - cuotas_pagadas
    
    return {
        'total_pagado': monto_pagado,
        'total_adeudado': deuda_actual,
        'coste_total': matricula.coste_total,
        'progreso': (monto_pagado / matricula.coste_total * 100) if matricula.coste_total > 0 else 0,
        'cuotas_pagadas': cuotas_pagadas,
        'cuotas_pendientes': cuotas_pendientes,
        'cuotas_totales': cuotas_totales
    }

def _verificar_crear_pago_inicial(matricula):
    """Verificar y crear pago inicial si no existe"""
    try:
        pago_inicial = Pago.query.filter_by(
            matricula_id=matricula.id, 
            es_pago_inicial=True
        ).first()
        
        if not pago_inicial and matricula.monto_inicial > 0:
            pago_inicial = Pago(
                matricula_id=matricula.id,
                numero_cuota=0,
                monto=matricula.monto_inicial,
                estado=ESTADO_PAGO_INICIAL,
                es_pago_inicial=True,
                monto_inicial=matricula.monto_inicial,
                fecha_vencimiento=None
            )
            db.session.add(pago_inicial)
            db.session.commit()
            return True
        return False
    except Exception as e:
        print(f"‚ö†Ô∏è Error creando pago inicial: {e}")
        return False

def _calcular_fechas_vencimiento(fecha_base, numero_cuota):
    """Calcular fecha de vencimiento (siempre d√≠a 10 de cada mes)"""
    if fecha_base.day <= 10:
        primer_vencimiento = date(fecha_base.year, fecha_base.month, 10)
    else:
        if fecha_base.month == 12:
            primer_vencimiento = date(fecha_base.year + 1, 1, 10)
        else:
            primer_vencimiento = date(fecha_base.year, fecha_base.month + 1, 10)
    
    meses_adicionales = numero_cuota - 1
    year = primer_vencimiento.year
    month = primer_vencimiento.month + meses_adicionales
    
    while month > 12:
        month -= 12
        year += 1
    
    return date(year, month, 10)

# -------------------------------------------------------------
# üß≠ INDEX: Agrupa por campus
# -------------------------------------------------------------
@bp.route("/", endpoint="index")
@login_required
def index():
    malabo = Matricula.query.filter_by(campus="MALABO").all()
    bata = Matricula.query.filter_by(campus="BATA").all()

    return render_template(
        "pagos/index.html",
        malabo=malabo,
        bata=bata
    )

# -------------------------------------------------------------
# üìã FICHA DE PAGOS DEL ESTUDIANTE (VERSI√ìN MEJORADA)
# -------------------------------------------------------------
@bp.route("/ficha/<int:matricula_id>", endpoint="ficha")
@login_required
def ficha(matricula_id):
    matricula = Matricula.query.get_or_404(matricula_id)
    
    # Verificar y crear pago inicial si no existe
    _verificar_crear_pago_inicial(matricula)
    
    # Obtener todos los pagos de la matr√≠cula
    pagos = Pago.query.filter_by(matricula_id=matricula_id).order_by(Pago.numero_cuota).all()
    
    # Obtener pago inicial
    pago_inicial = Pago.query.filter_by(matricula_id=matricula_id, es_pago_inicial=True).first()
    
    # Calcular informaci√≥n financiera actualizada
    monto_pagado = calcular_monto_pagado(matricula_id)
    deuda_actual = calcular_deuda_actual(matricula)
    cuotas_pendientes = obtener_cuotas_pendientes(matricula_id)
    
    balance = _calcular_balance(matricula)
    
    return render_template(
        "pagos/ficha_pago.html", 
        m=matricula, 
        pagos=pagos,
        pago_inicial=pago_inicial,
        balance=balance,
        monto_pagado=monto_pagado,
        deuda_actual=deuda_actual,
        cuotas_pendientes=cuotas_pendientes,
        ahora=datetime.utcnow()
    )

# -------------------------------------------------------------
# üíµ REGISTRAR NUEVO PAGO (por pago_id espec√≠fico)
# -------------------------------------------------------------
@bp.route("/registrar/<int:pago_id>", methods=["POST"], endpoint="registrar_pago")
@login_required
def registrar_pago(pago_id):
    pago = Pago.query.get_or_404(pago_id)
    
    # Verificar que el pago no est√© ya validado o sea pago inicial
    if pago.estado in [ESTADO_PAGO_VALIDADO, ESTADO_PAGO_INICIAL]:
        flash("Este pago ya ha sido procesado.", "warning")
        return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))
    
    # Procesar archivo
    file = request.files.get('comprobante')
    if not file or file.filename == '':
        flash("Debe adjuntar un comprobante de pago.", "danger")
        return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))
    
    if not allowed_file(file.filename):
        flash("Formato de archivo no permitido. Use PDF, JPG o PNG.", "danger")
        return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))
    
    # Verificar tama√±o del archivo
    file.seek(0, os.SEEK_END)
    size_mb = file.tell() / (1024 * 1024)
    file.seek(0)
    if size_mb > MAX_FILE_MB:
        flash(f"El archivo supera {MAX_FILE_MB} MB.", "danger")
        return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))
    
    # Guardar archivo
    upload_dir = ensure_upload_dir()
    filename = secure_filename(f"pago_{pago.id}_{datetime.utcnow().timestamp()}_{file.filename}")
    filepath = os.path.join(upload_dir, filename)
    file.save(filepath)
    
    # Actualizar pago
    pago.comprobante_path = filepath
    pago.fecha_pago = date.today()
    pago.estado = ESTADO_PAGO_PENDIENTE_VALIDACION
    
    db.session.commit()
    
    flash("Pago registrado correctamente. Esperando validaci√≥n.", "success")
    return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))

# -------------------------------------------------------------
# üìÑ DETALLES DEL PAGO
# -------------------------------------------------------------
@bp.route("/detalles/<int:pago_id>", endpoint="detalles_pago")
@login_required
def detalles_pago(pago_id):
    pago = Pago.query.get_or_404(pago_id)
    
    # Calcular informaci√≥n financiera para el contexto
    monto_pagado = calcular_monto_pagado(pago.matricula_id)
    deuda_actual = calcular_deuda_actual(pago.matricula)
    
    return render_template("pagos/detalles_pago.html", 
                         pago=pago,
                         monto_pagado=monto_pagado,
                         deuda_actual=deuda_actual)

# -------------------------------------------------------------
# ‚úèÔ∏è EDITAR PAGO (para pagos rechazados o fuera de plazo)
# -------------------------------------------------------------
@bp.route("/editar/<int:pago_id>", methods=["GET", "POST"], endpoint="editar_pago")
@login_required
def editar_pago(pago_id):
    pago = Pago.query.get_or_404(pago_id)
    
    # Solo permitir edici√≥n de pagos rechazados o fuera de plazo
    if pago.estado not in [ESTADO_PAGO_RECHAZADO] and not pago.esta_vencido():
        flash("No puede editar este pago.", "warning")
        return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))
    
    if request.method == "POST":
        file = request.files.get('comprobante')
        if not file or file.filename == '':
            flash("Debe adjuntar un comprobante de pago.", "danger")
            return redirect(url_for("pagos.editar_pago", pago_id=pago.id))
        
        if not allowed_file(file.filename):
            flash("Formato de archivo no permitido. Use PDF, JPG o PNG.", "danger")
            return redirect(url_for("pagos.editar_pago", pago_id=pago.id))
        
        # Verificar tama√±o del archivo
        file.seek(0, os.SEEK_END)
        size_mb = file.tell() / (1024 * 1024)
        file.seek(0)
        if size_mb > MAX_FILE_MB:
            flash(f"El archivo supera {MAX_FILE_MB} MB.", "danger")
            return redirect(url_for("pagos.editar_pago", pago_id=pago.id))
        
        # Eliminar archivo anterior si existe
        if pago.comprobante_path and os.path.exists(pago.comprobante_path):
            try:
                os.remove(pago.comprobante_path)
            except OSError:
                pass
        
        # Guardar nuevo archivo
        upload_dir = ensure_upload_dir()
        filename = secure_filename(f"pago_{pago.id}_{datetime.utcnow().timestamp()}_{file.filename}")
        filepath = os.path.join(upload_dir, filename)
        file.save(filepath)
        
        # Actualizar pago
        pago.comprobante_path = filepath
        pago.fecha_pago = date.today()
        pago.estado = ESTADO_PAGO_PENDIENTE_VALIDACION
        pago.motivo_rechazo = None
        
        db.session.commit()
        
        flash("Pago actualizado correctamente. Esperando validaci√≥n.", "success")
        return redirect(url_for("pagos.ficha", matricula_id=pago.matricula_id))
    
    return render_template("pagos/editar_pago.html", pago=pago)

# -------------------------------------------------------------
# üëÅÔ∏è VISUALIZAR COMPROBANTE
# -------------------------------------------------------------
@bp.route("/comprobante/<int:pago_id>", endpoint="ver_comprobante")
@login_required
def ver_comprobante(pago_id):
    pago = Pago.query.get_or_404(pago_id)
    
    if not pago.comprobante_path or not os.path.exists(pago.comprobante_path):
        abort(404)
    
    return send_file(pago.comprobante_path, as_attachment=False)

# -------------------------------------------------------------
# üì• DESCARGAR COMPROBANTE
# -------------------------------------------------------------
@bp.route("/descargar/<int:pago_id>", endpoint="descargar_comprobante")
@login_required
def descargar_comprobante(pago_id):
    pago = Pago.query.get_or_404(pago_id)
    
    if not pago.comprobante_path or not os.path.exists(pago.comprobante_path):
        abort(404)
    
    return send_file(pago.comprobante_path, as_attachment=True, download_name=os.path.basename(pago.comprobante_path))


================================================================================
üìÅ Archivo: .\app\pagos\__init__.py
================================================================================

from flask import Blueprint

bp = Blueprint("pagos", __name__, 
               url_prefix="/pagos",
               template_folder="templates")  # ‚úÖ Agregar template_folder

from . import routes  # ‚úÖ Usar importaci√≥n relativa


================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\detalles_pago.html
================================================================================

{% extends "base.html" %}
{% block title %}Detalle de Pago ‚Äî {{ pago.id }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Pago #{{ pago.id }}</h5>
      <small class="text-muted">{{ pago.estado or '' }}</small>
    </div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Matr√≠cula</dt>
        <dd class="col-sm-9">
          {% if pago.matricula %}
            <a href="{{ url_for('matriculas.detalle', matricula_id=pago.matricula.id) }}">Matr√≠cula #{{ pago.matricula.id }} ‚Äî {{ pago.matricula.estudiante_nombre }}</a>
          {% else %}
            ‚Äî
          {% endif %}
        </dd>

        <dt class="col-sm-3">Tipo</dt>
        <dd class="col-sm-9">
          {% if pago.numero_cuota is defined and pago.numero_cuota == 0 %}
            Pago inicial (matr√≠cula)
          {% elif pago.es_pago_inicial is defined and pago.es_pago_inicial %}
            Pago inicial (matr√≠cula)
          {% else %}
            Pago de cuota
          {% endif %}
        </dd>

        <dt class="col-sm-3">Monto</dt>
        <dd class="col-sm-9">{{ "%.2f"|format(pago.monto or 0) }}</dd>

        <dt class="col-sm-3">Fecha</dt>
        <dd class="col-sm-9">{{ pago.fecha_pago.strftime('%d/%m/%Y') if pago.fecha_pago else (pago.fecha_vencimiento.strftime('%d/%m/%Y') if pago.fecha_vencimiento else '‚Äî') }}</dd>
      </dl>

      <hr/>

      <h6>Comprobante</h6>
      {# Intentamos mostrar comprobante asociado directamente al Pago #}
      {% set comprobante = None %}
      {% if pago is defined %}
        {# comprobante directo en pago (varios nombres posibles) #}
        {% if pago.documento_path is defined and pago.documento_path %}
          {% set comprobante = {'path': pago.documento_path, 'filename': pago.filename if pago.filename is defined else None} %}
        {% elif pago.documento_id is defined and pago.documento_id %}
          {% set comprobante = {'id': pago.documento_id} %}
        {% elif pago.comprobante_id is defined and pago.comprobante_id %}
          {% set comprobante = {'id': pago.comprobante_id} %}
        {% endif %}

        {# Si no hay comprobante directo, buscar en la matr√≠cula del pago: tipo 'factura_primer_pago' primero #}
        {% if not comprobante and pago.matricula is defined %}
          {% set docs = (pago.matricula.documentos|list) if pago.matricula.documentos is defined else [] %}
          {% set factura_docs = docs | selectattr('tipo','equalto','factura_primer_pago') | list %}
          {% if factura_docs and factura_docs|length > 0 %}
            {% set doc = factura_docs[-1] %}
            {% set comprobante = {'id': doc.id, 'path': doc.path, 'filename': doc.filename} %}
          {% elif docs and docs|length > 0 %}
            {% set doc = docs[-1] %}
            {% set comprobante = {'id': doc.id, 'path': doc.path, 'filename': doc.filename} %}
          {% endif %}
        {% endif %}
      {% endif %}

      {% if comprobante %}
        <p class="mb-2">Se encontr√≥ un comprobante asociado:</p>
        <div>
          {% if comprobante.path %}
            <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=pago.matricula.id, documento_id=comprobante.id) if comprobante.id else '#' }}" class="btn btn-outline-primary" target="_blank">
              <i class="fas fa-download me-1"></i> Descargar comprobante
            </a>
            {% if comprobante.filename %}
              <span class="ms-2 small text-muted">{{ comprobante.filename }}</span>
            {% endif %}
          {% elif comprobante.id %}
            <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=pago.matricula.id, documento_id=comprobante.id) }}" class="btn btn-outline-primary" target="_blank">
              <i class="fas fa-download me-1"></i> Descargar comprobante
            </a>
          {% else %}
            <div class="alert alert-info mb-0">Comprobante registrado pero no accesible.</div>
          {% endif %}
        </div>
      {% else %}
        <div class="alert alert-warning">No hay comprobante adjunto - Este pago no tiene documento de comprobante registrado.</div>
      {% endif %}

      <hr/>
      <a href="{{ url_for('validaciones.index') }}" class="btn btn-light">Volver a Validaciones</a>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\editar_pago.html
================================================================================

{% extends "base.html" %}
{% block title %}Editar Pago ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Editar Pago</h4>
      <a href="{{ url_for('pagos.ficha', matricula_id=pago.matricula_id) }}" class="btn btn-outline-dark btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <div class="card-body">
      <h5 class="fw-bold text-success">Cuota {{ pago.numero_cuota }}</h5>
      <p class="text-muted mb-4">Estudiante: {{ pago.matricula.estudiante_nombre }}</p>

      <form method="POST" enctype="multipart/form-data">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Monto de la Cuota (XAF)</label>
            <input type="number" class="form-control" value="{{ "%.2f"|format(pago.monto) }}" disabled>
            <small class="text-muted">El monto no se puede modificar</small>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Fecha de Vencimiento</label>
            <input type="text" class="form-control" value="{{ pago.fecha_vencimiento.strftime('%d/%m/%Y') if pago.fecha_vencimiento else 'N/A' }}" disabled>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Nuevo Comprobante de Pago</label>
          <input type="file" class="form-control" name="comprobante" accept=".pdf,.jpg,.jpeg,.png" required>
          <div class="form-text">Formatos permitidos: PDF, JPG, PNG (m√°x. 10MB)</div>
        </div>

        {% if pago.motivo_rechazo %}
        <div class="alert alert-info">
          <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>Motivo de Rechazo Anterior</h6>
          <p class="mb-0">{{ pago.motivo_rechazo }}</p>
        </div>
        {% endif %}

        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Al enviar este formulario, el pago volver√° a estado "Pendiente de Validaci√≥n" y ser√° revisado nuevamente.
        </div>

        <div class="text-end">
          <button type="submit" class="btn btn-primary px-4">
            <i class="fas fa-save me-1"></i> Actualizar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\ficha_pago.html
================================================================================

{% extends "base.html" %}
{% block title %}Ficha de Pagos ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Ficha de Pagos - Evoluci√≥n Financiera</h4>
      <a href="{{ url_for('matriculas.detalle', matricula_id=m.id) }}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver a Matr√≠cula
      </a>
    </div>

    <div class="card-body">
      <!-- Informaci√≥n del Estudiante -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h5 class="fw-bold text-success">{{ m.estudiante_nombre }}</h5>
          <p class="text-muted mb-1">{{ m.curso.nombre }} | {{ m.campus }}</p>
          <p class="text-muted mb-0">Documento: {{ m.doc_identidad or 'N/A' }}</p>
        </div>
        <div class="col-md-6 text-end">
          <p class="mb-1"><strong>Fecha de Matr√≠cula:</strong> {{ m.created_at.strftime('%d/%m/%Y') }}</p>
          <p class="mb-0"><strong>N√∫mero de Plazos:</strong> {{ m.numero_plazos }}</p>
        </div>
      </div>

      <!-- RESUMEN FINANCIERO ACTUALIZADO -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Resumen Financiero Actualizado</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 bg-light h-100">
                <h6 class="text-muted">Monto Total Matr√≠cula</h6>
                <h4 class="text-primary">{{ "%.2f"|format(m.coste_total) }} XAF</h4>
                <small class="text-muted">Costo total del curso</small>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 bg-light h-100">
                <h6 class="text-muted">Pago Inicial</h6>
                <h4 class="text-info">{{ "%.2f"|format(m.monto_inicial) }} XAF</h4>
                <small class="text-muted">{{ "%.1f"|format((m.monto_inicial / m.coste_total * 100)) }}% del total</small>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 bg-light h-100">
                <h6 class="text-muted">Monto Total Pagado</h6>
                <h4 class="text-success">{{ "%.2f"|format(monto_pagado) }} XAF</h4>
                <small class="text-muted">{{ "%.1f"|format((monto_pagado / m.coste_total * 100)) }}% del total</small>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 bg-light h-100">
                <h6 class="text-muted">Deuda Actual</h6>
                <h4 class="text-danger">{{ "%.2f"|format(deuda_actual) }} XAF</h4>
                <small class="text-muted">{{ "%.1f"|format((deuda_actual / m.coste_total * 100)) }}% del total</small>
              </div>
            </div>
          </div>
          
          <!-- Barra de progreso -->
          <div class="mt-3">
            <div class="d-flex justify-content-between mb-1">
              <small>Progreso de Pagos</small>
              <small>{{ "%.1f"|format((monto_pagado / m.coste_total * 100)) }}%</small>
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: {{ (monto_pagado / m.coste_total * 100) }}%"
                   aria-valuenow="{{ (monto_pagado / m.coste_total * 100) }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
                {{ "%.1f"|format((monto_pagado / m.coste_total * 100)) }}%
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DETALLE DE PAGOS -->
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>Detalle de Cuotas</h5>
        </div>
        <div class="card-body">
          <!-- Pago Inicial -->
          {% if pago_inicial %}
          <div class="alert alert-info mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="fw-bold mb-1"><i class="fas fa-receipt me-2"></i>Pago Inicial</h6>
                <p class="mb-0"><strong>Monto:</strong> {{ "%.2f"|format(pago_inicial.monto) }} XAF 
                  | <strong>Estado:</strong> <span class="badge bg-success">Pagado</span></p>
              </div>
              <div class="text-end">
                <small class="text-muted">Realizado al matricularse</small>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Tabla de Cuotas -->
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-warning">
                <tr>
                  <th># Cuota</th>
                  <th>Monto (XAF)</th>
                  <th>Vencimiento</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for pago in pagos %}
                  {% if not pago.es_pago_inicial %}
                  <tr>
                    <td>
                      <strong>Cuota {{ pago.numero_cuota }}</strong>
                      {% if pago.fecha_pago %}
                        <br><small class="text-muted">Pagado: {{ pago.fecha_pago.strftime('%d/%m/%Y') }}</small>
                      {% endif %}
                    </td>
                    <td>
                      {{ "%.2f"|format(pago.monto) }} XAF
                      {% if pago.estado == 'PENDIENTE' %}
                        <br><small class="text-muted">Monto actualizado</small>
                      {% endif %}
                    </td>
                    <td>
                      {% if pago.fecha_vencimiento %}
                        {{ pago.fecha_vencimiento.strftime('%d/%m/%Y') }}
                        {% if pago.esta_vencido() and pago.estado == 'PENDIENTE' %}
                          <br><span class="badge bg-danger">Vencido</span>
                        {% endif %}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td>
                      {% set estado_display = pago.get_estado_display() %}
                      {% if estado_display == 'Validado' %}
                        <span class="badge bg-success">Validado</span>
                        <br><small class="text-muted">{{ pago.fecha_pago.strftime('%d/%m/%Y') if pago.fecha_pago }}</small>
                      {% elif estado_display == 'Rechazado' %}
                        <span class="badge bg-danger">Rechazado</span>
                        {% if pago.motivo_rechazo %}
                          <br><small class="text-muted">{{ pago.motivo_rechazo }}</small>
                        {% endif %}
                      {% elif estado_display == 'Fuera de Plazo' %}
                        <span class="badge bg-warning text-dark">Fuera de Plazo</span>
                      {% elif estado_display == 'Pendiente de Validaci√≥n' %}
                        <span class="badge bg-secondary">Pendiente Validaci√≥n</span>
                        <br><small class="text-muted">Esperando confirmaci√≥n</small>
                      {% else %}
                        <span class="badge bg-info">Pendiente</span>
                      {% endif %}
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <!-- Bot√≥n Registrar/Editar Pago -->
                        {% if estado_display in ['Pendiente', 'Fuera de Plazo', 'Rechazado'] %}
                          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalRegistroPago{{ pago.id }}">
                            <i class="fas fa-edit"></i> {{ 'Registrar' if estado_display != 'Rechazado' else 'Editar' }}
                          </button>
                        {% endif %}
                        
                        <!-- Bot√≥n Ver Detalles -->
                        <a href="{{ url_for('pagos.detalles_pago', pago_id=pago.id) }}" class="btn btn-outline-secondary">
                          <i class="fas fa-eye"></i> Ver
                        </a>
                      </div>

                      <!-- Modal de Registro de Pago -->
                      <div class="modal fade" id="modalRegistroPago{{ pago.id }}" tabindex="-1">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                              <h5 class="modal-title">
                                <i class="fas fa-credit-card me-2"></i>
                                {{ 'Registrar' if pago.estado != 'RECHAZADO' else 'Editar' }} Pago - Cuota {{ pago.numero_cuota }}
                              </h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="POST" action="{{ url_for('pagos.registrar_pago', pago_id=pago.id) if pago.estado != 'RECHAZADO' else url_for('pagos.editar_pago', pago_id=pago.id) }}" enctype="multipart/form-data">
                              <div class="modal-body">
                                <div class="alert alert-info">
                                  <h6 class="fw-bold">Informaci√≥n Actual del Pago</h6>
                                  <p class="mb-1"><strong>Monto de la cuota:</strong> {{ "%.2f"|format(pago.monto) }} XAF</p>
                                  <p class="mb-1"><strong>Deuda actual:</strong> {{ "%.2f"|format(deuda_actual) }} XAF</p>
                                  <p class="mb-0"><strong>Cuotas pendientes:</strong> {{ cuotas_pendientes|length }}</p>
                                </div>
                                
                                <p><strong>Estudiante:</strong> {{ m.estudiante_nombre }}</p>
                                <p><strong>Cuota:</strong> {{ pago.numero_cuota }} - {{ "%.2f"|format(pago.monto) }} XAF</p>
                                
                                <div class="mb-3">
                                  <label class="form-label fw-bold">Comprobante de Pago</label>
                                  <input type="file" class="form-control" name="comprobante" accept=".pdf,.jpg,.jpeg,.png" required>
                                  <div class="form-text">Formatos permitidos: PDF, JPG, PNG (m√°x. 10MB)</div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">
                                  {{ 'Registrar' if pago.estado != 'RECHAZADO' else 'Actualizar' }} Pago
                                </button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endif %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center text-muted">No hay cuotas registradas</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Informaci√≥n de redistribuci√≥n -->
          {% if cuotas_pendientes|length > 0 %}
          <div class="alert alert-warning mt-3">
            <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>Informaci√≥n Importante</h6>
            <p class="mb-1">Los montos de las cuotas pendientes se actualizan autom√°ticamente cada vez que se valida un pago.</p>
            <p class="mb-0"><strong>Pr√≥xima actualizaci√≥n:</strong> La deuda actual de <strong>{{ "%.2f"|format(deuda_actual) }} XAF</strong> 
              se distribuir√° entre las <strong>{{ cuotas_pendientes|length }}</strong> cuotas pendientes.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Gesti√≥n de Pagos{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <h3 class="fw-bold mb-3 text-primary"><i class="fa-solid fa-money-bill"></i> Gesti√≥n de Pagos</h3>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white fw-bold">Estudiantes - MALABO</div>
                <ul class="list-group list-group-flush">
                    {% for m in malabo %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ m.estudiante_nombre }}
                        <a href="{{ url_for('pagos.ficha', matricula_id=m.id) }}" class="btn btn-sm btn-primary">Ficha de Pago</a>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">Sin estudiantes en Malabo</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white fw-bold">Estudiantes - BATA</div>
                <ul class="list-group list-group-flush">
                    {% for m in bata %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ m.estudiante_nombre }}
                        <a href="{{ url_for('pagos.ficha', matricula_id=m.id) }}" class="btn btn-sm btn-primary">Ficha de Pago</a>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">Sin estudiantes en Bata</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\modal_registro_pago.html
================================================================================




================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\pendientes.html
================================================================================

{% extends "base.html" %}
{% block title %}Pagos Pendientes de Validaci√≥n{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0"><i class="fas fa-clock me-2"></i>Pagos Pendientes de Validaci√≥n</h4>
        </div>
        <div class="card-body">
            {% if pagos %}
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-warning">
                        <tr>
                            <th>Estudiante</th>
                            <th>Curso</th>
                            <th>Cuota</th>
                            <th>Monto</th>
                            <th>Factura</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                        <tr>
                            <td>{{ pago.matricula.estudiante_nombre }}</td>
                            <td>{{ pago.matricula.curso.nombre }}</td>
                            <td>{{ pago.numero_cuota }}</td>
                            <td>{{ "%.0f"|format(pago.monto) }} XAF</td>
                            <td>
                                {% if pago.factura_path %}
                                    <a href="{{ url_for('pagos.ver_factura', pago_id=pago.id) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Ver
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('pagos.validar', pago_id=pago.id) }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-check"></i> Validar
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h5>No hay pagos pendientes de validaci√≥n</h5>
                <p>Todos los pagos han sido procesados.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\pagos\templates\pagos\validar_pago.html
================================================================================

{% extends "base.html" %}
{% block title %}Validar Pago{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i>Validar Pago</h4>
            <a href="{{ url_for('pagos.ficha', matricula_id=pago.matricula_id) }}" class="btn btn-outline-dark btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
        <div class="card-body">
            <h5 class="fw-bold text-success">{{ pago.matricula.estudiante_nombre }}</h5>
            <p><strong>Curso:</strong> {{ pago.matricula.curso.nombre }}</p>
            <p><strong>Cuota:</strong> {{ pago.numero_cuota }}</p>
            <p><strong>Monto:</strong> {{ "%.0f"|format(pago.monto) }} XAF</p>
            
            {% if pago.factura_path %}
            <div class="mb-3">
                <a href="{{ url_for('pagos.ver_factura', pago_id=pago.id) }}" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-eye me-1"></i> Ver Factura
                </a>
            </div>
            {% endif %}

            <form method="POST">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.motivo.label(class="form-label fw-semibold") }}
                    {{ form.motivo(class="form-control", rows="3", placeholder="Motivo del rechazo (opcional)") }}
                </div>
                
                <div class="d-flex gap-2 justify-content-end">
                    {{ form.rechazar(class="btn btn-danger") }}
                    {{ form.validar(class="btn btn-success") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\perfil\forms.py
================================================================================

from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, SubmitField
from wtforms.validators import DataRequired, Length, Email, EqualTo, Optional


class PerfilForm(FlaskForm):
    nombre_completo = StringField(
        "Nombre completo",
        validators=[DataRequired(message="Campo obligatorio"), Length(min=2, max=120)]
    )
    username = StringField(
        "Nombre de usuario",
        validators=[DataRequired(message="Campo obligatorio"), Length(min=3, max=50)]
    )
    email = StringField(
        "Correo electr√≥nico",
        validators=[Optional(), Email(message="Correo inv√°lido")]
    )

    submit = SubmitField("Guardar Cambios")


class CambiarContrasenaForm(FlaskForm):
    contrasena_actual = PasswordField(
        "Contrase√±a actual",
        validators=[DataRequired(message="Campo obligatorio")]
    )
    nueva_contrasena = PasswordField(
        "Nueva contrase√±a",
        validators=[
            DataRequired(message="Campo obligatorio"),
            Length(min=6, message="Debe tener al menos 6 caracteres")
        ]
    )
    confirmar_contrasena = PasswordField(
        "Confirmar nueva contrase√±a",
        validators=[
            DataRequired(message="Campo obligatorio"),
            EqualTo("nueva_contrasena", message="Las contrase√±as no coinciden")
        ]
    )

    submit = SubmitField("Actualizar Contrase√±a")



================================================================================
üìÅ Archivo: .\app\perfil\routes.py
================================================================================

from flask import render_template, redirect, url_for, flash
from flask_login import login_required, current_user
from app.extensions import db
from app.perfil.forms import PerfilForm, CambiarContrasenaForm

from app.perfil import bp


@bp.route("/ver")
@login_required
def ver_perfil():
    return render_template("perfil/ver.html", usuario=current_user)


@bp.route("/editar", methods=["GET", "POST"])
@login_required
def editar_perfil():
    form = PerfilForm(obj=current_user)
    if form.validate_on_submit():
        current_user.nombre_completo = form.nombre_completo.data
        current_user.username = form.username.data
        current_user.contacto = form.contacto.data
        db.session.commit()
        flash("Perfil actualizado correctamente.", "success")
        return redirect(url_for("perfil.ver_perfil"))
    return render_template("perfil/editar.html", form=form)


@bp.route("/cambiar-contrasena", methods=["GET", "POST"])
@login_required
def cambiar_contrasena():
    form = CambiarContrasenaForm()
    if form.validate_on_submit():
        if not current_user.check_password(form.contrasena_actual.data):
            flash("La contrase√±a actual no es correcta.", "danger")
        else:
            current_user.set_password(form.nueva_contrasena.data)
            db.session.commit()
            flash("Contrase√±a actualizada correctamente.", "success")
            return redirect(url_for("perfil.ver_perfil"))
    return render_template("perfil/cambiar_contrasena.html", form=form)



================================================================================
üìÅ Archivo: .\app\perfil\__init__.py
================================================================================

from flask import Blueprint

bp = Blueprint("perfil", __name__, template_folder="templates")

from app.perfil import routes  # noqa



================================================================================
üìÅ Archivo: .\app\perfil\templates\perfil\cambiar_contrasena.html
================================================================================

{% extends "base.html" %}
{% block title %}Cambiar Contrase√±a ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
      <h5 class="mb-0 text-success"><i class="fas fa-key me-2"></i>Cambiar Contrase√±a</h5>
    </div>

    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}

        <div class="row">
          <div class="col-md-6 mb-3">
            {{ form.contrasena_actual.label(class="form-label fw-semibold") }}
            {{ form.contrasena_actual(class="form-control", placeholder="Contrase√±a actual") }}
            {% for error in form.contrasena_actual.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6 mb-3">
            {{ form.nueva_contrasena.label(class="form-label fw-semibold") }}
            {{ form.nueva_contrasena(class="form-control", placeholder="Nueva contrase√±a") }}
            {% for error in form.nueva_contrasena.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6 mb-3">
            {{ form.confirmar_contrasena.label(class="form-label fw-semibold") }}
            {{ form.confirmar_contrasena(class="form-control", placeholder="Confirmar nueva contrase√±a") }}
            {% for error in form.confirmar_contrasena.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <a href="{{ url_for('perfil.ver_perfil') }}" class="btn btn-outline-secondary me-2">Cancelar</a>
          <button type="submit" class="btn btn-success">Actualizar Contrase√±a</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\perfil\templates\perfil\editar.html
================================================================================

{% extends "base.html" %}
{% block title %}Editar Perfil ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
      <h5 class="mb-0 text-success"><i class="fas fa-user-edit me-2"></i>Editar Perfil</h5>
    </div>

    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}

        <div class="row">
          <div class="col-md-6 mb-3">
            {{ form.nombre_completo.label(class="form-label fw-semibold") }}
            {{ form.nombre_completo(class="form-control", placeholder="Nombre completo") }}
            {% for error in form.nombre_completo.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6 mb-3">
            {{ form.email.label(class="form-label fw-semibold") }}
            {{ form.email(class="form-control", placeholder="Correo electr√≥nico") }}
            {% for error in form.email.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            {{ form.username.label(class="form-label fw-semibold") }}
            {{ form.username(class="form-control", placeholder="Nombre de usuario") }}
            {% for error in form.username.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Rol</label>
            <input type="text" class="form-control bg-light" readonly
                   value="{{ current_user.roles | map(attribute='nombre') | join(', ') or 'Sin rol asignado' }}">
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <a href="{{ url_for('perfil.ver_perfil') }}" class="btn btn-outline-secondary me-2">Cancelar</a>
          <button type="submit" class="btn btn-success">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\perfil\templates\perfil\ver.html
================================================================================

{% extends "base.html" %}
{% block title %}Mi Perfil ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-success"><i class="fas fa-user-circle me-2"></i>Mi Perfil</h5>
      <div>
        <a href="{{ url_for('perfil.editar_perfil') }}" class="btn btn-outline-success btn-sm me-2">
          <i class="fas fa-edit"></i> Editar Perfil
        </a>
        <a href="{{ url_for('perfil.cambiar_contrasena') }}" class="btn btn-success btn-sm">
          <i class="fas fa-key"></i> Cambiar Contrase√±a
        </a>
      </div>
    </div>

    <div class="card-body">
      <div class="row mb-2">
        <div class="col-md-6">
          <p><strong>Nombre completo:</strong> {{ current_user.nombre_completo or current_user.username }}</p>
          <p><strong>Usuario:</strong> {{ current_user.username }}</p>
          <p><strong>Email:</strong> {{ current_user.email or '‚Äî' }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Rol:</strong> {{ current_user.roles | map(attribute='nombre') | join(', ') or 'Sin rol asignado' }}</p>
          <p><strong>√öltimo acceso:</strong> {{ current_user.ultimo_login.strftime('%d/%m/%Y %H:%M') if current_user.ultimo_login else '‚Äî' }}</p>
          <p><strong>Estado:</strong>
            <span class="badge {{ 'bg-success' if current_user.activo else 'bg-secondary' }}">
              {{ 'Activo' if current_user.activo else 'Bloqueado' }}
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\proyectos\routes.py
================================================================================

from flask import render_template
from flask_login import login_required
from . import bp

@bp.route("/")
@login_required
def index():
    return render_template("placeholder.html", title="Proyectos", message="Gestion y seguimiento de proyectos.")



================================================================================
üìÅ Archivo: .\app\proyectos\__init__.py
================================================================================

from flask import Blueprint
bp = Blueprint("proyectos", __name__, template_folder="templates")
from . import routes  # noqa



================================================================================
üìÅ Archivo: .\app\static\css\main.css
================================================================================

body {
  font-family: "Poppins", sans-serif;
  background-color: #f8f9fa;
  color: #212529;
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.navbar {
  background-color: #2a7b3f !important;
}

.btn-success, .bg-success {
  background-color: #2a7b3f !important;
  border-color: #2a7b3f !important;
}
.btn-outline-success:hover {
  background-color: #2a7b3f !important;
  color: #fff !important;
}

.dashboard-header h1 {
  color: #2a7b3f;
  font-weight: 700;
}
.dashboard-header .lead {
  color: #6c757d;
}

.perfil-box {
  transition: all 0.2s ease-in-out;
}
.perfil-box:hover {
  background-color: #f3f9f4;
  transform: translateY(-2px);
}

.stat-card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: start;
  gap: 15px;
  transition: all 0.3s ease;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
}
.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.stat-icon {
  font-size: 2rem;
  color: #2a7b3f;
}

.stat-info h3 {
  margin: 0;
  font-weight: 600;
}
.stat-info p {
  margin: 0;
  color: #6c757d;
}

.module-card {
  background: #fff;
  border-radius: 14px;
  padding: 25px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease-in-out;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
}
.module-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}
.module-icon {
  font-size: 2.5rem;
  color: #2a7b3f;
  margin-bottom: 10px;
}
.module-info h3 {
  font-size: 1.1rem;
  font-weight: 600;
}
.module-info p {
  font-size: 0.9rem;
  color: #6c757d;
}
.badge.bg-success {
  background-color: #2a7b3f !important;
}

.fade-in {
  animation: fadeIn 0.5s ease-in-out;
}
/* ===========================
   ESTILO GLOBAL INSTITUCIONAL
   =========================== */
body {
  font-family: 'Poppins', sans-serif;
  background-color: #f8f9fa;
  color: #333;
  margin: 0;
  padding: 0;
}

h1, h2, h3, h4 {
  font-family: 'Roboto Slab', serif;
}

a {
  text-decoration: none;
}

/* ===========================
   NAVBAR SUPERIOR
   =========================== */
.navbar {
  background-color: #2A7B3F !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.navbar-brand {
  font-weight: 700;
  color: #fff !important;
  letter-spacing: 0.5px;
}

.navbar-brand:hover {
  color: #d4edda !important;
}

.navbar-nav .nav-link {
  color: #f8f9fa !important;
  font-weight: 500;
  transition: 0.3s ease;
}

.navbar-nav .nav-link:hover {
  color: #c6f6d5 !important;
}

.navbar-logo {
  height: 45px;
}

/* ===========================
   TITULOS DEL DASHBOARD
   =========================== */
.dashboard-container h1 {
  font-size: 2.2rem;
  font-weight: 700;
  color: #2A7B3F;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dashboard-container p.lead {
  color: #555;
  font-weight: 500;
  letter-spacing: 0.3px;
}

/* ===========================
   TARJETAS DE M√âTRICAS
   =========================== */
.stat-card {
  background: #fff;
  border-radius: 14px;
  padding: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
  font-size: 2rem;
  color: #2A7B3F;
}

.stat-info h3 {
  font-size: 1.6rem;
  font-weight: 700;
  color: #2A7B3F;
  margin-bottom: 0;
}

.stat-info p {
  color: #777;
  margin: 0;
}

/* ===========================
   M√ìDULOS DEL SISTEMA
   =========================== */
.modules-grid {
  margin-top: 2rem;
}

.module-card {
  background: #fff;
  border-radius: 14px;
  padding: 1.2rem;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  border: 1px solid #e5e5e5;
}

.module-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.15);
  border-color: #2A7B3F;
}

.module-icon i {
  font-size: 2rem;
  color: #2A7B3F;
}

.module-info h5, .module-info h3 {
  font-weight: 600;
  color: #2A7B3F;
}

.module-info p {
  color: #666;
  font-size: 0.9rem;
}

.module-status .badge {
  font-size: 0.8rem;
  padding: 6px 10px;
  border-radius: 10px;
}

/* ===========================
   BOTONES GENERALES
   =========================== */
.btn-success {
  background-color: #2A7B3F !important;
  border-color: #2A7B3F !important;
}

.btn-success:hover {
  background-color: #256c38 !important;
  border-color: #256c38 !important;
}

.btn-outline-success {
  color: #2A7B3F !important;
  border-color: #2A7B3F !important;
}

.btn-outline-success:hover {
  background-color: #2A7B3F !important;
  color: #fff !important;
}

/* ===========================
   ALERTAS Y FLASH MESSAGES
   =========================== */
.alert {
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ===========================
   PIE DE P√ÅGINA
   =========================== */
footer {
  text-align: center;
  font-size: 0.9rem;
  color: #666;
  padding: 1rem 0;
  border-top: 1px solid #ddd;
  margin-top: 2rem;
}

/* ===========================
   RESPONSIVE
   =========================== */
@media (max-width: 992px) {
  .module-card {
    text-align: center;
  }
  .module-icon i {
    font-size: 2.4rem;
    margin-bottom: 0.5rem;
  }
}
/* =====================================================
   BANGE Business School - Sistema de Gesti√≥n Escolar
   Estilo visual institucional + paleta complementaria
   ===================================================== */

/* ----------- Fuentes y cuerpo general ----------- */
body {
  font-family: "Poppins", "Roboto", sans-serif;
  background-color: #f8f9fa;
  color: #333;
  line-height: 1.5;
}

h1, h2, h3, h4, h5 {
  font-family: "Roboto Slab", serif;
  color: #2A7B3F;
}

a {
  text-decoration: none;
  color: #2A7B3F;
}

a:hover {
  color: #1f5e30;
  text-decoration: underline;
}

/* ----------- Navbar superior ----------- */
.navbar {
  background: linear-gradient(90deg, #2A7B3F 0%, #256735 100%);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
}

.navbar .navbar-brand {
  font-weight: 600;
  letter-spacing: 0.5px;
}

.navbar .navbar-logo {
  height: 40px;
}

.navbar-nav .nav-item .nav-link {
  color: #ffffffcc !important;
  font-weight: 500;
}

.navbar-nav .nav-item .nav-link:hover {
  color: #fff !important;
}

/* ----------- Botones ----------- */
.btn-success {
  background-color: #2A7B3F;
  border: none;
}

.btn-success:hover {
  background-color: #256735;
}

.btn-outline-success {
  border-color: #2A7B3F;
  color: #2A7B3F;
}

.btn-outline-success:hover {
  background-color: #2A7B3F;
  color: #fff;
}

/* ----------- Tarjetas generales ----------- */
.card {
  border-radius: 0.8rem;
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-3px);
}

/* ----------- Dashboard de m√©tricas ----------- */
.stat-card {
  border-radius: 0.8rem;
  color: #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
}

/* Paleta complementaria para m√©tricas */
.bg-success {
  background: linear-gradient(135deg, #2A7B3F, #3FA55B) !important;
}

.bg-warning {
  background: linear-gradient(135deg, #FFD86F, #E8B02C) !important;
}

.bg-danger {
  background: linear-gradient(135deg, #C94C4C, #A33232) !important;
}

/* ----------- Tarjetas de cursos ----------- */
.course-tile {
  border-radius: 0.8rem;
  background: #fff;
  transition: all 0.3s ease;
  border: 1px solid #e0e0e0;
}

.course-tile:hover {
  transform: translateY(-6px);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1);
}

.course-tile h5 {
  color: #2A7B3F;
}

.course-tile .badge {
  font-size: 0.8rem;
  border-radius: 0.5rem;
}

/* ----------- T√≠tulos y encabezados ----------- */
.section-title {
  font-weight: 600;
  font-size: 1.3rem;
  color: #256735;
  border-left: 5px solid #2A7B3F;
  padding-left: 10px;
}

/* ----------- Tablas ----------- */
.table {
  font-size: 0.9rem;
}

.table thead {
  background-color: #2A7B3F;
  color: #fff;
}

.table-striped > tbody > tr:nth-of-type(odd) {
  background-color: #f4f7f4;
}

/* ----------- Formularios ----------- */
.form-control, .form-select {
  border-radius: 0.5rem;
  border: 1px solid #d0d0d0;
}

.form-control:focus, .form-select:focus {
  border-color: #2A7B3F;
  box-shadow: 0 0 0 0.25rem rgba(42, 123, 63, 0.2);
}

/* ----------- Alertas ----------- */
.alert {
  border-radius: 0.6rem;
  font-size: 0.95rem;
}

/* ----------- Badges ----------- */
.badge {
  font-weight: 500;
  padding: 0.4em 0.6em;
  border-radius: 0.4rem;
}

/* ----------- Sombras y efectos ----------- */
.shadow-soft {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
}

.shadow-hover:hover {
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

/* ----------- Fade-in animaci√≥n ----------- */
.fade-in {
  animation: fadeIn 0.6s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ----------- Tarjetas de m√≥dulos y secciones ----------- */
.module-card, .module-tile {
  border-radius: 0.8rem;
  background-color: #fff;
  border: 1px solid #e6e6e6;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.module-card:hover, .module-tile:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

/* ----------- Footer (si lo hubiera) ----------- */
footer {
  background-color: #2A7B3F;
  color: #fff;
  text-align: center;
  padding: 1rem;
  font-size: 0.85rem;
  margin-top: 2rem;
}

/* ----------- Scrollbar personalizado ----------- */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-thumb {
  background-color: #3FA55B;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background-color: #2A7B3F;
}



================================================================================
üìÅ Archivo: .\app\static\js\main.js
================================================================================

// main.js
document.addEventListener('DOMContentLoaded', function () {
  // Bot√≥n submit -> loading
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function () {
      const btn = this.querySelector('button[type="submit"]');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
      }
    });
  });

  // Hover suave para module-card
  document.querySelectorAll('.module-card').forEach(card => {
    card.addEventListener('mouseenter', () => {
      card.style.transform = 'translateY(-8px) scale(1.02)';
    });
    card.addEventListener('mouseleave', () => {
      card.style.transform = 'translateY(0) scale(1)';
    });
  });

  // Tooltips Bootstrap
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

  // Lazy-load de im√°genes data-src (opcional)
  if ('IntersectionObserver' in window) {
    const lazyImages = document.querySelectorAll('img[data-src]');
    const obs = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.add('loaded');
          obs.unobserve(img);
        }
      });
    });
    lazyImages.forEach(img => obs.observe(img));
  }
});

document.addEventListener("DOMContentLoaded", () => {
  // Desaparece autom√°ticamente los mensajes flash
  const alerts = document.querySelectorAll(".alert");
  alerts.forEach((alert) => {
    setTimeout(() => {
      alert.classList.remove("show");
    }, 4000);
  });
});

document.addEventListener("DOMContentLoaded", () => {
  // Efecto de hover suave en las tarjetas
  document.querySelectorAll(".module-card, .stat-card").forEach(card => {
    card.addEventListener("mouseenter", () => {
      card.style.transition = "transform 0.25s ease, box-shadow 0.25s ease";
    });
  });

  // Cierre autom√°tico de alertas flash
  const alerts = document.querySelectorAll(".alert");
  alerts.forEach(a => {
    setTimeout(() => {
      a.classList.remove("show");
    }, 4000);
  });
});



================================================================================
üìÅ Archivo: .\app\templates\base.html
================================================================================

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}BANGE Business School ‚Äî Gesti√≥n Escolar{% endblock %}</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Roboto+Slab:wght@400;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <!-- Estilos propios -->
  <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>

<body class="bg-light">

  <!-- NAVBAR SUPERIOR GLOBAL -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top" style="background-color: #2A7B3F;">
    <div class="container-fluid">
      <!-- Logo institucional -->
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('core.dashboard') }}">
        <img src="{{ url_for('static', filename='img/logo-bbs.jpg') }}" alt="Logo Institucional" height="45" class="me-2">
        <span class="fw-bold">BANGE BUSINESS SCHOOL</span>
      </a>

      <!-- Bot√≥n colapsable m√≥vil -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Men√∫ principal -->
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">

          {% if current_user.is_authenticated %}
            {% set roles = current_user.roles | map(attribute='nombre') | list %}

            <!-- Panel principal -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('core.dashboard') }}"><i class="fas fa-home me-1"></i> Inicio</a></li>

            <!-- Gesti√≥n de Usuarios (solo Administradores) -->
            {% if 'Administrador' in roles %}
              <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('usuarios.index') }}"><i class="fas fa-users-cog me-1"></i> Usuarios</a></li>
            {% endif %}

            <!-- Documentos -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('documentos.index') }}"><i class="fas fa-file-alt me-1"></i> Documentos</a></li>

            <!-- Cursos -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('cursos.index') }}"><i class="fas fa-book-open me-1"></i> Cursos</a></li>

            <!-- Matr√≠culas -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('matriculas.index') }}"><i class="fas fa-user-graduate me-1"></i> Matr√≠culas</a></li>

            <!-- Pagos -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('pagos.index') }}"><i class="fas fa-credit-card me-1"></i> Pagos</a></li>

            <!-- Actas y Expedientes -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('actas_expedientes.index') }}"><i class="fas fa-file-contract me-1"></i> Actas</a></li>

            <!-- Validaciones -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('matriculas.validaciones_index') }}"><i class="fas fa-check-double me-1"></i> Validaciones</a></li>

            <!-- Proyectos -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('proyectos.index') }}"><i class="fas fa-project-diagram me-1"></i> Proyectos</a></li>

            <!-- Estad√≠sticas -->
            <li class="nav-item"><a class="nav-link text-white" href="{{ url_for('estadisticas.index') }}"><i class="fas fa-chart-line me-1"></i> Estad√≠sticas</a></li>

            <!-- Perfil -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-white" href="#" id="perfilDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle me-1"></i> {{ current_user.nombre_completo or current_user.username }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ url_for('perfil.ver_perfil') }}"><i class="fas fa-id-card me-1"></i> Ver perfil</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{{ url_for('usuarios.logout') }}"><i class="fa-solid fa-right-from-bracket me-1"></i> Cerrar sesi√≥n</a></li>
              </ul>
            </li>

          {% else %}
            <li class="nav-item">
              <a class="btn btn-light btn-sm" href="{{ url_for('usuarios.login') }}">
                <i class="fa-solid fa-right-to-bracket me-1"></i> Entrar
              </a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <main class="py-4">
    <div class="container-fluid">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
            {% for category, message in messages %}
              <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show shadow">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>


================================================================================
üìÅ Archivo: .\app\templates\placeholder.html
================================================================================

{% extends "base.html" %}
{% block title %}{{ title }} ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0"><i class="fas fa-cogs me-2"></i>{{ title }}</h4>
        </div>
        <div class="card-body text-center py-5">
            <i class="fas fa-tools fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">M√≥dulo en Desarrollo</h5>
            <p class="text-muted">{{ message }}</p>
            <a href="{{ url_for('core.dashboard') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-1"></i> Volver al Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\usuarios\forms.py
================================================================================

from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, BooleanField, SubmitField, SelectMultipleField
from wtforms.validators import DataRequired, Length, EqualTo, ValidationError
from app.usuarios.models import Usuario

class UsuarioForm(FlaskForm):
    username = StringField(
        "Nombre de usuario",
        validators=[DataRequired(), Length(min=3, max=50)]
    )
    full_name = StringField("Nombre completo", validators=[DataRequired()])
    email = StringField("Correo electr√≥nico (opcional)")  # sin Email()
    password = PasswordField("Contrase√±a", validators=[DataRequired(), Length(min=8)])
    confirm_password = PasswordField(
        "Confirmar contrase√±a",
        validators=[DataRequired(), EqualTo("password", message="Las contrase√±as no coinciden.")]
    )
    activo = BooleanField("Activo", default=True)
    roles = SelectMultipleField("Roles", coerce=int)
    submit = SubmitField("Guardar")

    def validate_username(self, username):
        if Usuario.query.filter_by(username=username.data).first():
            raise ValidationError("Ese nombre de usuario ya existe.")

class EditarUsuarioForm(FlaskForm):
    username = StringField("Nombre de usuario", validators=[DataRequired()])
    full_name = StringField("Nombre completo", validators=[DataRequired()])
    email = StringField("Correo electr√≥nico (opcional)")
    activo = BooleanField("Activo")
    roles = SelectMultipleField("Roles", coerce=int)
    submit = SubmitField("Actualizar")



================================================================================
üìÅ Archivo: .\app\usuarios\models.py
================================================================================

from datetime import datetime
from werkzeug.security import generate_password_hash, check_password_hash
from flask_login import UserMixin
from app import db
from app.models_shared import user_roles, ActividadUsuario

class Usuario(UserMixin, db.Model):
    __tablename__ = "usuarios"
    __table_args__ = {"extend_existing": True}

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    full_name = db.Column(db.String(120), nullable=False)
    email = db.Column(db.String(120), nullable=True)  # sin validaci√≥n por ahora
    password_hash = db.Column(db.String(255), nullable=False)
    activo = db.Column(db.Boolean, default=True)
    sesion_activa = db.Column(db.Boolean, default=False)
    ultimo_login = db.Column(db.DateTime, nullable=True)
    creado_en = db.Column(db.DateTime, default=datetime.utcnow)

    roles = db.relationship(
        "Role",
        secondary=user_roles,
        backref=db.backref("usuarios", lazy="dynamic"),
        lazy="joined",
    )

    # Relaci√≥n con actividades (coherente con back_populates en ActividadUsuario)
    actividades = db.relationship("ActividadUsuario", back_populates="usuario", lazy="dynamic")

    def set_password(self, password: str):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password: str) -> bool:
        return check_password_hash(self.password_hash, password)

    def __repr__(self):
        return f"<Usuario {self.username}>"

class Role(db.Model):
    __tablename__ = "roles"
    __table_args__ = {"extend_existing": True}

    id = db.Column(db.Integer, primary_key=True)
    nombre = db.Column(db.String(50), unique=True, nullable=False)
    descripcion = db.Column(db.String(200), nullable=True)

    def __repr__(self):
        return f"<Role {self.nombre}>"



================================================================================
üìÅ Archivo: .\app\usuarios\routes.py
================================================================================

# app/usuarios/routes.py
from flask import render_template, redirect, url_for, flash, request, abort
from flask_login import login_required, current_user, login_user, logout_user
from datetime import datetime
from app import db
from app.usuarios import bp
from app.usuarios.models import Usuario, Role
from app.usuarios.forms import UsuarioForm, EditarUsuarioForm
from app.models_shared import ActividadUsuario

# ===== Definir LoginForm directamente aqu√≠ para evitar problemas de importaci√≥n =====
from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, SubmitField
from wtforms.validators import DataRequired, Length

from functools import wraps

class LoginForm(FlaskForm):
    username = StringField('Usuario', validators=[DataRequired(), Length(min=3, max=80)])
    password = PasswordField('Contrase√±a', validators=[DataRequired(), Length(min=1)])
    submit = SubmitField('Iniciar Sesi√≥n')

# ===== Utilidad de registro de actividad =====
def registrar_actividad(usuario, accion, detalles=None):
    if not usuario:
        return
    act = ActividadUsuario(
        usuario_id=usuario.id,
        accion=accion,
        ip=request.remote_addr,
        agente=request.user_agent.string[:255] if request.user_agent.string else None,
        detalles=detalles,
    )
    db.session.add(act)
    db.session.commit()

# ===== Helper de permisos =====
def is_admin_user():
    """Devuelve True si current_user tiene el rol 'Administrador'"""
    if not current_user or not getattr(current_user, "is_authenticated", False):
        return False
    try:
        return any(getattr(r, "nombre", "") == "Administrador" for r in current_user.roles)
    except Exception:
        return False

def admin_required(f):
    """Decorator que aborta con 403 si el usuario no es administrador"""
    @wraps(f)
    def decorated(*args, **kwargs):
        if not is_admin_user():
            abort(403)
        return f(*args, **kwargs)
    return decorated

# ===== Listado =====
@bp.route("/")
@login_required
@admin_required
def index():
    usuarios = Usuario.query.order_by(Usuario.id.desc()).all()
    roles = Role.query.order_by(Role.nombre.asc()).all()
    return render_template("usuarios/index.html", usuarios=usuarios, roles=roles)

# ===== Crear =====
@bp.route("/nuevo", methods=["GET", "POST"])
@login_required
@admin_required
def nuevo():
    form = UsuarioForm()
    form.roles.choices = [(r.id, r.nombre) for r in Role.query.order_by(Role.nombre.asc()).all()]
    if form.validate_on_submit():
        u = Usuario(
            username=form.username.data,
            full_name=form.full_name.data,
            email=form.email.data,
            activo=form.activo.data
        )
        u.set_password(form.password.data)
        u.roles = [Role.query.get(rid) for rid in form.roles.data]
        db.session.add(u)
        db.session.commit()
        registrar_actividad(current_user, f"Cre√≥ usuario {u.username}")
        flash("Usuario creado correctamente.", "success")
        return redirect(url_for("usuarios.index"))
    return render_template("usuarios/nuevo.html", form=form)

# ===== Editar =====
@bp.route("/editar/<int:id>", methods=["GET", "POST"])
@login_required
@admin_required
def editar(id):
    usuario = Usuario.query.get_or_404(id)
    form = EditarUsuarioForm(obj=usuario)
    form.roles.choices = [(r.id, r.nombre) for r in Role.query.order_by(Role.nombre.asc()).all()]
    if form.validate_on_submit():
        usuario.username = form.username.data
        usuario.full_name = form.full_name.data
        usuario.email = form.email.data
        usuario.activo = form.activo.data
        usuario.roles = [Role.query.get(rid) for rid in form.roles.data]
        db.session.commit()
        registrar_actividad(current_user, f"Edit√≥ usuario {usuario.username}")
        flash("Usuario actualizado.", "success")
        return redirect(url_for("usuarios.index"))
    # pre-selecci√≥n de roles
    form.roles.data = [r.id for r in usuario.roles]
    return render_template("usuarios/editar.html", form=form, usuario=usuario)

# ===== Bloquear / activar =====
@bp.route("/bloquear/<int:id>")
@login_required
@admin_required
def bloquear(id):
    usuario = Usuario.query.get_or_404(id)
    usuario.activo = not usuario.activo
    db.session.commit()
    estado = "activ√≥" if usuario.activo else "bloque√≥"
    registrar_actividad(current_user, f"{estado} usuario {usuario.username}")
    flash(f"Usuario {estado} correctamente.", "info")
    return redirect(url_for("usuarios.index"))

# ===== Login =====
@bp.route("/login", methods=["GET", "POST"])
def login():
    # Si el usuario ya est√° autenticado, redirigir al dashboard
    if current_user.is_authenticated:
        return redirect(url_for("core.dashboard"))
    
    form = LoginForm()
    
    if form.validate_on_submit():
        username = form.username.data.strip()
        password = form.password.data
        user = Usuario.query.filter_by(username=username).first()

        if user and user.check_password(password) and user.activo:
            login_user(user, remember=True)
            user.ultimo_login = datetime.utcnow()
            user.sesion_activa = True
            db.session.commit()
            registrar_actividad(user, "Inicio de sesi√≥n", request.remote_addr)
            flash("Bienvenido.", "success")
            return redirect(url_for("core.dashboard"))
        else:
            # registrar_actividad(None, "Intento fallido de inicio de sesi√≥n", request.remote_addr)
            # No registrar actividad con usuario None para evitar errores en activiadad table
            flash("Credenciales inv√°lidas o usuario inactivo.", "error")
    
    return render_template("usuarios/login.html", form=form)

# ===== Logout =====
@bp.route("/logout")
@login_required
def logout():
    registrar_actividad(current_user, "Cierre de sesi√≥n")
    current_user.sesion_activa = False
    db.session.commit()
    logout_user()
    flash("Sesi√≥n cerrada correctamente.", "success")
    return redirect(url_for("usuarios.login"))

# ===== Ruta auxiliar para redirecci√≥n de edici√≥n desde otros m√≥dulos (mantener pero protegida) =====
@bp.route("/editar-redirect/<int:id>")
@login_required
@admin_required
def editar_usuario(id):
    # redirige al editor de perfil/usuario del admin
    return redirect(url_for("perfil.editar_perfil", id=id))


================================================================================
üìÅ Archivo: .\app\usuarios\__init__.py
================================================================================

from flask import Blueprint

bp = Blueprint("usuarios", __name__, template_folder="templates")

from . import routes  # noqa



================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\detalles.html
================================================================================




================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\editar.html
================================================================================

{% extends "base.html" %}
{% block title %}Editar usuario ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="container">
  <h3 class="fw-bold text-success mb-4">
    <i class="fa-solid fa-user-pen me-2"></i> Editar usuario
  </h3>

  <form method="post">
    {{ form.hidden_tag() }}

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nombre de usuario</label>
        {{ form.username(class="form-control") }}
        {% for e in form.username.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        <label class="form-label">Nombre completo</label>
        {{ form.full_name(class="form-control") }}
        {% for e in form.full_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-md-6">
        <label class="form-label">Correo (opcional)</label>
        {{ form.email(class="form-control") }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Roles</label>
        {{ form.roles(class="form-select", multiple=true) }}
      </div>

      <div class="col-md-6 d-flex align-items-end">
        <div class="form-check">
          {{ form.activo(class="form-check-input") }}
          <label class="form-check-label">Activo</label>
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-success">
        <i class="fa-solid fa-floppy-disk me-1"></i> Actualizar
      </button>
      <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline-secondary">Volver</a>
    </div>
  </form>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\form.html
================================================================================

{% extends "base.html" %}
{% block title %}{{ accion }} Usuario{% endblock %}
{% block content %}
<h3 class="fw-bold text-success"><i class="fas fa-user me-2"></i>{{ accion }} Usuario</h3>
<form method="post" novalidate>
  {{ form.hidden_tag() }}
  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.username.label(class="form-label") }}
      {{ form.username(class="form-control") }}
      {% for e in form.username.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.email.label(class="form-label") }}
      {{ form.email(class="form-control") }}
      {% for e in form.email.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.nombre_completo.label(class="form-label") }}
      {{ form.nombre_completo(class="form-control") }}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.password.label(class="form-label") }}
      {{ form.password(class="form-control") }}
      <div class="form-text">Opcional en edici√≥n. Reglas: 8+ caracteres, may√∫scula, min√∫scula, n√∫mero y s√≠mbolo.</div>
      {% for e in form.password.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
  </div>

  <div class="mb-3">
    {{ form.roles.label(class="form-label") }}
    {{ form.roles(class="form-select", size=4) }}
  </div>

  <div class="form-check mb-3">
    {{ form.activo(class="form-check-input", id="activoCheck") }}
    <label for="activoCheck" class="form-check-label">Activo</label>
  </div>

  <button class="btn btn-success">{{ form.submit.label }}</button>
  <a href="{{ url_for('usuarios.index') }}" class="btn btn-secondary">Cancelar</a>
</form>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Gesti√≥n de Usuarios ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="container-fluid">
  <h3 class="fw-bold text-success mb-4">
    <i class="fa-solid fa-users me-2"></i> Gesti√≥n de Usuarios
  </h3>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <form class="d-flex" method="get" action="{{ url_for('usuarios.index') }}">
      <input type="text" name="q" class="form-control form-control-sm me-2" placeholder="Buscar usuario...">
      <button type="submit" class="btn btn-outline-success btn-sm">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </form>
    <a href="{{ url_for('usuarios.nuevo') }}" class="btn btn-success btn-sm">
      <i class="fa-solid fa-plus me-1"></i> Nuevo usuario
    </a>
  </div>

  <div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle">
      <thead class="table-success text-center">
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Nombre completo</th>
          <th>Correo</th>
          <th>Roles</th>
          <th>Estado</th>
          <th>√öltimo acceso</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr class="text-center">
          <td>{{ u.id }}</td>
          <td class="fw-semibold">{{ u.username }}</td>
          <td>{{ u.full_name }}</td>
          <td>{{ u.email or "‚Äî" }}</td>
          <td>{{ u.roles | map(attribute='nombre') | join(', ') }}</td>
          <td>
            {% if u.activo %}
              <span class="badge bg-success">Activo</span>
            {% else %}
              <span class="badge bg-danger">Bloqueado</span>
            {% endif %}
          </td>
          <td>
            {% if u.ultimo_login %}
              {{ u.ultimo_login.strftime('%d/%m/%Y %H:%M') }}
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <a href="{{ url_for('usuarios.editar', id=u.id) }}" class="btn btn-outline-success" title="Editar">
                <i class="fa-solid fa-pen-to-square"></i>
              </a>
              {% if u.activo %}
                <a href="{{ url_for('usuarios.bloquear', id=u.id) }}" class="btn btn-outline-danger" title="Bloquear">
                  <i class="fa-solid fa-user-slash"></i>
                </a>
              {% else %}
                <a href="{{ url_for('usuarios.bloquear', id=u.id) }}" class="btn btn-outline-success" title="Activar">
                  <i class="fa-solid fa-user-check"></i>
                </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            <i class="fa-solid fa-circle-info me-2"></i> No hay usuarios registrados.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\login.html
================================================================================

{% extends "base.html" %}
{% block title %}Acceso ‚Äî BBS{% endblock %}
{% block content %}

<div class="row justify-content-center align-items-center min-vh-75 px-3">
  <div class="col-12 col-md-10 col-lg-8">
    <div class="card border-0 shadow-lg overflow-hidden">
      <div class="row g-0">
        <!-- Lado verde con marca -->
        <div class="col-lg-5 d-none d-lg-flex flex-column justify-content-center text-white p-4" style="background:#2A7B3F;">
          <div class="text-center">
            <img src="{{ url_for('static', filename='img/logo-bbs.png') }}" alt="BANGE" class="login-logo mb-3" onerror="this.style.display='none'">
            <h2 class="fw-bold mb-1">BANGE BUSINESS SCHOOL</h2>
            <p class="mb-0 opacity-75">Sistema de Gesti√≥n Escolar</p>
          </div>
        </div>

        <!-- Formulario -->
        <div class="col-lg-7 bg-white">
          <div class="p-4 p-md-5">
            <h3 class="fw-bold mb-3"><i class="fa-solid fa-right-to-bracket me-2"></i>Iniciar sesi√≥n</h3>
            <p class="text-muted mb-4">Introduce tus credenciales para acceder al panel.</p>

            <form method="post" novalidate>
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.username.label(class="form-label") }}
                    {{ form.username(class="form-control form-control-lg", placeholder="admin") }}
                </div>
                <div class="mb-3">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(class="form-control form-control-lg", placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢") }}
                </div>
                {{ form.submit(class="btn btn-primary btn-lg w-100") }}
            </form>

            <div class="text-center mt-3 small text-muted">
              ¬© {{ hoy.year if hoy else '' }} BANGE Business School
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\nuevo.html
================================================================================

{% extends "base.html" %}
{% block title %}Nuevo usuario ‚Äî BANGE Business School{% endblock %}

{% block content %}
<div class="container">
  <h3 class="fw-bold text-success mb-4">
    <i class="fa-solid fa-user-plus me-2"></i> Nuevo usuario
  </h3>

  <form method="post">
    {{ form.hidden_tag() }}

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nombre de usuario</label>
        {{ form.username(class="form-control", placeholder="usuario") }}
        {% for e in form.username.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        <label class="form-label">Nombre completo</label>
        {{ form.full_name(class="form-control", placeholder="Nombre Apellidos") }}
        {% for e in form.full_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        <label class="form-label">Correo (opcional)</label>
        {{ form.email(class="form-control", placeholder="correo@ejemplo.com") }}
      </div>

      <div class="col-md-3">
        <label class="form-label">Contrase√±a</label>
        {{ form.password(class="form-control") }}
        {% for e in form.password.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Confirmar</label>
        {{ form.confirm_password(class="form-control") }}
        {% for e in form.confirm_password.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-md-6">
        <label class="form-label">Roles</label>
        {{ form.roles(class="form-select", multiple=true) }}
      </div>
      <div class="col-md-6 d-flex align-items-end">
        <div class="form-check">
          {{ form.activo(class="form-check-input") }}
          <label class="form-check-label">Activo</label>
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-success">
        <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
      </button>
      <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\usuarios\templates\usuarios\recuperar.html
================================================================================

{% extends "base.html" %}
{% block title %}{% if reset %}Restablecer Contrase√±a{% else %}Recuperar Contrase√±a{% endif %}{% endblock %}
{% block content %}
<div class="col-md-6 mx-auto">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="text-success fw-bold mb-3">
        <i class="fas fa-key me-2"></i>{% if reset %}Restablecer Contrase√±a{% else %}Recuperar Contrase√±a{% endif %}
      </h4>
      <form method="post">
        {{ form.hidden_tag() }}
        {% if reset %}
          {{ form.password.label(class="form-label") }}
          {{ form.password(class="form-control mb-3") }}
          {% for e in form.password.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        {% else %}
          {{ form.email.label(class="form-label") }}
          {{ form.email(class="form-control mb-3") }}
          {% for e in form.email.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        {% endif %}
        {{ form.submit(class="btn btn-success") }}
        <a href="{{ url_for('auth.login') }}" class="btn btn-secondary ms-2">Volver</a>
      </form>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\validaciones\routes.py
================================================================================

# app/validaciones/routes.py

from flask import (
    render_template,
    redirect,
    url_for,
    flash,
    request,
    abort
)
from flask_login import login_required, current_user
from datetime import date
from app.extensions import db
from . import bp
from app.pagos.routes import redistribuir_cuotas_pendientes

# --- MODELOS Y CONSTANTES ---
from app.cursos.models import (
    Curso,
    Programacion,
    ESTADO_BORRADOR,
    ESTADO_VALIDADO,
    PROG_PENDIENTE,
)
from app.matriculas.models import Matricula
from app.pagos.models import Pago, ESTADO_PAGO_PENDIENTE, ESTADO_PAGO_VALIDADO, ESTADO_PAGO_RECHAZADO, ESTADO_PAGO_PENDIENTE_VALIDACION

# Importar estados adicionales
from app.cursos.models import ESTADO_PENDIENTE_VALIDACION, ESTADO_RECHAZADO


# -------------------------------------------------------------
# üîê Funciones de permiso
# -------------------------------------------------------------
def tiene_permiso_validacion():
    """Verifica si el usuario tiene permisos para validar pagos/cursos (Administrador o Administrativo)."""
    return any(role.nombre in ['Administrador', 'Administrativo'] for role in current_user.roles)

def es_admin():
    return any(r.nombre == "Administrador" for r in current_user.roles)

def es_supervisor():
    return any(r.nombre == "Supervisor" for r in current_user.roles)


# -------------------------------------------------------------
# üß≠ PANEL CENTRAL DE VALIDACIONES
# -------------------------------------------------------------
@bp.route("/", endpoint="index")
@login_required
def index():
    """
    Panel central de validaciones del sistema.
    Muestra cursos pendientes y pagos pendientes de validaci√≥n.
    """
    if not (es_admin() or es_supervisor()):
        flash("No tienes permisos para acceder a esta secci√≥n.", "danger")
        return redirect(url_for("core.dashboard"))

    # --- CURSOS ---
    cursos_pend_creacion = (
        Curso.query.filter(Curso.estado == ESTADO_BORRADOR)
        .order_by(Curso.created_at.desc())
        .all()
    )

    cursos_pend_prog = (
        Curso.query.filter(Curso.estado == ESTADO_VALIDADO)
        .join(Programacion, isouter=True)
        .filter(
            (Programacion.id.isnot(None))
            & (Programacion.estado_programacion == PROG_PENDIENTE)
        )
        .order_by(Curso.created_at.desc())
        .all()
    )

    # Incluimos BORRADOR y PENDIENTE_VALIDACION como "pendientes" para revisi√≥n por Supervisor/Admin
    cursos_pendientes = Curso.query.filter(
        Curso.estado.in_([ESTADO_PENDIENTE_VALIDACION, ESTADO_BORRADOR])
    ).order_by(Curso.created_at.desc()).all()

    cursos_rechazados = Curso.query.filter_by(estado=ESTADO_RECHAZADO).all()

    # --- PAGOS PENDIENTES DE VALIDACI√ìN ---
    if tiene_permiso_validacion():
        pagos_pendientes = Pago.query.filter_by(estado=ESTADO_PAGO_PENDIENTE_VALIDACION).all()

        # Filtrar pagos vencidos que no est√°n procesados
        pagos_vencidos = []
        all_pagos = Pago.query.all()
        for pago in all_pagos:
            if pago.esta_vencido() and pago.estado not in [ESTADO_PAGO_VALIDADO, ESTADO_PAGO_RECHAZADO, ESTADO_PAGO_PENDIENTE_VALIDACION]:
                pagos_vencidos.append(pago)
    else:
        pagos_pendientes = []
        pagos_vencidos = []

    # --- RENDERIZAR ---
    return render_template(
        "validaciones/index.html",
        cursos_pend_creacion=cursos_pend_creacion,
        cursos_pend_prog=cursos_pend_prog,
        total_cursos_pend_creacion=len(cursos_pend_creacion),
        total_cursos_pend_prog=len(cursos_pend_prog),
        total_cursos_rechazados=len(cursos_rechazados),
        pagos_pendientes=pagos_pendientes,
        pagos_vencidos=pagos_vencidos,
        hoy=date.today(),
        cursos_pendientes=cursos_pendientes,
        cursos_rechazados=cursos_rechazados
    )


# -------------------------------------------------------------
# ‚úÖ VALIDAR PAGO
# -------------------------------------------------------------
@bp.route("/validar_pago/<int:pago_id>", methods=["POST"], endpoint="validar_pago")
@login_required
def validar_pago(pago_id):
    if not tiene_permiso_validacion():
        flash("No tiene permisos para validar pagos.", "danger")
        return redirect(url_for("core.dashboard"))
    
    pago = Pago.query.get_or_404(pago_id)
    
    if pago.estado != ESTADO_PAGO_PENDIENTE_VALIDACION:
        flash("Este pago no est√° pendiente de validaci√≥n.", "warning")
        return redirect(url_for("validaciones.index"))
    
    pago.estado = ESTADO_PAGO_VALIDADO
    db.session.commit()
    
    # üîÑ REDISTRIBUIR CUOTAS PENDIENTES DESPU√âS DE VALIDAR
    redistribuir_cuotas_pendientes(pago.matricula)
    
    flash("Pago validado correctamente y cuotas redistribuidas.", "success")
    return redirect(url_for("validaciones.index"))


# -------------------------------------------------------------
# ‚ùå RECHAZAR PAGO
# -------------------------------------------------------------
@bp.route("/rechazar_pago/<int:pago_id>", methods=["POST"], endpoint="rechazar_pago")
@login_required
def rechazar_pago(pago_id):
    if not tiene_permiso_validacion():
        flash("No tiene permisos para rechazar pagos.", "danger")
        return redirect(url_for("core.dashboard"))
    
    pago = Pago.query.get_or_404(pago_id)
    motivo = request.form.get('motivo', '').strip()
    
    if not motivo:
        flash("Debe proporcionar un motivo para el rechazo.", "danger")
        return redirect(url_for("validaciones.index"))
    
    if pago.estado != ESTADO_PAGO_PENDIENTE_VALIDACION:
        flash("Este pago no est√° pendiente de validaci√≥n.", "warning")
        return redirect(url_for("validaciones.index"))
    
    pago.estado = ESTADO_PAGO_RECHAZADO
    pago.motivo_rechazo = motivo
    db.session.commit()
    
    flash("Pago rechazado correctamente.", "warning")
    return redirect(url_for("validaciones.index"))


# -------------------------------------------------------------
# ‚úÖ VALIDAR CURSO (nuevo endpoint)
# -------------------------------------------------------------
@bp.route("/validar_curso/<int:curso_id>", methods=["POST"], endpoint="validar_curso")
@login_required
def validar_curso(curso_id):
    """Valida un curso (cambia su estado a VALIDADO)."""
    if not (es_admin() or es_supervisor()):
        flash("No tienes permisos para validar cursos.", "danger")
        return redirect(url_for("core.dashboard"))

    curso = Curso.query.get_or_404(curso_id)

    # Solo permitir validar si est√° en BORRADOR o PENDIENTE_VALIDACION
    if curso.estado not in (ESTADO_BORRADOR, ESTADO_PENDIENTE_VALIDACION):
        flash("El curso no est√° en un estado que permita validaci√≥n.", "warning")
        return redirect(url_for("validaciones.index"))

    curso.estado = ESTADO_VALIDADO
    # Si existiera un objeto Programacion pendiente, no lo tocamos aqu√≠
    db.session.commit()

    flash("Curso validado correctamente.", "success")
    return redirect(url_for("validaciones.index"))


# -------------------------------------------------------------
# ‚ùå RECHAZAR CURSO (nuevo endpoint)
# -------------------------------------------------------------
@bp.route("/rechazar_curso/<int:curso_id>", methods=["POST"], endpoint="rechazar_curso")
@login_required
def rechazar_curso(curso_id):
    """Rechaza un curso y guarda una observaci√≥n si se proporciona."""
    if not (es_admin() or es_supervisor()):
        flash("No tienes permisos para rechazar cursos.", "danger")
        return redirect(url_for("core.dashboard"))

    curso = Curso.query.get_or_404(curso_id)
    observacion = request.form.get("observacion", "") or request.form.get("motivo", "")
    observacion = observacion.strip()

    # Cambiar estado
    curso.estado = ESTADO_RECHAZADO

    # Intentamos guardar la observaci√≥n en un campo existente si existe.
    # Si el modelo no tiene ese atributo, lo a√±adimos a la instancia (no persistir√°).
    try:
        # Preferimos campos llamados 'observacion_rechazo' o 'motivo_rechazo' si existen en el modelo.
        if hasattr(curso, "observacion_rechazo"):
            setattr(curso, "observacion_rechazo", observacion)
        elif hasattr(curso, "motivo_rechazo"):
            setattr(curso, "motivo_rechazo", observacion)
        else:
            # Guardamos din√°micamente en la instancia (no persistente)
            curso.observacion_rechazo = observacion
    except Exception:
        curso.observacion_rechazo = observacion

    db.session.commit()
    flash("Curso rechazado correctamente.", "warning")
    return redirect(url_for("validaciones.index"))


# -------------------------------------------------------------
# üìã DETALLE DE PAGOS (Mantenida para compatibilidad)
# -------------------------------------------------------------
@bp.route("/pagos/<int:matricula_id>", methods=["GET", "POST"], endpoint="validaciones_pagos_detalle")
@login_required
def validaciones_pagos_detalle(matricula_id):
    """Vista de detalle para validar o rechazar pagos de un estudiante"""
    if not (es_admin() or es_supervisor()):
        abort(403)

    matricula = Matricula.query.get_or_404(matricula_id)
    pagos = Pago.query.filter_by(matricula_id=matricula.id).order_by(Pago.numero_cuota).all()

    if request.method == "POST":
        accion = request.form.get("accion")
        pago_id = request.form.get("pago_id")
        pago = Pago.query.get(pago_id)
        if not pago:
            flash("No se encontr√≥ el pago especificado.", "danger")
            return redirect(url_for("validaciones.validaciones_pagos_detalle", matricula_id=matricula.id))

        try:
            if accion == "validar":
                pago.estado = ESTADO_PAGO_VALIDADO
                db.session.commit()

                # üîÑ Redistribuir deuda autom√°ticamente
                pagos_restantes = Pago.query.filter(
                    Pago.matricula_id == matricula.id,
                    Pago.estado != ESTADO_PAGO_VALIDADO
                ).all()
                total_restante = sum(p.monto for p in pagos_restantes)
                n_restantes = len(pagos_restantes)
                nueva_cuota = round(total_restante / n_restantes, 2) if n_restantes else 0
                for p in pagos_restantes:
                    p.monto = nueva_cuota
                db.session.commit()

                flash("‚úÖ Pago validado correctamente.", "success")
                return redirect(url_for("validaciones.validaciones_pagos_detalle", matricula_id=matricula.id))

            elif accion == "rechazar":
                pago.estado = ESTADO_PAGO_RECHAZADO
                db.session.commit()
                flash("‚ùå Pago rechazado correctamente.", "danger")
                return redirect(url_for("validaciones.validaciones_pagos_detalle", matricula_id=matricula.id))

            else:
                flash("‚ö†Ô∏è No se reconoci√≥ la acci√≥n enviada.", "warning")

        except Exception:
            db.session.rollback()
            flash("‚ùå Error al procesar la acci√≥n. Int√©ntalo de nuevo.", "danger")

    return render_template("validaciones/pagos/detalle.html", matricula=matricula, pagos=pagos)


================================================================================
üìÅ Archivo: .\app\validaciones\__init__.py
================================================================================

from flask import Blueprint

bp = Blueprint("validaciones", __name__, template_folder="templates")

from . import routes



================================================================================
üìÅ Archivo: .\app\validaciones\templates\validaciones\cursos.html
================================================================================

{% extends "base.html" %}
{% block title %}Validaci√≥n de Cursos{% endblock %}

{% block content %}
<div class="container mt-4 fade-in">
  <h2 class="text-success mb-4"><i class="fas fa-graduation-cap me-2"></i>Validaci√≥n de Cursos</h2>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <strong>Cursos Pendientes de Validaci√≥n</strong>
    </div>
    <div class="card-body p-0">
      <table class="table table-hover table-striped mb-0 align-middle">
        <thead class="table-success">
          <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Duraci√≥n (h)</th>
            <th>Horas Semanales</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cursos if c.estado == 'PENDIENTE_VALIDACION' %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ c.nombre }}</td>
            <td>{{ c.tipo }}</td>
            <td>{{ c.duracion_horas }}</td>
            <td>{{ c.horas_semanales }}</td>
            <td><span class="badge bg-warning text-dark">{{ c.estado }}</span></td>
            <td>
              <form method="post" action="{{ url_for('validaciones.validar_curso', id=c.id) }}" class="d-inline">
                <button class="btn btn-success btn-sm"><i class="fas fa-check"></i> Validar</button>
              </form>
              <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rechazoModal{{ c.id }}"><i class="fas fa-times"></i> Rechazar</button>

              <!-- Modal Rechazo -->
              <div class="modal fade" id="rechazoModal{{ c.id }}" tabindex="-1">
                <div class="modal-dialog">
                  <form method="post" action="{{ url_for('validaciones.rechazar_curso', id=c.id) }}">
                    <div class="modal-content">
                      <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Rechazar Curso</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="form-group">
                          <label>Motivo del rechazo</label>
                          <textarea class="form-control" name="observacion" rows="3" required></textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Confirmar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-center text-muted">No hay cursos pendientes</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-danger text-white">
      <strong>Cursos Rechazados</strong>
    </div>
    <div class="card-body p-0">
      <table class="table table-hover table-striped mb-0 align-middle">
        <thead class="table-danger">
          <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Duraci√≥n (h)</th>
            <th>Observaci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cursos if c.estado == 'RECHAZADO' %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ c.nombre }}</td>
            <td>{{ c.tipo }}</td>
            <td>{{ c.duracion_horas }}</td>
            <td>{{ c.observacion_rechazo or '‚Äî' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center text-muted">No hay cursos rechazados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}



================================================================================
üìÅ Archivo: .\app\validaciones\templates\validaciones\index.html
================================================================================

{% extends "base.html" %}
{% block title %}Validaciones ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-check-double me-2"></i>M√≥dulo de Validaciones</h4>
    </div>

    <div class="card-body">
      <!-- Pagos Pendientes de Validaci√≥n -->
      <h5 class="fw-bold text-primary mb-3"><i class="fas fa-clock me-2"></i>Pagos Pendientes de Validaci√≥n</h5>
      {% if pagos_pendientes %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-warning">
              <tr>
                <th>Tipo</th>
                <th>Estudiante</th>
                <th>Curso</th>
                <th># Cuota</th>
                <th>Monto</th>
                <th>Fecha Pago</th>
                <th>Comprobante</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pago in pagos_pendientes %}
                <tr>
                  <td>
                    {# Distinguir pago inicial vs cuota: preferimos numero_cuota==0 o campo es_pago_inicial #}
                    {% if (pago.numero_cuota is defined and pago.numero_cuota == 0) or (pago.es_pago_inicial is defined and pago.es_pago_inicial) %}
                      <span class="badge bg-info text-dark">Pago inicial</span>
                    {% elif pago.origen is defined and pago.origen == 'MATRICULA' %}
                      <span class="badge bg-info text-dark">Pago inicial</span>
                    {% else %}
                      <span class="badge bg-secondary">Pago de cuota</span>
                    {% endif %}
                  </td>

                  <td>{{ pago.matricula.estudiante_nombre if pago.matricula else '‚Äî' }}</td>
                  <td>{{ pago.matricula.curso.nombre if pago.matricula and pago.matricula.curso else '‚Äî' }}</td>
                  <td>{{ pago.numero_cuota if pago.numero_cuota is defined else '‚Äî' }}</td>
                  <td>{{ "%.2f"|format(pago.monto or 0) }}</td>
                  <td>{{ pago.fecha_pago.strftime('%d/%m/%Y') if pago.fecha_pago else '‚Äî' }}</td>

                  {# ---------- Comprobante (columna nueva) ---------- #}
                  <td>
                    {# Buscamos comprobante en varias fuentes, prioridad:
                       1) campos directos en Pago (documento_id/comprobante_id/documento_path)
                       2) documento tipo 'factura_primer_pago' vinculado a la matr√≠cula
                       3) √∫ltimo documento de la matr√≠cula si no hay factura espec√≠fica
                    #}
                    {% set comprobante = None %}

                    {# 1) comprobante directo en pago (varios nombres posibles) #}
                    {% if pago is defined %}
                      {% if pago.documento_id is defined and pago.documento_id %}
                        {% set comprobante = {'id': pago.documento_id} %}
                      {% elif pago.comprobante_id is defined and pago.comprobante_id %}
                        {% set comprobante = {'id': pago.comprobante_id} %}
                      {% elif pago.documento_path is defined and pago.documento_path %}
                        {# si solo hay path/filename (poco com√∫n), devolvemos info m√≠nima #}
                        {% set comprobante = {'path': pago.documento_path, 'filename': pago.filename if pago.filename is defined else None} %}
                      {% endif %}
                    {% endif %}

                    {# 2) si no hay comprobante directo, buscar en la matr√≠cula asociada #}
                    {% if not comprobante and pago.matricula is defined %}
                      {% set docs = (pago.matricula.documentos|list) if pago.matricula.documentos is defined else [] %}
                      {% set factura_docs = docs | selectattr('tipo','equalto','factura_primer_pago') | list %}
                      {% if factura_docs and factura_docs|length > 0 %}
                        {% set doc = factura_docs[-1] %}
                        {% set comprobante = {'id': doc.id, 'path': doc.path, 'filename': doc.filename} %}
                      {% elif docs and docs|length > 0 %}
                        {% set doc = docs[-1] %}
                        {% set comprobante = {'id': doc.id, 'path': doc.path, 'filename': doc.filename} %}
                      {% endif %}
                    {% endif %}

                    {# Renderizar bot√≥n de descarga si hay comprobante identificado #}
                    {% if comprobante %}
                      {% if comprobante.id %}
                        <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=pago.matricula.id, documento_id=comprobante.id) }}" class="btn btn-sm btn-outline-primary" target="_blank" title="Descargar comprobante">
                          <i class="fas fa-download me-1"></i> Descargar
                        </a>
                        {% if comprobante.filename %}
                          <div class="small text-muted mt-1">{{ comprobante.filename }}</div>
                        {% endif %}
                      {% elif comprobante.path %}
                        {# No tenemos id (caso raro) ‚Äî redirigir al detalle del pago para permitir descarga all√≠ #}
                        <a href="{{ url_for('pagos.detalles_pago', pago_id=pago.id) }}" class="btn btn-sm btn-outline-secondary" title="Ver comprobante en detalle">
                          <i class="fas fa-file-medical-alt me-1"></i> Ver comprobante
                        </a>
                        {% if comprobante.filename %}
                          <div class="small text-muted mt-1">{{ comprobante.filename }}</div>
                        {% endif %}
                      {% else %}
                        <span class="text-muted small">No accesible</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted small">Sin comprobante</span>
                    {% endif %}
                  </td>

                  {# ---------- Acciones ---------- #}
                  <td>
                    <div class="btn-group btn-group-sm">
                      <!-- Formulario para Validar Pago -->
                      <form method="POST" action="{{ url_for('validaciones.validar_pago', pago_id=pago.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success" onclick="return confirm('¬øValidar este pago?')">
                          <i class="fas fa-check"></i> Validar
                        </button>
                      </form>

                      <!-- Bot√≥n para Rechazar Pago (abre modal) -->
                      <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRechazarPago{{ pago.id }}">
                        <i class="fas fa-times"></i> Rechazar
                      </button>

                      <!-- Ver detalle del pago -->
                      <a href="{{ url_for('pagos.detalles_pago', pago_id=pago.id) }}" class="btn btn-info">
                        <i class="fas fa-eye"></i> Ver
                      </a>
                    </div>

                    <!-- Modal para Rechazar Pago -->
                    <div class="modal fade" id="modalRechazarPago{{ pago.id }}" tabindex="-1">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Rechazar Pago</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <form method="POST" action="{{ url_for('validaciones.rechazar_pago', pago_id=pago.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="modal-body">
                              <p><strong>Estudiante:</strong> {{ pago.matricula.estudiante_nombre if pago.matricula else '‚Äî' }}</p>
                              <p><strong>Cuota:</strong> {{ pago.numero_cuota if pago.numero_cuota is defined else '‚Äî' }} - {{ "%.2f"|format(pago.monto or 0) }} </p>
                              <div class="mb-3">
                                <label class="form-label fw-bold">Motivo del Rechazo</label>
                                <textarea class="form-control" name="motivo" rows="3" required placeholder="Explique el motivo del rechazo..."></textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-danger">Rechazar Pago</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No hay pagos pendientes de validaci√≥n.</div>
      {% endif %}

      <!-- Pagos Vencidos -->
      <h5 class="fw-bold text-danger mt-5 mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Pagos Fuera de Plazo</h5>
      {% if pagos_vencidos %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-danger">
              <tr>
                <th>Estudiante</th>
                <th>Curso</th>
                <th># Cuota</th>
                <th>Monto (XAF)</th>
                <th>Vencimiento</th>
                <th>D√≠as de Retraso</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pago in pagos_vencidos %}
                <tr>
                  <td>{{ pago.matricula.estudiante_nombre }}</td>
                  <td>{{ pago.matricula.curso.nombre }}</td>
                  <td>{{ pago.numero_cuota }}</td>
                  <td>{{ "%.2f"|format(pago.monto) }}</td>
                  <td>{{ pago.fecha_vencimiento.strftime('%d/%m/%Y') if pago.fecha_vencimiento else 'N/A' }}</td>
                  <td>
                    {% if pago.fecha_vencimiento %}
                      {% set dias_retraso = (hoy - pago.fecha_vencimiento).days %}
                      <span class="badge bg-danger">{{ dias_retraso }} d√≠as</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('pagos.detalles_pago', pago_id=pago.id) }}" class="btn btn-sm btn-outline-info">
                      <i class="fas fa-eye"></i> Ver
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-success">No hay pagos fuera de plazo.</div>
      {% endif %}

      <!-- Cursos Pendientes de Validaci√≥n -->
      <h5 class="fw-bold text-success mt-5 mb-3"><i class="fas fa-graduation-cap me-2"></i>Cursos Pendientes de Validaci√≥n</h5>
      {% if cursos_pendientes %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-success">
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Creado por</th>
                <th>Tipo</th>
                <th>Duraci√≥n (h)</th>
                <th>Horas Semanales</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for curso in cursos_pendientes %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ curso.nombre }}</td>
                  <td>
                    {% if curso.created_by %}
                      {{ curso.created_by.full_name or curso.created_by.username }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>
                  <td>{{ curso.tipo }}</td>
                  <td>{{ curso.duracion_horas if curso.duracion_horas is defined else curso.horas_totales }}</td>
                  <td>{{ curso.horas_semanales if curso.horas_semanales is defined else curso.horas_semanales }}</td>
                  <td><span class="badge bg-warning text-dark">{{ curso.estado }}</span></td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <form method="POST" action="{{ url_for('validaciones.validar_curso', curso_id=curso.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success" onclick="return confirm('¬øValidar este curso?')">
                          <i class="fas fa-check"></i> Validar
                        </button>
                      </form>
                      <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRechazarCurso{{ curso.id }}">
                        <i class="fas fa-times"></i> Rechazar
                      </button>
                      <a href="{{ url_for('cursos.detalle', curso_id=curso.id) }}" class="btn btn-info">
                        <i class="fas fa-eye"></i> Ver
                      </a>
                    </div>

                    <!-- Modal para Rechazar Curso -->
                    <div class="modal fade" id="modalRechazarCurso{{ curso.id }}" tabindex="-1">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Rechazar Curso</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <form method="POST" action="{{ url_for('validaciones.rechazar_curso', curso_id=curso.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="modal-body">
                              <p><strong>Curso:</strong> {{ curso.nombre }}</p>
                              <p><strong>Tipo:</strong> {{ curso.tipo }}</p>

                              <div class="mb-3">
                                <label class="form-label fw-bold">Motivo del Rechazo</label>
                                <textarea class="form-control" name="observacion" rows="3" required placeholder="Explique el motivo del rechazo del curso..."></textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-danger">Rechazar Curso</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No hay cursos pendientes de validaci√≥n.</div>
      {% endif %}

      <!-- Cursos Rechazados -->
      <h5 class="fw-bold text-danger mt-5 mb-3"><i class="fas fa-ban me-2"></i>Cursos Rechazados</h5>
      {% if cursos_rechazados %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-danger">
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Duraci√≥n (h)</th>
                <th>Observaci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for curso in cursos_rechazados %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ curso.nombre }}</td>
                  <td>{{ curso.tipo }}</td>
                  <td>{{ curso.duracion_horas if curso.duracion_horas is defined else curso.horas_totales }}</td>
                  <td>{{ curso.observacion_rechazo or curso.motivo_rechazo or '‚Äî' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-success">No hay cursos rechazados.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\validaciones\templates\validaciones\matriculas\detalle.html
================================================================================

{% extends "base.html" %}
{% block title %}Validar Matr√≠cula ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-user-check me-2"></i>Validar Matr√≠cula</h4>
        </div>

        <div class="card-body">
            <!-- Informaci√≥n de la matr√≠cula -->
            <h5 class="fw-bold text-success">{{ matricula.estudiante_nombre }}</h5>
            <p class="text-muted">{{ matricula.curso.nombre }}</p>

            <div class="row mb-4">
                <div class="col-md-6">
                    <p><strong>Documento:</strong> {{ matricula.doc_identidad or '-' }}</p>
                    <p><strong>Tel√©fono:</strong> {{ matricula.telefono or '-' }}</p>
                    <p><strong>Email:</strong> {{ matricula.email or '-' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Campus:</strong> {{ matricula.campus }}</p>
                    <p><strong>Coste Total:</strong> {{ matricula.coste_total }} XAF</p>
                    <p><strong>Estado Actual:</strong> 
                        <span class="badge bg-warning text-dark">Pendiente de Validaci√≥n</span>
                    </p>
                </div>
            </div>

            <!-- Documentos -->
            <h6 class="fw-bold text-primary mb-3">
                <i class="fas fa-file-alt me-2"></i>Documentos Adjuntos
            </h6>
            <div class="row mb-4">
                {% for doc in matricula.documentos %}
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center border p-2 rounded">
                        <span>
                            <i class="fas fa-file-pdf text-danger me-2"></i>
                            {{ doc.tipo|replace("_", " ")|title }}
                        </span>
                        <a href="{{ url_for('static', filename=doc.path.replace('static/', '')) }}" 
                           target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <p class="text-muted">No hay documentos adjuntos.</p>
                </div>
                {% endfor %}
            </div>

            <!-- üî• FORMULARIOS MEJORADOS - SOLUCI√ìN DEFINITIVA -->
            <div class="border-top pt-4 mt-4">
                <h6 class="fw-bold text-success mb-3">
                    <i class="fas fa-tasks me-2"></i>Acciones de Validaci√≥n
                </h6>
                
                <div class="row">
                    <!-- FORMULARIO DE VALIDACI√ìN -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Validar Matr√≠cula</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">¬øLa documentaci√≥n es correcta y completa?</p>
                                <form method="POST" id="form-validar">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="d-grid">
                                        <button type="submit" name="validar_matricula" value="1" 
                                                class="btn btn-success"
                                                onclick="return confirm('¬øConfirmar VALIDACI√ìN de esta matr√≠cula? Esta acci√≥n no se puede deshacer.')">
                                            <i class="fas fa-check-circle me-2"></i> Validar Matr√≠cula
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- FORMULARIO DE RECHAZO -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>Rechazar Matr√≠cula</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">¬øHay problemas con la documentaci√≥n?</p>
                                <form method="POST" id="form-rechazar">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-danger">
                                            Motivo del rechazo <small class="text-muted">(requerido)</small>
                                        </label>
                                        <textarea name="motivo_rechazo" class="form-control" rows="3" 
                                                  placeholder="Describa detalladamente los motivos del rechazo..."
                                                  required minlength="5"></textarea>
                                        <div class="form-text">M√≠nimo 5 caracteres. Este motivo se registrar√° en el sistema.</div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" name="rechazar_matricula" value="1" 
                                                class="btn btn-danger"
                                                onclick="return confirm('¬øConfirmar RECHAZO de esta matr√≠cula? Esta acci√≥n no se puede deshacer.')">
                                            <i class="fas fa-times-circle me-2"></i> Rechazar Matr√≠cula
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n de volver -->
            <div class="text-center mt-4">
                <a href="{{ url_for('validaciones.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Volver al Panel de Validaciones
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Script para mejoras de UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validaci√≥n del formulario de rechazo
    const formRechazar = document.getElementById('form-rechazar');
    if (formRechazar) {
        formRechazar.addEventListener('submit', function(e) {
            const motivo = this.querySelector('textarea[name="motivo_rechazo"]');
            if (motivo && motivo.value.trim().length < 5) {
                e.preventDefault();
                alert('‚ö†Ô∏è Debe ingresar un motivo de rechazo de al menos 5 caracteres.');
                motivo.focus();
            }
        });
    }
    
    // Mostrar loading al enviar formularios
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
            }
        });
    });
});
</script>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\validaciones\templates\validaciones\matriculas\validar.html
================================================================================

{% extends "base.html" %}
{% block title %}{{ title }} ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-check-double me-2"></i>{{ title }}</h4>
            <span class="badge bg-dark fs-6">{{ pendientes|length }} pendientes</span>
        </div>

        <div class="card-body">
            {% if pendientes %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-warning">
                        <tr>
                            <th>#</th>
                            <th>Estudiante</th>
                            <th>Curso</th>
                            <th>Campus</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for matricula in pendientes %}
                        <tr>
                            <td>{{ matricula.id }}</td>
                            <td>
                                <strong>{{ matricula.estudiante_nombre }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ matricula.doc_identidad or 'Sin documento' }}
                                    {% if matricula.email %}
                                    <br>{{ matricula.email }}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                {{ matricula.curso.nombre }}
                                {% if matricula.tipo_fp_anho %}
                                <br>
                                <span class="badge bg-info">
                                    {{ '1¬∫ A√±o' if matricula.tipo_fp_anho == 'PRIMER_ANO' else '2¬∫ A√±o' }}
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ matricula.campus }}</span>
                            </td>
                            <td>{{ matricula.created_at.strftime('%d/%m/%Y') }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('validaciones.validaciones_matriculas_detalle', matricula_id=matricula.id) }}" 
                                       class="btn btn-outline-primary">
                                        <i class="fas fa-search me-1"></i> Revisar
                                    </a>
                                    <a href="{{ url_for('matriculas.descargar_documentos', matricula_id=matricula.id) }}" 
                                       class="btn btn-outline-success">
                                        <i class="fas fa-download me-1"></i> Docs
                                    </a>
                                    <a href="{{ url_for('matriculas.detalle', matricula_id=matricula.id) }}" 
                                       class="btn btn-outline-info">
                                        <i class="fas fa-eye me-1"></i> Ver
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">¬°No hay matr√≠culas pendientes de validaci√≥n!</h5>
                <p class="text-muted">Todas las matr√≠culas han sido procesadas.</p>
                <a href="{{ url_for('core.dashboard') }}" class="btn btn-success">
                    <i class="fas fa-arrow-left me-1"></i> Volver al Dashboard
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\validaciones\templates\validaciones\pagos\detalles.html
================================================================================

{% extends "base.html" %}
{% block title %}Validar Pagos ‚Äî BBS{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-check-double me-2"></i>Validar Pagos - {{ matricula.estudiante_nombre }}</h4>
      <a href="{{ url_for('validaciones.index') }}" class="btn btn-outline-dark btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>

    <div class="card-body">
      <h5 class="fw-bold text-success">{{ matricula.curso.nombre }} | {{ matricula.campus }}</h5>
      
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead class="table-warning">
            <tr>
              <th># Cuota</th>
              <th>Monto (XAF)</th>
              <th>Vencimiento</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for pago in pagos %}
              {% if pago.estado == 'PENDIENTE_VALIDACION' %}
              <tr>
                <td>{{ pago.numero_cuota }}</td>
                <td>{{ "%.2f"|format(pago.monto) }}</td>
                <td>{{ pago.fecha_vencimiento.strftime('%d/%m/%Y') if pago.fecha_vencimiento else 'N/A' }}</td>
                <td>
                  <span class="badge bg-secondary">Pendiente de Validaci√≥n</span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <!-- Formulario para Validar -->
                    <form method="POST" action="{{ url_for('validaciones.validar_pago', pago_id=pago.id) }}" class="d-inline">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button type="submit" class="btn btn-success" name="accion" value="validar">
                        <i class="fas fa-check"></i> Validar
                      </button>
                    </form>
                    
                    <!-- Bot√≥n para Rechazar -->
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRechazar{{ pago.id }}">
                      <i class="fas fa-times"></i> Rechazar
                    </button>
                  </div>

                  <!-- Modal para Rechazar -->
                  <div class="modal fade" id="modalRechazar{{ pago.id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                          <h5 class="modal-title">Rechazar Pago</h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="POST" action="{{ url_for('validaciones.rechazar_pago', pago_id=pago.id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                          <div class="modal-body">
                            <p><strong>Cuota:</strong> {{ pago.numero_cuota }} - {{ "%.2f"|format(pago.monto) }} XAF</p>
                            
                            <div class="mb-3">
                              <label class="form-label fw-bold">Motivo del Rechazo</label>
                              <textarea class="form-control" name="motivo" rows="3" required placeholder="Explique el motivo del rechazo..."></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger">Rechazar Pago</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted">No hay pagos pendientes de validaci√≥n</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}


================================================================================
üìÅ Archivo: .\app\validaciones\templates\validaciones\pagos\lista.html
================================================================================




================================================================================
üìÅ Archivo: .\migrations\env.py
================================================================================

import logging
from logging.config import fileConfig

from flask import current_app

from alembic import context

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
fileConfig(config.config_file_name)
logger = logging.getLogger('alembic.env')


def get_engine():
    try:
        # this works with Flask-SQLAlchemy<3 and Alchemical
        return current_app.extensions['migrate'].db.get_engine()
    except (TypeError, AttributeError):
        # this works with Flask-SQLAlchemy>=3
        return current_app.extensions['migrate'].db.engine


def get_engine_url():
    try:
        return get_engine().url.render_as_string(hide_password=False).replace(
            '%', '%%')
    except AttributeError:
        return str(get_engine().url).replace('%', '%%')


# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
config.set_main_option('sqlalchemy.url', get_engine_url())
target_db = current_app.extensions['migrate'].db

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def get_metadata():
    if hasattr(target_db, 'metadatas'):
        return target_db.metadatas[None]
    return target_db.metadata


def run_migrations_offline():
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=get_metadata(), literal_binds=True
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online():
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """

    # this callback is used to prevent an auto-migration from being generated
    # when there are no changes to the schema
    # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
    def process_revision_directives(context, revision, directives):
        if getattr(config.cmd_opts, 'autogenerate', False):
            script = directives[0]
            if script.upgrade_ops.is_empty():
                directives[:] = []
                logger.info('No changes in schema detected.')

    conf_args = current_app.extensions['migrate'].configure_args
    if conf_args.get("process_revision_directives") is None:
        conf_args["process_revision_directives"] = process_revision_directives

    connectable = get_engine()

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=get_metadata(),
            **conf_args
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()



================================================================================
üìÅ Archivo: .\migrations\versions\3aa3ee4ad497_estructura_inicial_con_campos_nuevos.py
================================================================================

"""Estructura inicial con campos nuevos

Revision ID: 3aa3ee4ad497
Revises: 
Create Date: 2025-10-28 04:34:28.136092

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '3aa3ee4ad497'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('matriculas', schema=None) as batch_op:
        batch_op.add_column(sa.Column('monto_inicial', sa.Float(), nullable=False))

    with op.batch_alter_table('pagos', schema=None) as batch_op:
        batch_op.add_column(sa.Column('es_pago_inicial', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('monto_inicial', sa.Float(), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('pagos', schema=None) as batch_op:
        batch_op.drop_column('monto_inicial')
        batch_op.drop_column('es_pago_inicial')

    with op.batch_alter_table('matriculas', schema=None) as batch_op:
        batch_op.drop_column('monto_inicial')

    # ### end Alembic commands ###



=== FIN DE EXPORTACI√ìN ===
